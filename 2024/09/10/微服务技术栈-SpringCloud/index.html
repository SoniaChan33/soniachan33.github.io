<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>微服务技术栈 | Sonia33</title><meta name="keywords" content="Sentinel,Nacos,OpenFeign"><meta name="author" content="SoniaChen"><meta name="copyright" content="SoniaChen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="微服务技术栈"><meta name="application-name" content="微服务技术栈"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="微服务技术栈"><meta property="og:url" content="https://blog.soniachen.com/2024/09/10/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-SpringCloud/index.html"><meta property="og:site_name" content="Sonia33"><meta property="og:description" content="一、微服务架构介绍 1.1 架构演变  单体架构： All in One，所有的功能模块都在一个工程里。  SOA架构： 这个架构当不当正不正，对于现在来说，有点老，甚至需要ESB，WebService之类的，基本不会使用了。 微服务架构：  微服务架构思想是马丁福勒提出的 https:&amp;#x2F;&amp;#x2F;mart"><meta property="og:locale" content="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><meta property="og:image" content="https://img.soniachen.com/IMG_5493.jpg?_r_=1e00c770-98e4-1b33-6d57-241b89e1c2b1"><meta property="article:author" content="SoniaChen"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.soniachen.com/IMG_5493.jpg?_r_=1e00c770-98e4-1b33-6d57-241b89e1c2b1"><meta name="description" content="一、微服务架构介绍 1.1 架构演变  单体架构： All in One，所有的功能模块都在一个工程里。  SOA架构： 这个架构当不当正不正，对于现在来说，有点老，甚至需要ESB，WebService之类的，基本不会使用了。 微服务架构：  微服务架构思想是马丁福勒提出的 https:&amp;#x2F;&amp;#x2F;mart"><link rel="shortcut icon" href="https://img.soniachen.com/%E9%92%A2%E9%93%81%E8%9C%98%E8%9B%9B%E4%BE%A0.png"><link rel="canonical" href="https://blog.soniachen.com/2024/09/10/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-SpringCloud/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"/><link rel="mask-icon" href="/img/siteicon/apple-icon-180.png" color="#5bbad5"/><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-icon-180.png"/><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/apple-icon-180.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"/><link rel="bookmark" href="/img/siteicon/apple-icon-180.png"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"sonia33","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: undefined,
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo-cloudflare.soniachan0831.workers.dev',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","📖 读万卷书","🧗 徒步爱好者","🏀 篮球狂热爱好者","🚴 公路车爱好者","🏃 跑步爱好者"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: SoniaChen","link":"链接: ","source":"来源: Sonia33","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"bottom-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Sonia33',
  title: '微服务技术栈',
  postAI: '',
  pageFillDescription: '一、微服务架构介绍, 1.1 架构演变, 1.2 SpringCloud生态, 二、Nacos注册中心, 2.1 注册中心, 2.2 Nacos安装, 2.3 Nacos初体验（注册中心）, 2.3.1 构建父工程并管理版本, 2.3.2 准备库存服务, 2.3.3 准备订单服务, 2.3.4 库存服务提供接口, 2.3.5 订单服务准备接口访问库存服务, 2.4 命名空间和分组（了解）, 2.5 负载均衡（了解）, 三、Nacos配置中心, 3.1 配置中心, 3.2 Nacos初体验（配置中心）, 3.3 命名空间和分组（了解）, 3.4 配置动态刷新, 四、OpenFeign, 4.1 OpenFeign介绍, 4.2 OpenFeign的初体验, 4.3 OpenFeign配置, 4.3.1 OpenFeign的超时配置, 4.3.2 OpenFeign的底层技术, 五、Sentinel, 5.1 Sentinel介绍, 5.2 Sentinel安装, 5.3 Sentinel初体验, 5.4 流控规则, 5.4.1 QPS限制, 5.4.1.1 直接-快速失败, 5.4.1.2 直接-WarmUp, 5.4.1.3 直接-排队等待, 5.4.1.4 关联-快速失败, 5.4.1.5 链路-快速失败, 5.4.2 并发线程数, 5.5 熔断降级, 5.5.1 熔断降级介绍, 5.5.2 熔断规则, 5.5.3 降级方法, 5.5.3.1 blockHandler, 5.5.3.2 fallback, 5.5.3.3 defaultFallbackampexceptionsToIgnore, 5.6 热点规则（了解）, 5.7 授权规则（了解）, 5.8 系统规则（了解）, 5.9 动态规则、持久化, 5.10 OpenFeign整合Sentinel一微服务架构介绍架构演变单体架构所有的功能模块都在一个工程里架构这个架构当不当正不正对于现在来说有点老甚至需要之类的基本不会使用了微服务架构微服务架构思想是马丁福勒提出的他的核心思想是这一段话简而言之微服务架构风格是一种将单个应用程序开发为一套小型服务的方法每个服务都在自己的进程中运行并与轻量级机制通常是资源通信这些服务围绕业务能力构建并可通过全自动部署机制独立部署这些服务的集中管理最低限度这些服务可能用不同的编程语言编写并使用不同的数据存储技术将上述内容稍微整理微服务架构是一个软件架构风格他不是标准将一个单体架构的产品拆分成多个服务多个服务组成了完成的产品功能每个服务是可以完全独立部署的互不影响可以采用这种轻量级的方式实现服务之间的交互在拆分服务时一般是按照产品的业务领域去划分不同的服务也可以针对单个功能做成一个服务采用的方式去做自动化部署后面会学支持采用不用的语言去构建一个完整的产品微服务架构是架构思想微服务拆分出来的微小的服务比如上图中的商品服务就是一个微服务微服务框架对微服务的架构思想落地的一些技术生态官方地址咱们要学习生态里的几个技术链路追踪不玩这里只关注应用底层源码之类的内容这里不涉及二注册中心注册中心当订单服务需要访问库存服务时不知道库存服务的地址信息利用注册中心在服务启动时将服务的基本信息都注册到中当需要访问某一个服务之前可以去中获取到对应的服务信息就可以直接去访问啦如果让订单服务单独存储库存服务的基本信息会导致耦合问题如果库存服务的地址改变了订单服务也需要变化如果库存服务追加了集群的节点或者减少了集群的节点订单服务都需要做维护耦合性太高安装可以下简单的玩也可以在里安装直接去官方下载即可本地环境要求要么是要么是点击即可直接下载最好去官网打开准备启动服务然后到目录下准备启动启动成功要看到这个日志启动成功后直接访问提供的图形化界面初体验注册中心构建父工程并管理版本在玩的客户端操作前优先了解一下常识性内容是建立在基础上的其次版本版本的版本都是有对应的版本对应可以查看这个地址版本不同在使用的一些细节上可能会出现一些不一样的地方所以最好跟我的版本保持统一咱们先不玩依然是以为核心构建一个普通的工程在中做四个事情将当前工程的设置为类型声明好的并制定好版本声明的版本声明的版本准备库存服务这里需要完成几个操作构建好子工程导入依赖准备启动类并添加注解准备文件配置信息启动测试准备订单服务操作方式跟库存服务的套路没区别文件略微调整启动并测试库存服务提供接口在服务中提供一个可以对外访问的接口写完记得测试一下可以访问订单服务准备接口访问库存服务正常准备并且在启动类中构建好对象在中访问库存服务提供的接口现在是直接写死的状态没利用是启动类里构建的直接访问库存服务的接口获取数据响应数据在确保写死的状态下可以正常的获取到库存服务提供的接口后咱们开始利用去获取服务的地址信息只需要在配置中额外追加一个依赖再将基于对象访问的地址路径中的换成服务名希望的效果是在访问时将服务名从中解析为具体的和端口事与愿违报错了原因是因为现在玩的版本比较高默认已经不用需要导入的依赖就可以解决在服务中追加一个依赖再次访问得到具体的结果命名空间和分组了解咱们在默认操作时连接是的中的命名空间以及分组下的服务信息咱们可以在文件中指定要当前服务需要连接哪个命名空间以及分组优先构建一个命名空间然后指定服务连接的命名空间修改完毕后因为之前的服务依然注册在命名空间下所以服务去命名空间去找服务必然找不到报了这个错误将服务中的注册与发现的分组设置的再次去找实现注册与发现时就会只找下的内容再次去找服务时发现找不到那就对了因为咱们配置了分组的信息所以他会去去找对应的服务负载均衡了解负载均衡的操作不是去做的而是依赖或者低版本默认引入当前版本需要手动引入默认情况就是轮询的机制你一个我一个你一个我一个你一个我一个不需要做任何额外的配置默认机制即可虽然也有权重之类的操作基本不用稍微修改了一下代码方便查看具体的效果将服务的接口返回的结果追加上对应的端口号第一次启动发现错误找不到引入的原因是配置文件没写追加上对应的配置就完事了优先启动了的紧接着为了查看集群的效果基于的配置再次启动一个服务但是因为版本原因需要设置一下多环境信息才然后在中追加启动项启动配置好的这个的服务启动成功后可以在中看到具体的集群信息记住集群的服务名必须保持一致你写成不一样的那就是俩服务了再去访问的时候他就是默认轮询的效果了三配置中心配置中心之前咱们的配置信息都是放在项目工程里的文件中但是后期服务可能会涉及到集群部署并且部署在不同的服务器中如果没有一个统一管理这些配置的方案需要去多个地方维护这些配置信息项目在开发到发布交付的过程中涉及很多环境开发环境测试环境预生产环境生产环境环境很多需要提供多种环境下的配置文件项目中如果配置文件发生修改一般是需要重启项目才能生效的但是配置中心是可以实现动态刷新配置的功能修改玩配置文件可以立即生效不需要重启其次就是配置文件现在的形式就是本地的一个文本文件谁都能看谁都能改权限不好控制配置中心就会提供这种权限的控制针对历史版本的记录希望可以看到配置文件每次更改的变化以及历史版本记录也可以方便做一个回滚的操作总结下来就几点集中式管理配置文件的地方环境隔离配置动态刷新权限的控制历史版本记录初体验配置中心现在的目的是将服务中的的配置扔到服务中管理希望服务启动后可以去找对应地址的中的某个的配置文件达到启动后依然占用端口分成这几步完成上述操作导入依赖在服务上编写配置文件的配置文件中指定好地址以及加载哪个配置文件服务名环境名地址文件后缀将修改为因为版本关系需要追加上一个依赖测试启动后查看日志信息命名空间和分组了解这里跟注册中心的思路是完全一样的没啥变化优先准备一个命名空间下的分组的配置文件配置文件的编写方式服务名环境名地址文件后缀配置动态刷新配置的动态刷新的目的是为了实现当程序读取中的配置文件的内容时如果中修改了某个对应的项目不需要重启就可以立即生效准备一个环境提供一个接口获取配置中的某个的并且测试效果获取配置文件中的现在为了实现动态刷新的效果咱们只需要做一个事情在引入配置文件的类上追加一个注解即可四介绍是框架的一种不是的组件属于内部提供的是的框架作用都是一样的走的是自己的协议采用的是协议的主要目的就是为了简化项目中编译请求的过程并且让代码具备更好的可维护性他也整合等这些都是可以成本整合的是基于接口封装实现代理对象去访问的跟之前的单体项目的编写思路是一样的的初体验按照官方文档的方式一步一步走导入依赖启动类追加注解编写的接口映射到对应服务的接口上这里的内容如果可以最好去对应的位置复制测试在服务中编写测试接口基于尝试访问服务配置的超时配置通过官方文档可以得知的超时配置就个东西关注的不多更多的是客户端和服务端建立连接的超时时间这个配置的会比较多他是从请求发出到响应的超时时间将服务中的接口休眠一段时间来测试达到超时时间后的效果服务的配置服务名响应时间没响应直接报错当超时后抛出的错误这里区分版本之前的版本的超时时间是现在默认情况下都没超时也可能存在一个情况第一次请求的时候会初始化速度可能会比较慢其次也提供了全局默认缺省的配置方式默认的配置优先级低细粒度针对服务的配置优先级高的底层技术默认情况下咱们当前版本的底层使用的咱们可以通过配置去选择使用或者是咱们是三选一区别的话浅聊一下协议的支持对协议支持的更好性能相对来说其实大差不差但是还是的性能更好代码简洁度其实咱们用了就无所谓了异步的支持都支持是维护的而是的默认采用的是默认使用的将配置更改为使用就会采用的方式访问目标服务将配置修改为五介绍帮助咱们解决的问题核心方向有两个流量控制可以实现限流的功能同时也丰富了限流的机制还提供了达到限制的阈值后如何处理后续的请求断路器熔断本质是帮助咱们去解决一些服务雪崩的问题同时咱们可以主动的指定好降级方法返回对应的托底数据可以去官网看一下官方文档的介绍可以看这个安装依然是用语言编写的咱们安装其实本质就是下载一个包然后用运行起来就可以登录到图形化界面依然去官方看文档安装查看后是在上去下载对应的版本下载完毕之后在确定好你的环境没问题的情况下并且版本最好是暂时别弄和之类的版本最高为师能接受同时也要确认好当前系统的都端口没被占用默认占用然后就可以在窗口中基于启动项目因为启动程序可能会存在一些小问题比如我刚才在启动后需要按一下让程序继续加载才可以正常的访问到的官方直接访问默认的用户名和密码都是都是小写进入后看到这个就是安装成功初体验导入依赖编写配置连接的启动项目后访问任何接口不访问上看不到的上查看服务流控规则这里主要的操作就是点来点去在设置流控规则时发现需要设置一个资源名咱们有两个方式可以选择默认的资源名就是这个资源地址可以在接口方法追加的注解指定资源名限制直接快速失败阈值类型单体阈值流控模式直接流控效果快速失败只要每秒超过个请求第二个请求就会触发快速失败直接报错直接阈值类型单体阈值流控模式直接流控效果接口并不会一开始就支撑的慢慢的经过一段时间才会将限制开放到直接排队等待阈值类型单体阈值流控模式直接流控效果排队等待限制为的时候他会匀速的每个放一个请求进去关联快速失败阈值类型单体阈值流控模式关联流控效果快速失败首先需要准备两个资源查看效果给资源设置限制为关联的是资源当频繁的访问资源后就会被限制链路快速失败阈值类型单体阈值流控模式链路流控效果快速失败需要准备三个资源其中两个资源作为入口另外一个资源作为公共资源被访问中的方法默认就是资源其次其他基于管理的方法也可以作为资源只是必须要追加上的注解才可以公共资源发现设置好之后资源的入口是统一的就是导致咱们现在没有办法针对某个入口单独做链路的限制可以通过配置将统一入口管理的模式关闭掉就可以将每个资源作为一个入口追加完毕后重新启动项目查看簇点链路中已经有入口资源顶头了可以开始配置链路的效果了具体解决问题的地址并发线程数因为流控里的限制聊的模式基本都点到了这里的并发线程数看个效果即可阈值类型并发线程数单体阈值流控模式直接这个资源内部只能有一个线程在处理如果另外一个线程来了需要排队等待为了查看效果将代码的处理时间延长并发线程数熔断降级熔断降级介绍服务雪崩因为某一个服务出现问题导致其他服务甚至整个系统崩溃的情况就可以称为服务雪崩为了解决这个服务雪崩的问题可以上熔断降级来解决这种服务雪崩问题降级针对一些资源提供一个降级的方法当这个资源出现了一些问题时可以快速失败去执行降级方法返回托底数据熔断就是针对某个资源提供断路器有状态熔断和降级不是一个东西熔断是触发降级的手段之一熔断规则提供的熔断规则有三种慢调用比例请求的响应时间大于就被统计为慢调用在内请求数量达到个开始统计熔断的阈值如果慢调用统计达到了请求量的就会将断路器设置为状态持续后将断路器设置为状态并放一个请求进来这个请求是慢调用那就回到状态如果小于慢调用设置为状态异常比例资源访问出现异常就认定是异常在内请求数量达到个开始统计熔断的阈值如果异常统计达到了请求量的就会将断路器设置为状态持续后将断路器设置为状态并放一个请求进来这个请求出现异常那就回到状态如果没异常设置为状态异常数资源访问出现异常就认定是异常在内请求数量达到个开始统计熔断的阈值如果异常统计达到了个就会将断路器设置为状态持续后将断路器设置为状态并放一个请求进来这个请求出现异常那就回到状态如果没异常设置为状态提供一套测试熔断效果资源提供一个熔断降级启动项目开始测试看视频查看测试效果降级方法中提供的降级处理是基于注解来实现的是基于去实现的需要让方法的访问修饰符是注解的属性内容比较多咱一个一个看是专门处理的降级方法指定降级方法名降级方法需要修饰返回类型方法参数要匹配方法参数最后可以追加降级方法跟原方法在一个类里业务代码是方法的降级方法可以在方法逻辑中返回托底数据流量控制熔断控制这个属性和配合使用可以将降级方法声明在其他类里业务代码流量控制熔断控制对应着中的几种限制的方式流控熔断热点系统权限的使用跟就是一模一样但是只处理而直接处理指定降级方法名称指定降级方法所在的若和都进行了配置则被限流降级而抛出时只会进入处理逻辑是方法的降级方法可以在方法逻辑中返回托底数据流量控制熔断控制只能针对单个资源去玩可以针对全局指定默认的降级方法名称返回结果依然要统一参数列表要为空可以额外追加一个指定降级方法所在的是针对的可以忽略掉一些异常不走降级方法默认的热点规则了解热点规则也属于流控的范畴因为流控规则是针对整个资源直接做一些限制而热点规则可以针对某一个字段中的参数做一些更细粒度化的流控可以根据资源内传入的指定参数来做热点参数的限流会帮你统计单位时间内这个参数值请求的次数利用滑动时间窗口再利用令牌桶来实现具体的限流操作为了查看效果需要提供一个资源接收俩个参数热点规则根据上述编写的资源根据作为限流的参数当值传递的一样时会统计好次数基于的方式做限制在统计窗口时长时当然热点参数值最多可以请求单击阈值次超过了就异常可以针对参数的具体值再做更细粒度化的限制测试了一波热点规则对于接受参数的形式默认资源内基于单个类型的参数接收是没问题的包括默认如果采用对象的形式接收参数热点规则没法生效授权规则了解所谓的授权规则其实就是针对某一个资源的调用方的身份做验证可以指定黑白名单指定一个只要满足要求才会放行请求否则会被拦截优先准备一个资源来测试授权规则设置好黑白名单后发现无法生效当然服务资源在做黑白明显的限制规则时会基于拦截器内部调用的实现类去获取请求来源的具体身份信息因为没有默认实现的在这种情况下他返回的都是空串那咱们需要主动实现一个实现类直接基于请求头获取中的信息作为调用方的身份编写后之后在中发送请求在请求头中追加了信息携带上了身份然后实现了授权的规则校验获取调用方身份是基于拿到的而校验的方式就是基于查看中设置的授权的黑白名单身份是否包含了获取的信息系统规则了解系统规则不是针对某一个资源去做限制而是针对整个服务的所有资源统一的做一些限制系统规则的目的是让整个系统保持可用并且不会因为某一些资源的激增流量导致整个系统被压垮系统规则支持以下的模式自适应仅对机器生效系统的作为启发指标进行自适应系统保护当系统超过设定的启发值且系统当前的并发线程数超过估算的系统容量时才会触发系统保护阶段系统容量由系统的估算得出设定参考值一般是版本当系统使用率超过阈值即触发系统保护取值范围比较灵敏平均当单台机器上所有入口流量的平均达到阈值即触发系统保护单位是毫秒并发线程数当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护入口当单台机器上所有入口流量的达到阈值即触发系统保护持久化动态规则持久化在的图形化界面中配置的各种规则都是存储在内存里的之前配置的各种规则就全么得了不可能每次项目重启后都去重新指定这些规则成本太高了也支持将一些规则持久化到某个的种类很多大概分为了两种拉模式客户端主动去查看是否变化缺点是无法及时获取变更推模式主动去通知客户端变化的内容有更好的实时性和一致性保证其中就是推模式的一种实现直接基于来持久化中的规则实现步骤导入依赖编写配置中构建配置编写规则想编写这个内容的配置配置熔断规则的套路依赖导入配置的配置整合整合的目的其实就是针对基于去访问其他服务时如果出来了任何的问题不要抛出异常而是走降级方法返回托底数据需要编写配置文件开启跟的整合构建接口的实现类重写接口的方法重写的方法就是降级方法的降级方法服务器正忙请稍后再试在接口中指定的属性有同学会有疑问这样不就有俩实现类在容器中了么怎么知道到底注入哪一个其实是基于中的属性指定了接口的代理对象作为咱们注入的主要对象至于就不实现了大概知道可以利用或者两种形式不过都是基于构建接口实现类去玩的',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-06-18 15:45:55',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://img.soniachen.com/cover2.gif"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.soniachen.com/" title="博客"><img class="back-menu-item-icon" src="https://img.soniachen.com/%E9%92%A2%E9%93%81%E8%9C%98%E8%9B%9B%E4%BE%A0.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Sonia33</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=447363601&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://img.soniachen.com/blog/IMG_5543.JPG" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://img.soniachen.com/blog/IMG_5543.JPG"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://img.soniachen.com/blog/IMG_5544.JPG" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://img.soniachen.com/blog/IMG_5544.JPG"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BlockChain/" style="font-size: 1.05rem;">BlockChain<sup>4</sup></a><a href="/tags/CSS/" style="font-size: 1.05rem;">CSS<sup>1</sup></a><a href="/tags/CloudFlare/" style="font-size: 1.05rem;">CloudFlare<sup>2</sup></a><a href="/tags/DataBase/" style="font-size: 1.05rem;">DataBase<sup>2</sup></a><a href="/tags/FastDFS/" style="font-size: 1.05rem;">FastDFS<sup>1</sup></a><a href="/tags/Foundry/" style="font-size: 1.05rem;">Foundry<sup>1</sup></a><a href="/tags/Git/" style="font-size: 1.05rem;">Git<sup>2</sup></a><a href="/tags/HTML/" style="font-size: 1.05rem;">HTML<sup>1</sup></a><a href="/tags/IO/" style="font-size: 1.05rem;">IO<sup>1</sup></a><a href="/tags/JDBC/" style="font-size: 1.05rem;">JDBC<sup>1</sup></a><a href="/tags/JQuery/" style="font-size: 1.05rem;">JQuery<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem; font-weight: 500; color: var(--anzhiyu-lighttext)">Java<sup>3</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem;">JavaScript<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>1</sup></a><a href="/tags/MQ/" style="font-size: 1.05rem;">MQ<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 1.05rem;">MySQL<sup>2</sup></a><a href="/tags/Nacos/" style="font-size: 1.05rem;">Nacos<sup>1</sup></a><a href="/tags/NoSQL/" style="font-size: 1.05rem;">NoSQL<sup>1</sup></a><a href="/tags/OpenFeign/" style="font-size: 1.05rem;">OpenFeign<sup>1</sup></a><a href="/tags/PicGo/" style="font-size: 1.05rem;">PicGo<sup>1</sup></a><a href="/tags/RabbitMQ/" style="font-size: 1.05rem;">RabbitMQ<sup>1</sup></a><a href="/tags/Redis/" style="font-size: 1.05rem;">Redis<sup>2</sup></a><a href="/tags/Rust/" style="font-size: 1.05rem;">Rust<sup>6</sup></a><a href="/tags/Sentinel/" style="font-size: 1.05rem;">Sentinel<sup>2</sup></a><a href="/tags/Solidity/" style="font-size: 1.05rem;">Solidity<sup>4</sup></a><a href="/tags/Typora/" style="font-size: 1.05rem;">Typora<sup>1</sup></a><a href="/tags/Zookeeper/" style="font-size: 1.05rem;">Zookeeper<sup>1</sup></a><a href="/tags/hexo/" style="font-size: 1.05rem;">hexo<sup>3</sup></a><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>1</sup></a><a href="/tags/macOS/" style="font-size: 1.05rem;">macOS<sup>2</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 1.05rem;">分布式<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 1.05rem;">分布式锁<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 1.05rem;">后端<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">多线程<sup>1</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 1.05rem;">测试<sup>1</sup></a><a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 1.05rem;">缓存<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>1</sup></a><a href="/tags/%E8%B8%A9%E9%9B%B7/" style="font-size: 1.05rem;">踩雷<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">11</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/05/"><span class="card-archive-list-date">五月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/03/"><span class="card-archive-list-date">三月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/SpringCloud/" itemprop="url">SpringCloud</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/Sentinel/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Sentinel</span></a><a class="article-meta__tags" href="/tags/Nacos/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>Nacos</span></a><a class="article-meta__tags" href="/tags/OpenFeign/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>OpenFeign</span></a></span></div></div><h1 class="post-title" itemprop="name headline">微服务技术栈</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2024-09-10T06:26:18.000Z" title="发表于 2024-09-10 14:26:18">2024-09-10</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-06-18T07:45:55.064Z" title="更新于 2025-06-18 15:45:55">2025-06-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">8.8k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>33分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为四川"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>四川</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/09/10/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-SpringCloud/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://img.soniachen.com/IMG_5493.jpg?_r_=1e00c770-98e4-1b33-6d57-241b89e1c2b1"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.soniachen.com/2024/09/10/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-SpringCloud/"><header><a class="post-meta-categories" href="/categories/SpringCloud/" itemprop="url">SpringCloud</a><a href="/tags/Sentinel/" tabindex="-1" itemprop="url">Sentinel</a><a href="/tags/Nacos/" tabindex="-1" itemprop="url">Nacos</a><a href="/tags/OpenFeign/" tabindex="-1" itemprop="url">OpenFeign</a><h1 id="CrawlerTitle" itemprop="name headline">微服务技术栈</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">SoniaChen</span><time itemprop="dateCreated datePublished" datetime="2024-09-10T06:26:18.000Z" title="发表于 2024-09-10 14:26:18">2024-09-10</time><time itemprop="dateCreated datePublished" datetime="2025-06-18T07:45:55.064Z" title="更新于 2025-06-18 15:45:55">2025-06-18</time></header><h1><strong>一、微服务架构介绍</strong></h1>
<h2 id="1-1-架构演变">1.1 架构演变</h2>
<blockquote>
<p><strong>单体架构：</strong> All in One，所有的功能模块都在一个工程里。</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/374f9e8ea3e642838ee5e2c7e9b66a41.png" alt="image.png"></p>
<p><strong>SOA架构：</strong> 这个架构当不当正不正，对于现在来说，有点老，甚至需要ESB，WebService之类的，基本不会使用了。</p>
<p><strong>微服务架构：</strong>  微服务架构思想是马丁福勒提出的</p>
<p><a target="_blank" rel="noopener" href="https://martinfowler.com/articles/microservices.html">https://martinfowler.com/articles/microservices.html</a></p>
<p>他的核心思想是这一段话：</p>
<pre class="language-none"><code class="language-none">In short, the microservice architectural style 1 is an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API. These services are built around business capabilities and independently deployable by fully automated deployment machinery. There is a bare minimum of centralized management of these services, which may be written in different programming languages and use different data storage technologies.

简而言之，微服务架构风格1是一种将单个应用程序开发为一套小型服务的方法，每个服务都在自己的进程中运行，并与轻量级机制（通常是HTTP资源API）通信。这些服务围绕业务能力构建，并可通过全自动部署机制独立部署。这些服务的集中管理最低限度，这些服务可能用不同的编程语言编写，并使用不同的数据存储技术。</code></pre>
<p>将上述内容稍微整理：</p>
<ul>
<li>微服务架构是一个软件架构风格，他不是标准。</li>
<li>将一个单体架构的产品拆分成多个服务，多个服务组成了完成的产品功能。</li>
<li>每个服务是可以完全独立部署的，互不影响。</li>
<li>可以采用HTTP这种轻量级的方式实现服务之间的交互。</li>
<li>在拆分服务时，一般是按照产品的业务领域去划分不同的服务，也可以针对单个功能做成一个服务。</li>
<li>采用DevOps的方式去做自动化部署。 （后面会学）</li>
<li>支持采用不用的语言去构建一个完整的产品。</li>
</ul>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/f8eb541f60a24967b24a0fcdcd5ac240.png" alt="image.png"></p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/286d41b410c84b85a717f16b76a61284.png" alt="image.png"></p>
<p>微服务架构：是架构思想。</p>
<p>微服务：拆分出来的微小的服务，比如上图中的商品服务就是一个微服务。</p>
<p>微服务框架：对微服务的架构思想落地的一些技术。</p>
</blockquote>
<h2 id="1-2-SpringCloud生态">1.2 SpringCloud生态</h2>
<blockquote>
<p>官方地址： <a target="_blank" rel="noopener" href="https://spring.io/projects/spring-cloud">https://spring.io/projects/spring-cloud</a></p>
<p>咱们要学习SpringCloud生态里的几个技术：</p>
<ul>
<li>SpringCloud Alibaba： Nacos</li>
<li>SpringCloud：OpenFeign</li>
<li>SpringCloud Alibaba：Sentinel</li>
<li>SpringCloud：Gateway</li>
<li><strong>链路追踪：Sleuth + Zipkin  -  SkyWalking（不玩）</strong></li>
</ul>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/08081e25a8b844bea6663bc1497b5009.png" alt="image.png"></p>
<p><strong>Ps：这里只关注应用，底层源码之类的内容，这里不涉及。</strong></p>
</blockquote>
<h1>二、Nacos注册中心</h1>
<h2 id="2-1-注册中心">2.1 注册中心</h2>
<blockquote>
<p>当订单服务需要访问库存服务时，不知道库存服务的地址信息。利用注册中心，在服务启动时，将服务的基本信息都注册到Nacos中，当需要访问某一个服务之前，可以去Nacos中获取到对应的服务信息，就可以直接去访问啦~~~</p>
<p>如果让订单服务单独存储库存服务的基本信息，会导致耦合问题，如果库存服务的地址改变了，订单服务也需要变化，如果库存服务追加了集群的节点或者减少了集群的节点，订单服务都需要做维护，耦合性太高。</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/3a607132146547579f90f8db2b940c10.png" alt="image.png"></p>
</blockquote>
<h2 id="2-2-Nacos安装">2.2 Nacos安装</h2>
<blockquote>
<p>Nacos可以Windows下简单的玩，也可以在Linux里安装。</p>
<p>直接去官方下载即可。</p>
<p>本地环境要求，java -version要么是JDK8，要么是JDK11</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/57d464304a38460aa2e4f1daaa1b4518.png" alt="image.png">1</p>
<p><a target="_blank" rel="noopener" href="https://download.nacos.io/nacos-server/nacos-server-2.5.1.zip?spm=5238cd80.2ef5001f.0.0.3f613b7cKzonbx&amp;file=nacos-server-2.5.1.zip">https://download.nacos.io/nacos-server/nacos-server-2.5.1.zip?spm=5238cd80.2ef5001f.0.0.3f613b7cKzonbx&amp;file=nacos-server-2.5.1.zip</a></p>
<p><strong>点击即可直接下载（最好去官网）。</strong></p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/50028280050a48c3afca88986bb2fc18.png" alt="image.png"></p>
<p>打开cmd准备启动Nacos服务</p>
<p>然后到bin目录下准备启动</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/ef013c66e8f84a54b5ccf6e6261c5664.png" alt="image.png">启动成功要看到这个日志</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/9f76aa77d2684bc9ab177b0712200975.png" alt="image.png"></p>
<p>启动成功后，直接访问Nacos提供的图形化界面</p>
<p><a target="_blank" rel="noopener" href="http://localhost:8848/nacos">http://localhost:8848/nacos</a></p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/a37fffd20043410a820a1fd39538e1f2.png" alt="image.png"></p>
</blockquote>
<h2 id="2-3-Nacos初体验（注册中心）">2.3 Nacos初体验（注册中心）</h2>
<h3 id="2-3-1-构建父工程并管理版本">2.3.1 构建父工程并管理版本</h3>
<blockquote>
<p>在玩Nacos的客户端操作前，优先了解一下常识性内容。</p>
<p>SpringCloud是建立在SpringBoot基础上的。</p>
<p>其次，SpringBoot版本，SpringCloud版本，SpringCloudAlibaba的版本都是有对应的。</p>
<p>版本对应可以查看这个地址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E">https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E</a></p>
<p>版本不同，在使用的一些细节上可能会出现一些不一样的地方，所以最好跟我的版本保持统一！</p>
<p>SpringBoot咱们先不玩3.x，依然是以2.x为核心。</p>
<p>构建一个普通的Maven工程，在pom.xml中做四个事情。</p>
<ul>
<li>将当前工程的packaging设置为pom类型。</li>
<li>声明好SpringBoot的parent，并制定好版本</li>
<li>声明SpringCloud的版本</li>
<li>声明SpringCloudAlibaba的版本</li>
</ul>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">></span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>2.6.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.mashibing<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>springcloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">></span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">></span></span>2021.0.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud-alibaba.version</span><span class="token punctuation">></span></span>2021.0.4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud-alibaba.version</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring-cloud.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-alibaba-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>$&#123;spring-cloud-alibaba.version&#125;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">></span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">></span></span>


<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">></span></span></code></pre>
</blockquote>
<h3 id="2-3-2-准备库存服务">2.3.2 准备库存服务</h3>
<blockquote>
<p>这里需要完成几个操作。</p>
<p>1、构建好子工程……</p>
<p>2、导入依赖……</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></code></pre>
<p>3、准备启动类，并添加注解……</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableDiscoveryClient</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockStarterApp</span> <span class="token punctuation">&#123;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">StockStarterApp</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>4、准备yml文件，配置Nacos信息……</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> stock
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span></code></pre>
<p>5、启动测试……</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/cf33bd2671f34b52b7710c031cd9687b.png" alt="image.png"></p>
</blockquote>
<h3 id="2-3-3-准备订单服务">2.3.3 准备订单服务</h3>
<blockquote>
<p>操作方式跟库存服务的套路没区别。</p>
<p>yml文件略微调整</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> order
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span></code></pre>
<p>启动并测试</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/915bc496b4ba4c7188afa229937a58b3.png" alt="image.png"></p>
</blockquote>
<h3 id="2-3-4-库存服务提供接口">2.3.4 库存服务提供接口</h3>
<blockquote>
<p>在stock服务中提供一个可以对外访问的接口</p>
<p>写完记得测试一下，可以访问。</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/stock/test"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"stock test!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/81949c73624345e2926ee009c0d961c4.png" alt="image.png"></p>
</blockquote>
<h3 id="2-3-5-订单服务准备接口访问库存服务">2.3.5 订单服务准备接口访问库存服务</h3>
<blockquote>
<p>正常准备OrderController，并且在启动类中构建好RestTemplate对象，在OrderController中访问库存服务提供的接口。  <strong>现在是直接写死的状态，没利用Nacos。</strong></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplate</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// restTemplate是启动类里构建的！</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/test"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token comment">//1、 直接访问库存服务的/stock/test接口，获取数据</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token string">"http://localhost:8080/stock/test"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2、 响应数据</span>
        <span class="token keyword">return</span> <span class="token string">"Order Test get "</span> <span class="token operator">+</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/06e113dba0954c2a8a9be06e176b5975.png" alt="image.png"></p>
<hr>
<p>在确保写死的状态下，可以正常的获取到库存服务提供的接口后，咱们开始利用Nacos去获取服务的地址信息。</p>
<p>只需要在配置RestTemplate中，额外追加一个依赖</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Bean</span>
<span class="token annotation punctuation">@LoadBalanced</span>
<span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>再将基于restTemplate对象访问的地址路径中的ip:port换成服务名。</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/3d9e8e55cd6946d1a8b596347f54aa30.png" alt="image.png"></p>
<p>希望的效果是，在restTemplate访问时，将stock服务名从Nacos中解析为具体的ip和端口。But事与愿违，报错了。</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/5b2ef5be9059474ea573b3df7fe06b01.png" alt="image.png"></p>
<p>原因是因为现在玩的版本比较高，默认已经不用Ribbon，需要导入loadbalancer的依赖，就可以解决。</p>
<p>在order服务中，追加一个依赖。</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-loadbalancer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p>再次访问，得到具体的结果</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/625445e2eb7d4cbe8e754ca18087987a.png" alt="image.png"></p>
</blockquote>
<h2 id="2-4-命名空间和分组（了解）">2.4 命名空间和分组（了解）</h2>
<blockquote>
<p>咱们在默认操作时，连接是的Nacos中的public命名空间以及DEFAULT_GROUP分组下的服务信息。</p>
<p>咱们可以在yml文件中指定要，当前服务需要连接哪个命名空间以及分组。</p>
</blockquote>
<hr>
<blockquote>
<p>优先构建一个命名空间，然后指定order服务连接的命名空间</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/f0f1b752e40844efa88fcc301e7fc209.png" alt="image.png"></p>
<p>修改完毕后，因为之前的stock服务依然注册在public命名空间下，所以order服务去dev命名空间去找stock服务必然找不到，So，报了这个错误</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/6ecec72f503843cd817412406df02642.png" alt="image.png"></p>
</blockquote>
<hr>
<blockquote>
<p>将order服务中的注册与发现的分组设置的PDD_GROUP，再次去找Nacos实现注册与发现时，就会只找PDD_GROUP下的内容</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/c09281b64edc4d3aa537ed40a77de81d.png" alt="image.png"></p>
<p>再次去找stock服务时，发现找不到，那就对了，因为咱们配置了分组的信息，所以他会去PDD_GROUP去找对应的stock服务。</p>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/42732a8eff1f4668bc410ae0a72025b6.png" alt="image.png"></p>
</blockquote>
<h2 id="2-5-负载均衡（了解）">2.5 负载均衡（了解）</h2>
<blockquote>
<p><img src="https://img.soniachen.com/blog/posts/2025/06/d70d40d37f4a49d78104436efbf79876.png" alt="image.png"><br>
负载均衡的操作不是Nacos去做的。而是Nacos依赖 <strong>Ribbon或者Loadbalancer</strong> 。</p>
<p><strong>（低版本默认引入Ribbon，当前版本需要手动引入Loadbalancer）</strong></p>
<p>默认情况就是轮询的机制，你一个，我一个，你一个，我一个，你一个，我一个……</p>
<p>不需要做任何额外的配置，默认机制即可，虽然也有权重之类的操作，基本不用。</p>
<p>稍微修改了一下代码，方便查看具体的效果，将stock服务的test接口返回的结果追加上对应的端口号。</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockController</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;server.port&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/stock/test"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"stock test!"</span> <span class="token operator">+</span> serverPort<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>
<p>第一次启动发现错误，找不到引入的 <strong>@Value(“${server.port}”)</strong> ，原因是配置文件没写。</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/760d7c17c6224933b53e0922396d4d8c.png" alt="image.png"></p>
<p>追加上对应的配置，就完事了。</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/b10d0d49c4844a2bbe8cdf48d90a490a.png" alt="image.png"></p>
<p>优先启动了8080的Stock。</p>
<p>紧接着为了查看集群的效果，基于IDEA的配置，再次启动一个Stock服务，但是因为IDEA版本原因，需要设置一下多环境信息才ok。</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/a9a0a5c61b554fe290095d1ef4a53962.png" alt="image.png"></p>
<p>然后在IDEA中追加启动项，启动配置好的这个8081的Stock服务</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/05f9484a228f4477a4098b46179ccbcb.png" alt="image.png"></p>
<p>启动成功后，可以在Nacos中看到具体的集群信息</p>
<p>Ps：记住，集群的服务名必须保持一致，你写成不一样的，那就是俩服务了。</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/7bd2a0cc4ff14843ae5d7a82d2561de8.png" alt="image.png"></p>
<p>再去访问的时候，他就是默认轮询的效果了！</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/a4dc6af57d6c444f8a92a74d76ad5eb4.png" alt="image.png"></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/85a3329633224a82a30e86f3206fc7e7.png" alt="image.png"></p>
</blockquote>
<h1>三、Nacos配置中心</h1>
<h2 id="3-1-配置中心">3.1 配置中心</h2>
<blockquote>
<p>之前咱们的配置信息都是放在项目工程里的application.yml文件中。</p>
<p>但是后期服务可能会涉及到集群部署，并且部署在不同的服务器中。如果没有一个统一管理这些配置的方案，需要去多个地方维护这些配置信息。</p>
<p>项目在开发到发布交付的过程中，涉及很多环境开发环境，测试环境，预生产环境，生产环境，环境很多，需要提供多种环境下的配置文件。</p>
<p>项目中如果配置文件发生修改，一般是需要重启项目才能生效的，但是配置中心是可以实现动态刷新配置的功能，修改玩配置文件，可以立即生效，不需要重启。</p>
<p>其次就是配置文件现在的形式就是本地的一个文本文件，谁都能看，谁都能改，权限不好控制。配置中心就会提供这种权限的控制。</p>
<p>针对历史版本的记录，希望可以看到配置文件每次更改的变化，以及历史版本记录，也可以方便做一个回滚的操作。</p>
<p>总结下来就几点：</p>
<ul>
<li>集中式管理配置文件的地方</li>
<li>环境隔离</li>
<li>配置动态刷新</li>
<li>权限的控制</li>
<li>历史版本记录</li>
</ul>
</blockquote>
<h2 id="3-2-Nacos初体验（配置中心）">3.2 Nacos初体验（配置中心）</h2>
<blockquote>
<p>现在的目的是将order服务中的server.port=80的配置扔到Nacos服务中管理。希望Order服务启动后，可以去找对应地址的Nacos中的某个DataId的配置文件，达到启动后，依然占用80端口。</p>
<p><strong>分成这几步完成上述操作：</strong></p>
<p><strong>1、导入依赖</strong></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p><strong>2、在Nacos服务上编写配置文件</strong></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/7d65825d1e644d4d8bda60d0a3ecb936.png" alt="image.png"><br>
<strong>3、Order的配置文件中指定好Nacos地址以及加载哪个配置文件</strong></p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment"># 服务名</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> order
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token comment"># 环境名</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> study
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token comment"># nacos地址</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token comment"># 文件后缀</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yml
<span class="token comment">#  order-study.yml</span>
<span class="token comment">#  $&#123;spring.application.name&#125; - $&#123;spring.profiles.active&#125; . $&#123;spring.cloud.nacos.config.file-extension&#125;</span></code></pre>
<p><strong>4、将application.yml修改为bootstrap.yml</strong></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/21bdc67488b9487d82e727c223bc6f2b.png" alt="image.png"></p>
<p><strong>5、因为版本关系，需要追加上一个依赖。</strong></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-bootstrap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p><strong>6、测试，启动后查看日志信息</strong></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/9645abdaced9445f8fa2a0c11ec1bcd7.png" alt="image.png"></p>
</blockquote>
<h2 id="3-3-命名空间和分组（了解）">3.3 命名空间和分组（了解）</h2>
<blockquote>
<p>这里跟注册中心的思路是完全一样的，没啥变化</p>
<p>优先准备一个dev命名空间下的DEV_GROUP分组的配置文件。</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/96fb0592bae74854998339f41144d2e9.png" alt="image.png"></p>
<p>配置文件的编写方式</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment"># 服务名</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> order
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token comment"># 环境名</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token comment"># nacos地址</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">8848</span>
        <span class="token comment"># 文件后缀</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yml
        <span class="token key atrule">namespace</span><span class="token punctuation">:</span> 06173ada<span class="token punctuation">-</span>fb39<span class="token punctuation">-</span>47b3<span class="token punctuation">-</span>8551<span class="token punctuation">-</span>7265a5177770
        <span class="token key atrule">group</span><span class="token punctuation">:</span> DEV_GROUP</code></pre>
</blockquote>
<h2 id="3-4-配置动态刷新">3.4 配置动态刷新</h2>
<blockquote>
<p>配置的动态刷新的目的是为了实现当程序读取Nacos中的配置文件的内容时，如果Nacos中修改了某个key对应的value，项目不需要重启就可以立即生效。</p>
<p>准备一个环境，提供一个Controller接口，获取Nacos配置中的某个key的value，并且测试效果。</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// 获取Nacos配置文件中的info</span>
<span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;info:empty&#125;"</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">String</span> info<span class="token punctuation">;</span>


<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/info"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> info<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/1a2aeed96f484f8c8fcf6423bbef07e3.png" alt="image.png"></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/d2c9a173d98a406fb9f753ff88912b8c.png" alt="image.png"></p>
</blockquote>
<hr>
<blockquote>
<p>现在为了实现动态刷新的效果，咱们只需要做一个事情。</p>
<p>在引入Nacos配置文件的类上，追加一个注解即可</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RefreshScope</span></code></pre>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/8e6e99c8bf3d495a883dad52a41790c6.png" alt="image.png"></p>
</blockquote>
<h1>四、OpenFeign</h1>
<h2 id="4-1-OpenFeign介绍">4.1 OpenFeign介绍</h2>
<blockquote>
<p>OpenFeign是RPC框架的一种，OpenFeign不是Alibaba的组件，属于SpringCloud。</p>
<p>Alibaba内部提供的是Dubbo的RPC框架，作用都是一样的。</p>
<ul>
<li>Dubbo走的是自己的Dubbo协议。</li>
<li>OpenFeign采用的是HTTP协议。</li>
</ul>
<p>OpenFeign的主要目的就是为了 <strong>简化Java项目中编译HTTP请求的过程</strong> ，并且让代码 <strong>具备更好的可维护性</strong> 。</p>
<p>OpenFeign他也 <strong>整合Sentinel，Nacos，Hystrix，LoadBalancer等</strong> ，这些OpenFeign都是可以0成本整合的。</p>
<p>OpenFeign是 <strong>基于接口（interface）封装</strong> ，实现代理对象去访问的，跟之前的单体项目的编写思路是一样的。</p>
</blockquote>
<h2 id="4-2-OpenFeign的初体验">4.2 OpenFeign的初体验</h2>
<blockquote>
<p>按照官方文档的方式一步一步走。</p>
<p><strong>1、导入依赖</strong></p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-openfeign<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p><strong>2、启动类追加注解</strong></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@EnableFeignClients</span></code></pre>
<p><strong>3、编写OpenFeign的Client接口。（映射到对应服务的接口上）</strong></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>client</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"stock"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StockClient</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">// 这里的内容，如果可以，最好去对应的Controller位置复制</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/stock/test"</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>
</code></pre>
<p><strong>4、测试，在order服务中编写测试接口</strong></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RefreshScope</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">&#123;</span>


    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StockClient</span> stockClient<span class="token punctuation">;</span>

    <span class="token comment">// 基于OpenFeign，尝试访问Stock服务</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/feign"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">feign</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> stockClient<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/91fb4e69c034418e8f02514584ed9ccd.png" alt="image.png"></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/09449f3029a1439a8dcf8c5eb53945af.png" alt="image.png"></p>
</blockquote>
<h2 id="4-3-OpenFeign配置">4.3 OpenFeign配置</h2>
<h3 id="4-3-1-OpenFeign的超时配置">4.3.1 OpenFeign的超时配置</h3>
<blockquote>
<p>通过官方文档可以得知，OpenFeign的超时配置就2个东西</p>
<ul>
<li><code>connectTimeout</code> prevents blocking the caller due to the long server processing time.</li>
<li><code>readTimeout</code> is applied from the time of connection establishment and is triggered when returning the response takes too long.</li>
</ul>
<p>connectTimeout：关注的不多，更多的是客户端和服务端建立TCP连接的超时时间。</p>
<p>readTimeout：这个配置的会比较多，他是从请求发出到响应的超时时间</p>
<p>将Stock服务中的接口休眠一段时间，来测试达到超时时间后的效果</p>
<p>Order服务的配置：</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">stock</span><span class="token punctuation">:</span>  <span class="token comment"># 服务名</span>
        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">1000</span>    <span class="token comment"># 响应时间1s，没响应直接报错</span></code></pre>
<p>当超时后，抛出的错误。</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/a8f173f789a041dca9e3dd382fbdd881.png" alt="image.png"></p>
<p><strong>Ps：这里区分版本，之前的版本，OpenFeign的超时时间是1s，现在默认情况下，5s都没超时！</strong></p>
<p><strong>也可能存在一个情况，第一次请求的时候，会初始化，速度可能会比较慢。</strong></p>
<p>其次，OpenFeign也提供了全局（默认、缺省）的配置方式</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">default</span><span class="token punctuation">:</span>  <span class="token comment"># 默认的配置，优先级低</span>
        <span class="token key atrule">read-timeout</span><span class="token punctuation">:</span> <span class="token number">2000</span>
      <span class="token key atrule">stock</span><span class="token punctuation">:</span>  <span class="token comment"># 细粒度针对服务的配置，优先级高</span>
        <span class="token key atrule">readTimeout</span><span class="token punctuation">:</span> <span class="token number">6000</span></code></pre>
</blockquote>
<h3 id="4-3-2-OpenFeign的底层技术">4.3.2 OpenFeign的底层技术</h3>
<blockquote>
<p>默认情况下，咱们当前版本的OpenFeign底层使用的HttpClient4。</p>
<p>咱们可以通过配置去选择使用okHttp或者是HC5（HttpClient5）</p>
<p>咱们是三选一：okHttp，HttpClient4，HC5。</p>
<p>区别的话，浅聊一下：</p>
<ul>
<li>协议的支持：okHttp，HC5对协议支持的更好。</li>
<li>性能：相对来说，其实大差不差，但是还是okHttp，HC5的性能更好。</li>
<li>代码简洁度：其实咱们用了OpenFeign就无所谓了。</li>
<li>异步的支持：都支持！</li>
<li>okHttp是Square维护的，而HttpClient，HC5是Apache的。</li>
</ul>
<p>默认采用的是HttpClient4：</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment"># 默认使用的HttpClient</span></code></pre>
<p>将配置更改为使用HC5</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">httpclient</span><span class="token punctuation">:</span>
    <span class="token key atrule">hc5</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>   <span class="token comment"># 就会采用HC5的方式访问目标服务</span></code></pre>
<p>将配置修改为okHttp</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">okhttp</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>
</blockquote>
<h1>五、Sentinel</h1>
<h2 id="5-1-Sentinel介绍">5.1 Sentinel介绍</h2>
<blockquote>
<p>Sentinel帮助咱们解决的问题核心方向有两个：</p>
<ul>
<li><strong>流量控制：</strong> 可以实现限流的功能，同时也丰富了限流的机制，还提供了达到限制的阈值后，如何处理后续的请求。</li>
<li><strong>断路器、熔断：</strong> 本质是帮助咱们去解决一些服务雪崩的问题，同时咱们可以主动的指定好降级方法，返回对应的托底数据。</li>
</ul>
<p>可以去官网看一下。</p>
<p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/index.html">https://sentinelguard.io/zh-cn/index.html</a></p>
<p>官方文档的介绍，可以看这个</p>
<p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/introduction.html">https://sentinelguard.io/zh-cn/docs/introduction.html</a></p>
</blockquote>
<h2 id="5-2-Sentinel安装">5.2 Sentinel安装</h2>
<blockquote>
<p>Sentinel依然是用Java语言编写的，咱们安装Sentinel，其实本质就是下载一个jar包，然后用java -jar运行起来就可以登录到图形化界面。</p>
<p>依然去官方看文档安装。查看后，是在github上去下载对应的release版本</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/tags">https://github.com/alibaba/Sentinel/tags</a></p>
<p><strong>下载完毕之后，在确定好你的JDK环境没问题的情况下，并且JDK版本最好是1.8</strong></p>
<p><strong>暂时别弄17和21之类的版本，最高为师能接受JDK11。</strong></p>
<p><strong>同时也要确认好，当前系统的都8080端口没被占用，Sentinel默认占用8080。</strong></p>
<p>然后就可以在cmd窗口中，基于</p>
<pre class="language-powershell" data-language="powershell"><code class="language-powershell">java <span class="token operator">-</span>jar sentinel-dashboard-1<span class="token punctuation">.</span>8<span class="token punctuation">.</span>7</code></pre>
<p>启动Sentinel项目。</p>
<p><strong>Ps：因为Windows启动程序可能会存在一些小问题，比如我刚才，在启动后，需要按一下Ctrl + C让程序继续加载，才可以正常的访问到Sentinel的官方。</strong></p>
<p>直接访问： <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080/</a></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/2a4749321bac40c099ffc9a2aba2880b.png" alt="image.png"></p>
<p><strong>默认的用户名和密码都是 sentinel  （都是小写）</strong></p>
<p>进入后，看到这个就是安装成功</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/b10b9a0ec8d64d54b55ba934fde70320.png" alt="image.png"></p>
</blockquote>
<h2 id="5-3-Sentinel初体验">5.3 Sentinel初体验</h2>
<blockquote>
<p>1、导入依赖</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p>2、编写配置连接Sentinel的dashboard</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8719</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> localhost<span class="token punctuation">:</span><span class="token number">8080</span></code></pre>
<p>3、启动项目后访问任何接口，不访问，dashboard上看不到</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/8b7c626b926a497bb056b1042306d6a1.png" alt="image.png"></p>
<p>4、Sentinel的dashboard上查看服务</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/04b01a2efa324238a93e18b6ca897c75.png" alt="image.png"></p>
</blockquote>
<h2 id="5-4-流控规则">5.4 流控规则</h2>
<blockquote>
<p>这里主要的操作就是点来点去。</p>
<p>在设置流控规则时，发现需要设置一个资源名，咱们有两个方式可以选择</p>
<ul>
<li>
<p>默认的资源名就是这个资源地址。</p>
</li>
<li>
<p>可以在Controller接口（方法）追加@SentinelResource的注解，指定资源名</p>
<pre class="language-none"><code class="language-none">@GetMapping(&quot;&#x2F;order&#x2F;info&quot;)
@SentinelResource(value &#x3D; &quot;info&quot;)
public String info() &#123;
    return info;
&#125;</code></pre>
</li>
</ul>
</blockquote>
<hr>
<h3 id="5-4-1-QPS限制">5.4.1 QPS限制</h3>
<h4 id="5-4-1-1-直接-快速失败">5.4.1.1 直接-快速失败</h4>
<blockquote>
<p><strong>阈值类型：QPS               单体阈值：1</strong></p>
<p><strong>流控模式：直接</strong></p>
<p><strong>流控效果：快速失败</strong></p>
<p>只要每秒超过2个请求，第二个请求就会触发快速失败，直接报错~</p>
</blockquote>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/a21baf974ef2402b97b11b66adc86378.png" alt="image.png"><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/c489603170e243cf948bdc25b23aadf4.png" alt="image.png"></p>
<h4 id="5-4-1-2-直接-WarmUp">5.4.1.2 直接-WarmUp</h4>
<blockquote>
<p><strong>阈值类型：QPS               单体阈值：10</strong></p>
<p><strong>流控模式：直接</strong></p>
<p><strong>流控效果：WarmUp</strong></p>
<p>接口并不会一开始就支撑10的QPS，慢慢的，经过一段时间，才会将QPS限制开放到10。</p>
</blockquote>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/89540f18ec834b0490d1c60defc03a3b.png" alt="image.png"></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/209ac1c4ee65423bb34de74920b97a79.png" alt="image.png"></p>
<h4 id="5-4-1-3-直接-排队等待">5.4.1.3 直接-排队等待</h4>
<blockquote>
<p><strong>阈值类型：QPS               单体阈值：2</strong></p>
<p><strong>流控模式：直接</strong></p>
<p><strong>流控效果：排队等待</strong></p>
<p>QPS限制为2的时候，他会匀速的每个500ms，放一个请求进去。</p>
</blockquote>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/95039968590345a5a2f89956886145ae.png" alt="image.png"><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/988f73b9c1884d8d9309879fe0796b28.png" alt="image.png"></p>
<h4 id="5-4-1-4-关联-快速失败">5.4.1.4 关联-快速失败</h4>
<blockquote>
<p><strong>阈值类型：QPS               单体阈值：2</strong></p>
<p><strong>流控模式：关联</strong></p>
<p><strong>流控效果：快速失败</strong></p>
<p>首先需要准备两个资源查看效果</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/info"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"info"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> info<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/add"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"add"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"add"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>给info资源设置QPS限制为1，关联的是add资源。 当频繁的访问add资源后，info就会被限制。</p>
</blockquote>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/c564ee78b7134fe8b71a2ff66d5acc65.png" alt="image.png"><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/d951c083d5a8426f9e5db3e940bab0d4.png" alt="image.png"></p>
<h4 id="5-4-1-5-链路-快速失败">5.4.1.5 链路-快速失败</h4>
<blockquote>
<p><strong>阈值类型：QPS               单体阈值：1</strong></p>
<p><strong>流控模式：链路</strong></p>
<p><strong>流控效果：快速失败</strong></p>
<p>需要准备三个资源，其中两个资源作为入口，另外一个资源作为公共资源被访问</p>
<p><strong>Ps：Controller中的方法默认就是资源，其次其他基于Spring管理的方法也可以作为资源，只是必须要追加上Sentinel的注解才可以。</strong></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Autowired</span>
<span class="token keyword">private</span> <span class="token class-name">OrderService</span> orderService<span class="token punctuation">;</span>

<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/aaa"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"aaa"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">aaa</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    orderService<span class="token punctuation">.</span><span class="token function">common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"aaa"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/bbb"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"bbb"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">bbb</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    orderService<span class="token punctuation">.</span><span class="token function">common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token string">"bbb"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// ====================公共资源=======================</span>
<span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">SentinelResource</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OrderService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">OrderService</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span><span class="token string">"common"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">common</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>发现设置好之后，资源的入口是统一的，就是 <strong>sentinel_spring_web_context，导致咱们现在没有办法针对某个入口单独做链路的限制</strong></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/23e03f63b425471aabd3314f1f7896b4.png" alt="image.png"></p>
<p>可以通过配置，将统一入口管理的模式关闭掉。就可以将每个Controller资源作为一个入口。</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">web-context-unify</span><span class="token punctuation">:</span> <span class="token boolean important">false</span></code></pre>
<p>追加完毕后，重新启动项目，查看簇点链路。</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/1959d3729ca9410c8f03feef64665a51.png" alt="image.png">controller中已经有入口资源顶头了，可以开始配置链路的效果了。</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/b7e83353cdeb47e7a561a0849929903e.png" alt="image.png"></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/35a62db47a494c74b5d9bd6c5b654e3d.png" alt="image.png">具体解决问题的issue地址：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/issues/1213">https://github.com/alibaba/Sentinel/issues/1213</a></p>
</blockquote>
<h3 id="5-4-2-并发线程数">5.4.2 并发线程数</h3>
<blockquote>
<p>因为流控里的QPS限制聊的模式基本都点到了。</p>
<p>这里的并发线程数看个效果即可。</p>
<p><strong>阈值类型：并发线程数               单体阈值：1</strong></p>
<p><strong>流控模式：直接</strong></p>
<p>这个资源内部只能有一个线程在处理，如果另外一个线程来了，需要排队等待。</p>
<p>为了查看效果，将代码的处理时间延长</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/info"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"info"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ============并发线程数==============</span>
    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> info<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
</blockquote>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/0efadf130ef044d8875b7bb684a1b7f8.png" alt="image.png"></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/764f98d24ebe4a6dae60374c2513bf4a.png" alt="image.png"></p>
<h2 id="5-5-熔断降级">5.5 熔断降级</h2>
<h3 id="5-5-1-熔断降级介绍">5.5.1 熔断降级介绍</h3>
<blockquote>
<p>服务雪崩：因为某一个服务出现问题，导致其他服务，甚至整个系统崩溃的情况，就可以称为服务雪崩</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/ee53cb8d384e4718b1738e0a1291cad6.png" alt="image.png"></p>
<p>为了解决这个服务雪崩的问题，可以上熔断、降级来解决这种服务雪崩问题</p>
<p><strong>降级：针对一些资源，提供一个降级的方法，当这个资源出现了一些问题时，可以快速失败，去执行降级方法，返回托底数据。</strong></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/d564d2f62a3341b193822c77002ee8ab.png" alt="image.png"></p>
<p><strong>熔断：就是针对某个资源提供断路器，有Closed，Open，Half Open状态。</strong></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/aa99318477e94a79924a5b2a8931f58d.png" alt="image.png"></p>
<p><strong>Ps：熔断和降级不是一个东西，熔断是触发降级的手段之一。</strong></p>
</blockquote>
<h3 id="5-5-2-熔断规则">5.5.2 熔断规则</h3>
<blockquote>
<p>Sentinel提供的熔断规则有三种</p>
<ul>
<li>
<p>慢调用比例：</p>
<ul>
<li>请求的响应时间，大于500ms，就被统计为慢调用。</li>
<li>在10s内，请求数量达到4个，开始统计熔断的阈值。</li>
<li>如果慢调用统计达到了请求量的50%，就会将断路器设置为Open状态，持续10s。</li>
<li>10s后，将断路器设置为Half Open状态，并放一个请求进来。
<ul>
<li>这个请求是慢调用，那就回到Open状态。</li>
<li>如果小于慢调用，设置为Closed状态。<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/573cc8ae2318482cbe809568c54de1d8.png" alt="image.png"></li>
</ul>
</li>
</ul>
</li>
<li>
<p>异常比例：</p>
<ul>
<li>资源访问出现异常，就认定是异常。</li>
<li>在10s内，请求数量达到4个，开始统计熔断的阈值。</li>
<li>如果异常统计达到了请求量的50%，就会将断路器设置为Open状态，持续10s。</li>
<li>10s后，将断路器设置为Half Open状态，并放一个请求进来。
<ul>
<li>这个请求出现异常，那就回到Open状态。</li>
<li>如果没异常，设置为Closed状态。<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/25c4eff218a04c7980269926fd1ef70e.png" alt="image.png"></li>
</ul>
</li>
</ul>
</li>
<li>
<p>异常数：</p>
<ul>
<li>资源访问出现异常，就认定是异常。</li>
<li>在10s内，请求数量达到4个，开始统计熔断的阈值。</li>
<li>如果异常统计达到了2个，就会将断路器设置为Open状态，持续10s。</li>
<li>10s后，将断路器设置为Half Open状态，并放一个请求进来。
<ul>
<li>这个请求出现异常，那就回到Open状态。</li>
<li>如果没异常，设置为Closed状态。<img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/a5cac238dfcd4d0d8558cba5f4f4d624.png" alt="image.png"></li>
</ul>
</li>
</ul>
</li>
</ul>
</blockquote>
<hr>
<blockquote>
<p>1、提供一套测试熔断效果资源，提供一个Controller</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// =================================熔断降级===========================</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/circuitbreaker"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"circuitbreaker"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">circuitbreaker</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
 <span class="token keyword">switch</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token keyword">case</span> <span class="token string">"1"</span><span class="token operator">:</span>
         <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token keyword">case</span> <span class="token string">"2"</span><span class="token operator">:</span>
         <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
 <span class="token punctuation">&#125;</span>

 <span class="token keyword">return</span> <span class="token string">"circuitbreaker - success!"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>2、启动项目开始测试！</p>
<p><strong>看视频查看测试效果！！！！！</strong></p>
</blockquote>
<h3 id="5-5-3-降级方法">5.5.3 降级方法</h3>
<h4 id="5-5-3-1-blockHandler">5.5.3.1 blockHandler</h4>
<blockquote>
<p>Sentinel中提供的降级处理是基于@SentinelResource注解来实现的。</p>
<p>@SentinelResource是基于AOP去实现的，So，需要让方法的访问修饰符是public。</p>
<p>@SentinelResource注解的属性内容比较多，咱一个一个看</p>
<ul>
<li><strong>blockHandler：</strong>
<ul>
<li>
<p>blockHandler是专门处理BlockException的降级方法，指定降级方法名。</p>
</li>
<li>
<p>降级方法需要public修饰</p>
</li>
<li>
<p>返回类型，方法参数要匹配，方法参数最后可以追加BlockException</p>
</li>
<li>
<p>降级方法跟原方法在一个类里</p>
<pre class="language-none"><code class="language-none">@GetMapping(&quot;&#x2F;order&#x2F;sentinel&quot;)
@SentinelResource(value &#x3D; &quot;sentinel&quot;,blockHandler &#x3D; &quot;sentinelBlock&quot;)
public String sentinel(@RequestParam String value) throws InterruptedException &#123;
    &#x2F;&#x2F; 业务代码………………
    return &quot;sentinel - success!&quot;;
&#125;
   
&#x2F;&#x2F; 是sentinel方法的降级方法，可以在方法逻辑中返回托底数据
public String sentinelBlock(String value, BlockException exception)&#123;
    String message &#x3D; null;
    if (exception instanceof FlowException)&#123;
        message &#x3D; &quot;流量控制！&quot;;
    &#125;else if (exception instanceof DegradeException)&#123;
        message &#x3D; &quot;熔断控制&quot;;
    &#125;
   
    return &quot;failed  msg &#x3D; &quot; + message.toString();
&#125;</code></pre>
</li>
</ul>
</li>
<li><strong>BlockHandlerClass：</strong>
<ul>
<li>
<p>这个属性和BlockHandler配合使用，可以将降级方法声明在其他类里</p>
<pre class="language-none"><code class="language-none">@GetMapping(&quot;&#x2F;order&#x2F;sentinel&quot;)
@SentinelResource(value &#x3D; &quot;sentinel&quot;,blockHandlerClass &#x3D; OrderControllerBlock.class,blockHandler &#x3D; &quot;sentinelBlock&quot;)
public String sentinel(@RequestParam String value) throws InterruptedException &#123;
    &#x2F;&#x2F; 业务代码………………
    return &quot;sentinel - success!&quot;;
&#125;
&#x2F;&#x2F; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;
public class OrderControllerBlock &#123;
   
    public static String sentinelBlock(String value, BlockException exception)&#123;
        String message &#x3D; null;
        if (exception instanceof FlowException)&#123;
            message &#x3D; &quot;流量控制！&quot;;
        &#125;else if (exception instanceof DegradeException)&#123;
            message &#x3D; &quot;熔断控制&quot;;
        &#125;
   
        return &quot;failed  msg &#x3D; &quot; + message.toString();
    &#125;
   
&#125;</code></pre>
</li>
</ul>
</li>
</ul>
<p><strong>BlockException：对应着Sentinel中的几种限制的方式：</strong></p>
<ul>
<li><strong>FlowException：流控</strong></li>
<li><strong>DegradeException：熔断</strong></li>
<li><strong>ParamFlowException：热点</strong></li>
<li><strong>SystemBlockException：系统</strong></li>
<li><strong>AuthorityException：权限</strong></li>
</ul>
</blockquote>
<hr>
<h4 id="5-5-3-2-fallback">5.5.3.2 fallback</h4>
<blockquote>
<p>fallback的使用跟blockHandler就是一模一样，但是blockHandler只处理BlockException。而fallback直接处理Throwable。</p>
<ul>
<li>fallback：指定降级方法名称</li>
<li>fallbackClass：指定降级方法所在的Class</li>
</ul>
<p><strong>Ps：若 blockHandler 和 fallback 都进行了配置，则被限流降级而抛出 <code>BlockException</code> 时只会进入 <code>blockHandler</code> 处理逻辑。</strong></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/sentinel"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"sentinel"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">"sentinelFallback"</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">"sentinelBlock"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sentinel</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token string">"1"</span><span class="token operator">:</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">"2"</span><span class="token operator">:</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token string">"sentinel - success!"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sentinelFallback</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">,</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"failed"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 是sentinel方法的降级方法，可以在方法逻辑中返回托底数据</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sentinelBlock</span><span class="token punctuation">(</span><span class="token class-name">String</span> value<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">FlowException</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        message <span class="token operator">=</span> <span class="token string">"流量控制！"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">DegradeException</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        message <span class="token operator">=</span> <span class="token string">"熔断控制"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token string">"failed  msg = "</span> <span class="token operator">+</span> message<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
</blockquote>
<hr>
<h4 id="5-5-3-3-defaultFallback-exceptionsToIgnore">5.5.3.3 defaultFallback&amp;exceptionsToIgnore</h4>
<blockquote>
<p>fallback只能针对单个资源去玩，defaultFallback可以针对全局。</p>
<ul>
<li>defaultFallback：指定默认的降级方法名称
<ul>
<li>返回结果依然要统一</li>
<li>参数列表要为空，可以额外追加一个Throwable</li>
</ul>
</li>
<li>fallbackClass：指定降级方法所在的Class</li>
</ul>
<p>exceptionsToIgnore是针对fallback的，可以忽略掉一些异常不走降级方法</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/sentinel"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"sentinel"</span><span class="token punctuation">,</span>defaultFallback <span class="token operator">=</span> <span class="token string">"defaultFallback"</span><span class="token punctuation">,</span>exceptionsToIgnore <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">ArithmeticException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">sentinel</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> value<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token string">"1"</span><span class="token operator">:</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string">"2"</span><span class="token operator">:</span>
            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">return</span> <span class="token string">"sentinel - success!"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//==================默认的fallback=======================</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">defaultFallback</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"failed msg = "</span> <span class="token operator">+</span> ex<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
</blockquote>
<h2 id="5-6-热点规则（了解）">5.6 热点规则（了解）</h2>
<blockquote>
<p>热点规则也属于流控的范畴。</p>
<p>因为流控规则是针对整个资源直接做一些限制。</p>
<p>而热点规则可以针对某一个字段中的参数做一些更细粒度化的流控。</p>
<p>Sentinel可以根据资源内传入的指定参数，来做热点参数的限流，Sentinel会帮你统计单位时间内这个参数值请求的次数 <strong>（利用LRU + 滑动时间窗口）</strong> ，再利用 <strong>令牌桶</strong> 来实现具体的限流操作。</p>
<p>为了查看效果，需要提供一个资源，接收俩个参数~</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">//==================热点规则=======================</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/hot"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"hot"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">hot</span><span class="token punctuation">(</span><span class="token class-name">String</span> userId<span class="token punctuation">,</span><span class="token class-name">Integer</span> type<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"userId:"</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">",type:"</span> <span class="token operator">+</span> type<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
</blockquote>
<hr>
<blockquote>
<p>根据上述编写的资源，根据userId作为限流的参数。</p>
<p>当userId值传递的一样时，Sentinel会统计好次数，基于QPS的方式做限制。</p>
<p>在 <strong>统计窗口时长</strong> 时 ，当然 <strong>热点参数值</strong> 最多可以请求 <strong>单击阈值</strong> 次，超过了就异常！</p>
</blockquote>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/f4052d20aa9743fd95d8e609b4346814.png" alt="image.png"></p>
<hr>
<blockquote>
<p>可以针对参数的具体值，再做更细粒度化的限制！</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/e9f9527343904ff99d9a236ae4ec1621.png" alt="image.png"></p>
</blockquote>
<hr>
<blockquote>
<p>测试了一波Sentinel热点规则对于接受参数的形式</p>
<ul>
<li>默认资源内基于单个类型的参数接收是没问题的，包括@RequestParam，@PathVariable</li>
<li>默认如果采用对象的形式接收参数，热点规则没法生效……</li>
</ul>
</blockquote>
<h2 id="5-7-授权规则（了解）">5.7 授权规则（了解）</h2>
<blockquote>
<p>所谓的授权规则，其实就是针对某一个资源的调用方的身份做验证。</p>
<p>可以指定黑、白名单（指定一个），只要满足要求才会放行请求，否则会被拦截。</p>
<p>优先准备一个资源来测试。</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">//==================授权规则=======================</span>
<span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/author"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"author"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">author</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> <span class="token string">"author!"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>设置好黑白名单后，发现无法生效。</p>
<p>当然服务资源在做黑白明显的限制规则时，Sentinel会基于拦截器内部调用RequestOriginParser的实现类去获取请求来源的具体身份信息。因为没有默认实现的，在这种情况下，他返回的都是空串。</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/1b2e76913e304fb491937a81e8d61c3f.png" alt="image.png"></p>
<p>那咱们需要主动实现一个RequestOriginParser实现类，直接基于请求头获取origin中的信息作为调用方的身份。</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>author</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>webmvc<span class="token punctuation">.</span>callback<span class="token punctuation">.</span></span><span class="token class-name">RequestOriginParser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SentinelOriginParser</span> <span class="token keyword">implements</span> <span class="token class-name">RequestOriginParser</span> <span class="token punctuation">&#123;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">parseOrigin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">String</span> origin <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">"origin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> origin<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>编写后之后，在postman中发送请求，在请求头中追加了origin信息，携带上了身份，然后实现了授权的规则校验。</p>
<p>获取调用方身份是基于SentinelOriginParser拿到的，而校验的方式就是基于indexOf查看Sentinel中设置的授权的黑白名单身份是否包含了SentinelOriginParser获取的信息。</p>
</blockquote>
<h2 id="5-8-系统规则（了解）">5.8 系统规则（了解）</h2>
<blockquote>
<p>系统规则不是针对某一个资源去做限制，而是针对整个服务的所有资源统一的做一些限制。</p>
<p>系统规则的目的是让整个系统保持可用，并且不会因为某一些资源的激增流量导致整个系统被压垮。</p>
<p>系统规则支持以下的模式：</p>
<ul>
<li><strong>Load 自适应</strong> （仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</li>
<li><strong>CPU usage</strong> （1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li>
<li><strong>平均 RT</strong> ：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li>
<li><strong>并发线程数</strong> ：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li>
<li><strong>入口 QPS</strong> ：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。5.9 Sentinel持久化</li>
</ul>
</blockquote>
<h2 id="5-9-动态规则、持久化">5.9 动态规则、持久化</h2>
<blockquote>
<p>在Sentinel的图形化界面中配置的各种规则，都是存储在内存里的，之前配置的各种规则就全么得了。</p>
<p>不可能每次项目重启后，都去重新指定这些规则，成本太高了。</p>
<p>Sentinel也支持将一些规则持久化到某个DataSource。DataSource的种类很多。大概分为了两种</p>
<ul>
<li>拉模式：客户端主动去查看是否变化，缺点是无法及时获取变更。</li>
<li>推模式：DataSource主动去通知客户端变化的内容，有更好的实时性和一致性保证。</li>
</ul>
<p>其中Nacos就是推模式的一种实现，直接基于Nacos来持久化Sentinel中的规则。</p>
</blockquote>
<hr>
<blockquote>
<p>实现步骤：</p>
<p>1、导入依赖</p>
<pre class="language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.csp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>sentinel-datasource-nacos<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></code></pre>
<p>2、编写配置</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
        <span class="token key atrule">flow</span><span class="token punctuation">:</span>
          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span>spring.cloud.nacos.config.server<span class="token punctuation">-</span>addr<span class="token punctuation">&#125;</span>
            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> SENTINEL_GROUP
            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span>spring.application.name<span class="token punctuation">&#125;</span><span class="token punctuation">-</span>flow.json
            <span class="token key atrule">data-type</span><span class="token punctuation">:</span> json
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> flow</code></pre>
<p>3、Nacos中构建配置，编写规则，想编写这个内容</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/2108e7e7b55f4ef688d3917940131ec0.png" alt="image.png"></p>
<p>Nacos的配置</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/8f1678597bff436d9cd50ad745893866.png" alt="image.png"></p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"info"</span><span class="token punctuation">,</span>
        <span class="token property">"limitApp"</span><span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span>
        <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">"count"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token property">"strategy"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token property">"controlBehavior"</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span></code></pre>
</blockquote>
<hr>
<blockquote>
<p>配置熔断规则的套路</p>
<p>1、依赖导入</p>
<p>…………</p>
<p>2、yml配置</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
        <span class="token key atrule">degrade</span><span class="token punctuation">:</span>
          <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
            <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span>spring.cloud.nacos.config.server<span class="token punctuation">-</span>addr<span class="token punctuation">&#125;</span>
            <span class="token key atrule">group-id</span><span class="token punctuation">:</span> SENTINEL_GROUP
            <span class="token key atrule">data-id</span><span class="token punctuation">:</span> $<span class="token punctuation">&#123;</span>spring.application.name<span class="token punctuation">&#125;</span><span class="token punctuation">-</span>degrade.json
            <span class="token key atrule">data-type</span><span class="token punctuation">:</span> json
            <span class="token key atrule">rule-type</span><span class="token punctuation">:</span> degrade</code></pre>
<p>3、Nacos的配置</p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/9a2b346d2e974d76844d9568b602ac89.png" alt="image.png"></p>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/57c4a091f4ac4a5d85ecc311a323388c.png" alt="image.png"></p>
<pre class="language-json" data-language="json"><code class="language-json"><span class="token punctuation">[</span>
    <span class="token punctuation">&#123;</span>
        <span class="token property">"resource"</span><span class="token operator">:</span> <span class="token string">"info"</span><span class="token punctuation">,</span>
        <span class="token property">"grade"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">"count"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token property">"timeWindow"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
        <span class="token property">"minRequestAmount"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token property">"statIntervalMs"</span><span class="token operator">:</span> <span class="token number">10000</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">]</span></code></pre>
</blockquote>
<h2 id="5-10-OpenFeign整合Sentinel">5.10 OpenFeign整合Sentinel</h2>
<blockquote>
<p>OpenFeign整合Sentinel的目的其实就是针对基于OpenFeign去访问其他服务时，如果出来了任何的问题，不要抛出异常，而是走降级方法，返回托底数据。</p>
<p>1、需要编写配置文件，开启OpenFeign跟Sentinel的整合</p>
<pre class="language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">feign</span><span class="token punctuation">:</span>
  <span class="token key atrule">circuitbreaker</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></code></pre>
<p>2、构建Feign接口的实现类，重写Feign接口的方法（重写的方法就是降级方法）</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>client<span class="token punctuation">.</span>fallback</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">StockClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">StockClientFallback</span> <span class="token keyword">implements</span> <span class="token class-name">StockClient</span> <span class="token punctuation">&#123;</span>
  
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token string">"test的降级方法，服务器正忙，请稍后再试！！"</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>3、在Feign接口中指定@FeignClient的fallback属性</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"stock"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">StockClientFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">StockClient</span> <span class="token punctuation">&#123;</span></code></pre>
<p><img src="https://fynotefile.oss-cn-zhangjiakou.aliyuncs.com/fynote/fyfile/2746/1742210442039/e288e468159d400bbde24ae6581bd691.png" alt="image.png"></p>
<p>有同学会有疑问，这样OpenFeign不就有俩实现类在Spring容器中了么？ Spring怎么知道到底注入哪一个。其实OpenFeign是基于@FeignClient中的primary属性，指定了Feign接口的代理对象作为咱们注入的主要对象。</p>
<p>至于FallbackFactory就不实现了，大概知道可以利用fallback或者fallbackFactory两种形式，不过都是基于构建Feign接口实现类去玩的。</p>
</blockquote>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src="https://img.soniachen.com/IMG_0151.JPG" title="头像" alt="头像"><img class="post-copyright__author_img_front" src="https://img.soniachen.com/IMG_0151.JPG" title="头像" alt="头像"></a><div class="post-copyright__author_name">SoniaChen</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.soniachen.com/2024/09/10/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-SpringCloud/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.soniachen.com/2024/09/10/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-SpringCloud/')">微服务技术栈</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://img.soniachen.com/blog/IMG_5543.JPG" target="_blank"><img class="post-qr-code-img" src="https://img.soniachen.com/blog/IMG_5543.JPG" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://img.soniachen.com/blog/IMG_5544.JPG" target="_blank"><img class="post-qr-code-img" src="https://img.soniachen.com/blog/IMG_5544.JPG" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.soniachen.com/2024/09/10/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-SpringCloud/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=微服务技术栈&amp;url=https://blog.soniachen.com/2024/09/10/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%8A%80%E6%9C%AF%E6%A0%88-SpringCloud/&amp;pic=https://img.soniachen.com/IMG_5493.jpg?_r_=1e00c770-98e4-1b33-6d57-241b89e1c2b1" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.soniachen.com" target="_blank">Sonia33</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/Sentinel/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Sentinel<span class="tagsPageCount">2</span></a><a class="post-meta__box__tags" href="/tags/Nacos/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>Nacos<span class="tagsPageCount">1</span></a><a class="post-meta__box__tags" href="/tags/OpenFeign/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>OpenFeign<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://img.soniachen.com/blog/posts/2025/07/image-20250713200224069.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/06/17/%E7%BC%93%E5%AD%98%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81_/"><img class="prev-cover" src="https://img.soniachen.com/IMG_5493.jpg?_r_=7d5ad408-1e01-ff56-d222-661f8943e3a9" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">缓存和分布式锁</div></div></a></div><div class="next-post pull-right"><a href="/2025/04/06/Redis%E3%80%81MQ%E7%9A%84%E9%A1%B9%E7%9B%AE%E8%BF%90%E7%94%A8/"><img class="next-cover" src="https://img.soniachen.com/IMG_5493.jpg?_r_=4cead66b-6b37-1259-dcb3-7039ccefa492" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis与MQ在项目中的运用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="anzhiyufont anzhiyu-icon-thumbs-up fa-fw" style="font-size: 1.5rem; margin-right: 4px"></i><span>喜欢这篇文章的人也看了</span></div><div class="relatedPosts-list"><div><a href="/2024/03/17/23-Sentinel/" title="Sentinel"><img class="cover" src="https://img.soniachen.com/IMG_5493.jpg?_r_=ecb84a0b-8803-8f48-2993-5c63612e2191" alt="cover"><div class="content is-center"><div class="date"><i class="anzhiyufont anzhiyu-icon-calendar-days fa-fw"></i> 2024-03-17</div><div class="title">Sentinel</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">一、微服务架构介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1-%E6%9E%B6%E6%9E%84%E6%BC%94%E5%8F%98"><span class="toc-number">1.1.</span> <span class="toc-text">1.1 架构演变</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1-2-SpringCloud%E7%94%9F%E6%80%81"><span class="toc-number">1.2.</span> <span class="toc-text">1.2 SpringCloud生态</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">二、Nacos注册中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#2-1-%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83"><span class="toc-number">2.1.</span> <span class="toc-text">2.1 注册中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-2-Nacos%E5%AE%89%E8%A3%85"><span class="toc-number">2.2.</span> <span class="toc-text">2.2 Nacos安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-3-Nacos%E5%88%9D%E4%BD%93%E9%AA%8C%EF%BC%88%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%EF%BC%89"><span class="toc-number">2.3.</span> <span class="toc-text">2.3 Nacos初体验（注册中心）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-1-%E6%9E%84%E5%BB%BA%E7%88%B6%E5%B7%A5%E7%A8%8B%E5%B9%B6%E7%AE%A1%E7%90%86%E7%89%88%E6%9C%AC"><span class="toc-number">2.3.1.</span> <span class="toc-text">2.3.1 构建父工程并管理版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-2-%E5%87%86%E5%A4%87%E5%BA%93%E5%AD%98%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.3.2.</span> <span class="toc-text">2.3.2 准备库存服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-3-%E5%87%86%E5%A4%87%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.3.3.</span> <span class="toc-text">2.3.3 准备订单服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-4-%E5%BA%93%E5%AD%98%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.3.4.</span> <span class="toc-text">2.3.4 库存服务提供接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-5-%E8%AE%A2%E5%8D%95%E6%9C%8D%E5%8A%A1%E5%87%86%E5%A4%87%E6%8E%A5%E5%8F%A3%E8%AE%BF%E9%97%AE%E5%BA%93%E5%AD%98%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.3.5.</span> <span class="toc-text">2.3.5 订单服务准备接口访问库存服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4-%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%92%8C%E5%88%86%E7%BB%84%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">2.4.</span> <span class="toc-text">2.4 命名空间和分组（了解）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-5-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">2.5.</span> <span class="toc-text">2.5 负载均衡（了解）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">三、Nacos配置中心</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#3-1-%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83"><span class="toc-number">3.1.</span> <span class="toc-text">3.1 配置中心</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-2-Nacos%E5%88%9D%E4%BD%93%E9%AA%8C%EF%BC%88%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%EF%BC%89"><span class="toc-number">3.2.</span> <span class="toc-text">3.2 Nacos初体验（配置中心）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%92%8C%E5%88%86%E7%BB%84%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">3.3 命名空间和分组（了解）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-%E9%85%8D%E7%BD%AE%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0"><span class="toc-number">3.4.</span> <span class="toc-text">3.4 配置动态刷新</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">四、OpenFeign</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-OpenFeign%E4%BB%8B%E7%BB%8D"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 OpenFeign介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-OpenFeign%E7%9A%84%E5%88%9D%E4%BD%93%E9%AA%8C"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 OpenFeign的初体验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-OpenFeign%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 OpenFeign配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-1-OpenFeign%E7%9A%84%E8%B6%85%E6%97%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">4.3.1.</span> <span class="toc-text">4.3.1 OpenFeign的超时配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-2-OpenFeign%E7%9A%84%E5%BA%95%E5%B1%82%E6%8A%80%E6%9C%AF"><span class="toc-number">4.3.2.</span> <span class="toc-text">4.3.2 OpenFeign的底层技术</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">五、Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-Sentinel%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.1.</span> <span class="toc-text">5.1 Sentinel介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-Sentinel%E5%AE%89%E8%A3%85"><span class="toc-number">5.2.</span> <span class="toc-text">5.2 Sentinel安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-Sentinel%E5%88%9D%E4%BD%93%E9%AA%8C"><span class="toc-number">5.3.</span> <span class="toc-text">5.3 Sentinel初体验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-number">5.4.</span> <span class="toc-text">5.4 流控规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-1-QPS%E9%99%90%E5%88%B6"><span class="toc-number">5.4.1.</span> <span class="toc-text">5.4.1 QPS限制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-1-%E7%9B%B4%E6%8E%A5-%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">5.4.1.1 直接-快速失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-2-%E7%9B%B4%E6%8E%A5-WarmUp"><span class="toc-number">5.4.1.2.</span> <span class="toc-text">5.4.1.2 直接-WarmUp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-3-%E7%9B%B4%E6%8E%A5-%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-number">5.4.1.3.</span> <span class="toc-text">5.4.1.3 直接-排队等待</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-4-%E5%85%B3%E8%81%94-%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="toc-number">5.4.1.4.</span> <span class="toc-text">5.4.1.4 关联-快速失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-4-1-5-%E9%93%BE%E8%B7%AF-%E5%BF%AB%E9%80%9F%E5%A4%B1%E8%B4%A5"><span class="toc-number">5.4.1.5.</span> <span class="toc-text">5.4.1.5 链路-快速失败</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-2-%E5%B9%B6%E5%8F%91%E7%BA%BF%E7%A8%8B%E6%95%B0"><span class="toc-number">5.4.2.</span> <span class="toc-text">5.4.2 并发线程数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-5-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7"><span class="toc-number">5.5.</span> <span class="toc-text">5.5 熔断降级</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-1-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.5.1.</span> <span class="toc-text">5.5.1 熔断降级介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-2-%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99"><span class="toc-number">5.5.2.</span> <span class="toc-text">5.5.2 熔断规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-3-%E9%99%8D%E7%BA%A7%E6%96%B9%E6%B3%95"><span class="toc-number">5.5.3.</span> <span class="toc-text">5.5.3 降级方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-3-1-blockHandler"><span class="toc-number">5.5.3.1.</span> <span class="toc-text">5.5.3.1 blockHandler</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-3-2-fallback"><span class="toc-number">5.5.3.2.</span> <span class="toc-text">5.5.3.2 fallback</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-5-3-3-defaultFallback-exceptionsToIgnore"><span class="toc-number">5.5.3.3.</span> <span class="toc-text">5.5.3.3 defaultFallback&amp;exceptionsToIgnore</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-6-%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">5.6.</span> <span class="toc-text">5.6 热点规则（了解）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-7-%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">5.7.</span> <span class="toc-text">5.7 授权规则（了解）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-8-%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99%EF%BC%88%E4%BA%86%E8%A7%A3%EF%BC%89"><span class="toc-number">5.8.</span> <span class="toc-text">5.8 系统规则（了解）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-9-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%99%E3%80%81%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">5.9.</span> <span class="toc-text">5.9 动态规则、持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-10-OpenFeign%E6%95%B4%E5%90%88Sentinel"><span class="toc-number">5.10.</span> <span class="toc-text">5.10 OpenFeign整合Sentinel</span></a></li></ol></li></ol></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="/soniachan0831@gmail.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/6378063631" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src="https://img.soniachen.com/IMG_0151.JPG" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/SoniaChan33" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/360939620" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div class="copyright">&copy;2021 - 2025 By SoniaChen</div><div id="workboard"><div id="runtimeTextTip"></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a></p></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">38</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">39</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">17</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.soniachen.com/" title="博客"><img class="back-menu-item-icon" src="https://img.soniachen.com/%E9%92%A2%E9%93%81%E8%9C%98%E8%9B%9B%E4%BE%A0.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=447363601&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BlockChain/" style="font-size: 0.88rem;">BlockChain<sup>4</sup></a><a href="/tags/CSS/" style="font-size: 0.88rem;">CSS<sup>1</sup></a><a href="/tags/CloudFlare/" style="font-size: 0.88rem;">CloudFlare<sup>2</sup></a><a href="/tags/DataBase/" style="font-size: 0.88rem;">DataBase<sup>2</sup></a><a href="/tags/FastDFS/" style="font-size: 0.88rem;">FastDFS<sup>1</sup></a><a href="/tags/Foundry/" style="font-size: 0.88rem;">Foundry<sup>1</sup></a><a href="/tags/Git/" style="font-size: 0.88rem;">Git<sup>2</sup></a><a href="/tags/HTML/" style="font-size: 0.88rem;">HTML<sup>1</sup></a><a href="/tags/IO/" style="font-size: 0.88rem;">IO<sup>1</sup></a><a href="/tags/JDBC/" style="font-size: 0.88rem;">JDBC<sup>1</sup></a><a href="/tags/JQuery/" style="font-size: 0.88rem;">JQuery<sup>1</sup></a><a href="/tags/Java/" style="font-size: 0.88rem;">Java<sup>3</sup></a><a href="/tags/JavaScript/" style="font-size: 0.88rem;">JavaScript<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>1</sup></a><a href="/tags/MQ/" style="font-size: 0.88rem;">MQ<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 0.88rem;">MySQL<sup>2</sup></a><a href="/tags/Nacos/" style="font-size: 0.88rem;">Nacos<sup>1</sup></a><a href="/tags/NoSQL/" style="font-size: 0.88rem;">NoSQL<sup>1</sup></a><a href="/tags/OpenFeign/" style="font-size: 0.88rem;">OpenFeign<sup>1</sup></a><a href="/tags/PicGo/" style="font-size: 0.88rem;">PicGo<sup>1</sup></a><a href="/tags/RabbitMQ/" style="font-size: 0.88rem;">RabbitMQ<sup>1</sup></a><a href="/tags/Redis/" style="font-size: 0.88rem;">Redis<sup>2</sup></a><a href="/tags/Rust/" style="font-size: 0.88rem;">Rust<sup>6</sup></a><a href="/tags/Sentinel/" style="font-size: 0.88rem;">Sentinel<sup>2</sup></a><a href="/tags/Solidity/" style="font-size: 0.88rem;">Solidity<sup>4</sup></a><a href="/tags/Typora/" style="font-size: 0.88rem;">Typora<sup>1</sup></a><a href="/tags/Zookeeper/" style="font-size: 0.88rem;">Zookeeper<sup>1</sup></a><a href="/tags/hexo/" style="font-size: 0.88rem;">hexo<sup>3</sup></a><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>1</sup></a><a href="/tags/macOS/" style="font-size: 0.88rem;">macOS<sup>2</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 0.88rem;">分布式<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 0.88rem;">分布式锁<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 0.88rem;">后端<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem;">多线程<sup>1</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 0.88rem;">测试<sup>1</sup></a><a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 0.88rem;">缓存<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>1</sup></a><a href="/tags/%E8%B8%A9%E9%9B%B7/" style="font-size: 0.88rem;">踩雷<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="447363601" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=447363601&amp;userid=321481294&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2021 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 SoniaChen 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("04/01/2021 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "";
        img.title = "";
        img.alt = "";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-cloudflare.soniachan0831.workers.dev',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-cloudflare.soniachan0831.workers.dev',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo-cloudflare.soniachan0831.workers.dev',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "visitor@soniachen.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="Don't,Click,Me" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>