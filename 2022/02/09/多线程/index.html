<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"><title>多线程 | Sonia33</title><meta name="keywords" content="多线程"><meta name="author" content="SoniaChen"><meta name="copyright" content="SoniaChen"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#f7f9fe"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-touch-fullscreen" content="yes"><meta name="apple-mobile-web-app-title" content="多线程"><meta name="application-name" content="多线程"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f7f9fe"><meta property="og:type" content="article"><meta property="og:title" content="多线程"><meta property="og:url" content="https://blog.soniachen.com/2022/02/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B/index.html"><meta property="og:site_name" content="Sonia33"><meta property="og:description" content="并发编程三大特性 可见性 MESI 多线程的底层并不是通过mesi 多线程提高效率，本地缓存数据，造成数据修改不可见， 要想保证可见，要么触发同步指令，要么加上volatile，被修饰的内存，只要有修改，马上同步涉及到的每个线程。  &amp;#x3D;&amp;#x3D;volatile&amp;#x3D;&amp;#x3D; &amp;#x3D;&amp;#x3D;介绍一下volatile的功能？&amp;#x3D;&amp;#x3D;"><meta property="og:locale" content="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><meta property="og:image" content="https://img.soniachen.com/IMG_5493.jpg?_r_=ec673246-ce76-5933-0085-b53e89e196be"><meta property="article:author" content="SoniaChen"><meta property="article:tag"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://img.soniachen.com/IMG_5493.jpg?_r_=ec673246-ce76-5933-0085-b53e89e196be"><meta name="description" content="并发编程三大特性 可见性 MESI 多线程的底层并不是通过mesi 多线程提高效率，本地缓存数据，造成数据修改不可见， 要想保证可见，要么触发同步指令，要么加上volatile，被修饰的内存，只要有修改，马上同步涉及到的每个线程。  &amp;#x3D;&amp;#x3D;volatile&amp;#x3D;&amp;#x3D; &amp;#x3D;&amp;#x3D;介绍一下volatile的功能？&amp;#x3D;&amp;#x3D;"><link rel="shortcut icon" href="https://img.soniachen.com/%E9%92%A2%E9%93%81%E8%9C%98%E8%9B%9B%E4%BE%A0.png"><link rel="canonical" href="https://blog.soniachen.com/2022/02/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><link rel="preconnect" href="//cdn.cbd.int"/><meta name="google-site-verification" content="xxx"/><meta name="baidu-site-verification" content="code-xxx"/><meta name="msvalidate.01" content="xxx"/><link rel="manifest" href="/manifest.json"/><meta name="msapplication-TileColor" content="var(--anzhiyu-main)"/><link rel="mask-icon" href="/img/siteicon/apple-icon-180.png" color="#5bbad5"/><link rel="apple-touch-icon" sizes="180x180" href="/img/siteicon/apple-icon-180.png"/><link rel="apple-touch-icon-precomposed" sizes="180x180" href="/img/siteicon/apple-icon-180.png"/><link rel="icon" type="image/png" sizes="32x32" href="/img/siteicon/32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/img/siteicon/16.png"/><link rel="bookmark" href="/img/siteicon/apple-icon-180.png"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1290-2796.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2796-1290.jpg" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1179-2556.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2556-1179.jpg" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)"/><link rel="apple-touch-startup-image" href="/img/siteicon/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/swiper/swiper.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  linkPageTop: undefined,
  peoplecanvas: undefined,
  postHeadAiDescription: {"enable":true,"gptName":"sonia33","mode":"local","switchBtn":false,"btnLink":"https://afdian.net/item/886a79d4db6711eda42a52540025c377","randomNum":3,"basicWordCount":1000,"key":"xxxx","Referer":"https://xx.xx/"},
  diytitle: undefined,
  LA51: undefined,
  greetingBox: {"enable":true,"default":"晚上好👋","list":[{"greeting":"晚安😴","startTime":0,"endTime":5},{"greeting":"早上好鸭👋, 祝你一天好心情！","startTime":6,"endTime":9},{"greeting":"上午好👋, 状态很好，鼓励一下～","startTime":10,"endTime":10},{"greeting":"11点多啦, 在坚持一下就吃饭啦～","startTime":11,"endTime":11},{"greeting":"午安👋, 宝贝","startTime":12,"endTime":14},{"greeting":"🌈充实的一天辛苦啦！","startTime":14,"endTime":18},{"greeting":"19点喽, 奖励一顿丰盛的大餐吧🍔。","startTime":19,"endTime":19},{"greeting":"晚上好👋, 在属于自己的时间好好放松😌~","startTime":20,"endTime":24}]},
  twikooEnvId: 'https://twikoo-cloudflare.soniachan0831.workers.dev',
  commentBarrageConfig:undefined,
  music_page_default: "nav_music",
  root: '/',
  preloader: {"source":3},
  friends_vue_info: undefined,
  navMusic: true,
  mainTone: undefined,
  authorStatus: {"skills":["🤖️ 数码科技爱好者","🔍 分享与热心帮助","📖 读万卷书","🧗 徒步爱好者","🏀 篮球狂热爱好者","🚴 公路车爱好者","🏃 跑步爱好者"]},
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简","rightMenuMsgToTraditionalChinese":"转为繁体","rightMenuMsgToSimplifiedChinese":"转为简体"},
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":330},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    simplehomepage: true,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"copy":true,"copyrightEbable":false,"limitCount":50,"languages":{"author":"作者: SoniaChen","link":"链接: ","source":"来源: Sonia33","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。","copySuccess":"复制成功，复制和转载请标注本文地址"}},
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#425AEF","bgDark":"#1f1f1f","position":"bottom-right"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.min.js',
      css: 'https://cdn.cbd.int/flickr-justified-gallery@2.1.2/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  shortcutKey: undefined,
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  configTitle: 'Sonia33',
  title: '多线程',
  postAI: '',
  pageFillDescription: '并发编程三大特性, 可见性, ==volatile==, ==介绍一下volatile的功能？==, ==volatile的可见性和禁止指令重排序怎么实现的？==, ==volatile 的底层实现？==, ==实现一下DCL(单例模式下的双重检查)/ volatile的实践==, ==单例里面要不要加volatile？==, 有序性, 程序真的是按照顺序执行的吗？, 单线程也不是顺序执行, 原子性, CAS, ==CAS底层==, ==如何解决ABA问题==, 线程调度与同步, 线程调度器, 怎么进行多线程抢占cpu的调度呢？（线程调度算法, 线程同步以及线程调度方, sleep() 和 wait() 不同, sleep()和yeild() 不同, sleep()和yeild()为啥是静态, ==wait() 和 notify()实际使用==, 描述notify和notifyAll区别, 如何唤醒线程？, 为什么三个方法要定义在object里？, 为什么三个方法要在同步方法或者代码块里面调用？, 什么是线程同步？, 同步方法和非同步方法可以同时调用吗？, 什么是线程互斥？, Synchronized, synchronized、volatile、CAS 比较, ==synchronized 和 ReentrantLock 区别是什么？==, 锁的是什么?, 锁重入？, ==Sych的锁升级的原理或者是过程？==, 详细锁升级过程：, 什么时候用自旋锁和系统锁？/ 为什么有了自旋锁还要重量级锁？, 什么时候升级为重量级锁？, 偏向锁是否启动？, Lock体系, Java Concurrency API 中的 Lock 接口(Lock interface)是什么？对比同步它有什么优势？, ==实现一个阻塞队列？/ 使用Condition写生产者和消费者？==, AQS, AQS 原理分析, AQS 原理概览, 源码, state状态变量, AQS队列, 资源的共享方式, 模版方法, 并发工具类, CountDownLatch(倒计时器)：, 用法？, CyclicBarrier(循环栅栏)：, Semaphore(信号量)-允许多个线程同时访问：, Exchange(线程见交换数据的工具), ReadWriteLock, ThreadLocal, 原理, 用途, 四种引用, 引用是什么？, 强引用normalReference, 弱引用softReference, 虚引用, ==在threadlocal的应用 / 内存泄露==, JUC同步容器, ConcurrentHashMap, CopyOnWriteArrayList, CopyOnWriteArrayList 是什么可以用于什么应用场景？有哪些优缺点？, BlockingQueue, ArrayBlockingQueue, Queue和List的区别, 线程池, Executor(线程的工厂, newSingleThreadPool, newCachedThreadPool没上限, newFixedThreadPool 固定的, newScheduledThreadPool定时任务, ThreadPoolExecutor, 1. 状态, 2. 构造方法参数, 3. execute()调度任务, 4. addWorker()—gtrunWorker(), work类, submit()和execute()区别, 杂问题, 1. 怎么预防死锁？, 2. 线程创建方式和生命周期, start 和 run, 线程生命周期和五种状态, 3. 进程与线程的区别, 4. 并发与并行, 5. 程序开多少线程合适/是不是线程数越高效率越高/, 单个cpu设定多线程有没有意义？结合上面, 6.如何结束一个线程？, interrupt和isInterrupt(), 7. 线程类的构造方法、静态块是被哪个线程调用的？, 8. 线程安全活跃态？, 9. 1～26和a~b顺序交替打印, 1.LockSupport, 2. wait() 和 notify(), 10. 多线程之间是怎么通信的？, 11. 生产者消费者模型?, Condition 阻塞队列, wait() 和 notify()并发编程三大特性可见性多线程的底层并不是通过多线程提高效率本地缓存数据造成数据修改不可见要想保证可见要么触发同步指令要么加上被修饰的内存只要有修改马上同步涉及到的每个线程介绍一下的功能关键字保证了可见性和禁止指令重排提供了的保证确保一个线程的修改可以对其他线程是可见的当一个共享变量被修饰的时候就会保证修改的值立即被更新到内存当其他线程需要读取的时候就会去内存中读取新值从实际角度来说其中的一个重要作用就是与结合保证了原子性经常用在多线程环境下的单次操作通俗来讲就是线程要用一个变量然后默认是线程中保留一份这样如果线程来修改则线程未必知道如果使用这个关键字线程之间数据修改都能可见的可见性和禁止指令重排序怎么实现的本质上是通过内存屏障来实现可见性的被修饰的变量在被修改之后可以立即同步到主内存该变量每次使用之前都从主内存刷新而禁止指令重排序也是通过内存屏障来禁止的本来现在的为了提高效率会见指令并发执行一个指令从内存屏障的策略来看就是在的写操作的前面插入一个屏障后面插入一个在读操作前面加入一个后面加一个屏障的底层实现底层实现一下单例模式下的双重检查的实践是否化是是否线程安全是实现难度针对需要双重检查的操作防止指令重排第一层判断是不是现在再加锁第二层判断如果两个线程都在等待创建完对象之后还会再进入如果不再检查一遍又会创建一个对象单例里面要不要加要加如果不加问题就会出现在指令重排序上比如有一行初始化对象的代码被编译器执行之后就会分成三步给指令申请内存给成员变量初始化把这块内存的内容赋值重排序以后既然已经有这个值在另外一个线程上来先去检查就会发现已经存在该值就不会进入锁部分的代码但是加了就不会允许指令重排序一定会保证你初始化完了才会给你赋值这个变量有序性程序真的是按照顺序执行的吗并不是为了提高效率通常都是乱序在执行程序时为了提供性能处理器和编译器常常会对指令进行重排序但是不能随意重排序不是你想怎么排序就怎么排序它需要满足以下两个条件在单线程环境下不能改变程序运行的结果存在数据依赖关系的不允许重排序需要注意的是重排序不会影响单线程环境的执行结果但是会破坏多线程的执行语义单线程也不是顺序执行单线程有一个语义保证了其单线程执行结果不被改变其实也不是顺序执行的语义保证单线程内程序的执行结果不被改变关系保证正确同步的多线程程序的执行结果不被改变语义给编写单线程程序的程序员创造了一个幻境单线程程序是按程序的顺序来执行的关系给编写正确同步的多线程程序的程序员创造了一个幻境正确同步的多线程程序是按指定的顺序来执行的语义和这么做的目的都是为了在不改变程序执行结果的前提下尽可能地提高程序执行的并行度原子性保证操作的原子性可以通过悲观锁和乐观锁是的缩写即我们所说的比较交换是一种基于锁的操作而且是乐观锁在中锁分为乐观锁和悲观锁悲观锁是将资源锁住等一个之前获得锁的线程释放锁之后下一个线程才可以访问而乐观锁采取了一种宽泛的态度通过某种方式不加锁来处理资源比如通过给记录加来获取数据性能较悲观锁有很大的提高操作包含三个操作数内存位置预期原值和新值如果内存地址里面的值和的值是一样的那么就将内存里面的值更新成是通过无限循环来获取数据的若果在第一轮循环中线程获取地址里面的值被线程修改了那么线程需要自旋到下次循环才有可能机会执行包下的类大多是使用操作来实现的底层以这个类为例里面的就调用了方法里面有一个对象查看里面的语言代码就会有一个底层的指令指令意思是修改变量值这个指令不是原子的所以需要而在硬件层面指令在执行的时候看情况来采用总线锁或者缓存锁所以底层层面是用的指令如何解决问题如果是基础类型就无所谓就是两个线程去同时修改一个变量值一个线程被某些原因发生阻塞等待过程中另一个线比较更新变量值从到这个时候再来第三个线程想把变量改为到进行比较更新更改完毕以后原来被阻塞的线程这个时候获得时间片发现是于是更新为可是其实该值已经更新过了这个问题可以通过加版本号或者时间戳解决但是一般是每次版本号加一时间戳不容易指定精度一般不用线程调度与同步线程调度器负责将的线程分配怎么进行多线程抢占的调度呢线程调度算法分时调度大家平均分配时间片抢占式优先级高的线程占用如果优先级都相等就随机选一个都是等线程结束才放弃线程同步以及线程调度方释放锁需要被唤醒是的方法用于进程通信不释放锁自动苏醒是的静态方法随机唤醒一个进入锁池唤醒所有进入锁池和不同和不同是成为阻塞状态其他线程不考虑优先级抛出异常移植性更好是成为就绪状态其他线程和当前一起按优先级没有声明异常不怎么建议使用和为啥是静态两个方法是在正在执行的线程运行在处于等待状态里面调用无意义和实际使用这里是一个面试题就是两个线程实现线程打印然后另外一个线程在打到的时候执行然后在执行完之后打印剩下的这里具体就是线程先启动然后然后等到打印以后唤醒线程同时也要释放锁执行完毕又要添加使能够得到通知需要注意先启动再启动启动结束通知继续执行启动释放锁让得以执行描述和区别嗯一般呢这个里面当我调的时候它就会放到等待队列里面当我去拿的时候就会在列表里面这个时候如果我调等待列表就是那个等待池里面就会随机唤醒一个线程来进入锁池竞争锁如果我调就会将该对象所有的线程唤醒其中那个锁池就是等待获得该对象锁拥有权的线程们如何唤醒线程首先阻塞的然后可以被唤醒的线程是调用任意对象的导致了线程阻塞进入等待队列等待被唤醒阻塞的同时要释放该对象的锁要唤醒就需要调用或者首先释放当前对象的锁然后唤醒任意一个或者是全部线程到锁池直到线程获得当前对象的锁才能继续执行还需要注意的是方法一定要放在同步方法或者同步方法块中并且调用方法的对象一定和同步块或方法的对象是同一个这样才能保证调用方法之前线程就已经获得了锁这样才能执行线程的锁释放为什么三个方法要定义在里等待和唤醒必须是同一个锁而锁可以是任意对象所以可以被任意对象调用的方法是定义在类中为什么三个方法要在同步方法或者代码块里面调用因为三个方法都需要线程持有对象的锁比如调的时候这个线程必须拥有该对象的锁接着他就释放这个锁进入等待状态直到其他线程调用这个对象的方法同样呢也是需要先释放对象的锁这样其他线程才能来竞争锁所以方法都是需要通过同步实现进而必须什么是线程同步当一个线程对共享的数据进行操作时应使之成为一个原子操作即在没完成相关操作之前不允许其他线程打断它否则就会破坏数据的完整性必然会得到错误的处理结果这就是线程的同步同步方法和非同步方法可以同时调用吗当然是可以的啊当我有一个的方法我调用的时候是可以调用的因为线程访问的时候需要加锁但是访问的时候又不需要加锁所以允许执行模拟银行账户如果业务里面写方法加锁但是读方法没有加锁这样就会容易产生脏读但是如果业务允许就可以脏读过程就是没加锁的线程在没等你整个过程执行完就读到了你中间的结果产生的内存解决办法就是将没有加锁的线程加上锁会效率变低什么是线程互斥资源的固有特性互斥一个资源在同一时间只能由一个线程去调用对于共享的进程系统资源在单个线程访问时的排他性就是当有若干个线程都要使用某一个资源的时候任何时刻都只允许一个线程来去使用其他要使用该资源的线程必须等待知道占用志愿者释放该资源比较是悲观锁属于抢占式会引起其他线程阻塞提供多线程共享变量可见性和禁止指令重排序优化是基于冲突检测的乐观锁非阻塞和区别是什么是和一样的关键字是类这是二者的本质区别既然是类那么它就提供了比更多更灵活的特性可以被继承可以有方法可以有各种各样的类变量早期的实现比较低效对比大多数场景性能都相差较大但是在中对进行了非常多的改进相同点两者都是可重入锁两者都是可重入锁可重入锁概念是自己可以再次获取自己的内部锁比如一个线程获得了某个对象的锁此时这个对象锁还没有释放当其再次想要获取这个对象的锁的时候还是可以获取的如果不可锁重入的话就会造成死锁同一个线程每次获取锁锁的计数器都自增所以要等到锁的计数器下降为时才能释放锁不同点使用起来比较灵活可以使用来控制如果抢不到线程也不会一定阻塞通过可以响应可以被打断但是必须有释放锁的配合动作必须手动获取与释放锁而不需要手动释放和开启锁只适用于代码块锁而可以修饰类方法变量等二者的锁机制其实也是不一样的底层调用的是的方法加锁操作的应该是对象头中锁的是什么中每一个对象都可以作为锁这是实现同步的基础普通同步方法锁是当前实例对象静态同步方法锁是当前类的对象同步方法块锁是括号里面的对象锁重入可重入的原理其实就是一个线程获得锁之后可以重复得到该锁底层就轻量级锁来说其实就是在线程栈里面压入然后有一个指向一个备份当前对象的指针这个备份叫做重入以后的字段也在这里面这里就是使用这个锁记录进行一个重入计数器的作用重量级锁进入重量级锁会分配一个对象然后将锁标志置为然后存储指向这个对象的指针对象有两个队列和一个指针每个需要获取锁的线程都会进入队列被包装为这个对象如果是多线程指向同一段代码时就会进入队列当某个线程抢到锁了也就是获得对象的监视器了就进入区域并把中的变量设为当前线程同时中的计数器锁重入的锁升级的原理或者是过程首先主要有四种锁状态分别是无状态锁偏向锁轻量级锁和重量级锁要去操作系统申请资源锁的升级的目的背景锁升级是为了减低了锁带来的性能消耗在之后优化的实现方式使用了偏向锁升级为轻量级锁再升级到重量级锁的方式从而减低了锁带来的性能消耗详细锁升级过程总在锁对象的对象头里面有一个字段在第一次访问的时候为空让其持有偏向锁并将设置为其线程再次进入的时候会先判断是否与其线程一致如果一致则可以直接使用此对象如果不一致则升级偏向锁为轻量级锁通过自旋循环一定次数来获取锁执行一定次数之后如果还没有正常获取到要使用的对象此时就会把锁从轻量级升级为重量级锁此过程就构成了锁的升级分对象之后先判断是否为可偏向状态有两个字节作为锁标志首先看是否是然后前面还有一个字段来判断是否是已经拿到偏向锁表示偏向锁已启动启动但是要判断锁线程是否是当前的线程如果是就开始执行代码块但是不是的话说明就有竞争了这个时候操作去获取锁失败了的话达到时获得偏向锁的线程就会被挂起偏向锁会被撤销然后升级为轻量级锁这个时候被阻塞的线程再继续执行同步代码块这部分有个细节就是轻度竞争就会升级为轻量级锁如果是重度竞争比如耗时过长调用了方法等就会直接升级为重量级锁先讲轻量级锁升级为轻量级锁以后还是在用户空间里面进行当前线程栈会划分一部分作为锁记录并且会将锁对象的复制到锁记录中接下来会进行操作将一部分更新为指向锁记录的指针如下图如果成功就会将锁标志位设为说明已经获得轻量级锁这个时候就会进入锁重入阶段底下的锁重入有解释但是失败了就会检查当前锁对象的是否指向当前锁记录如果没有就表示已经被其他线程抢了这个时候就会进行自旋等待默认是次等到此处如果超出阈值还是没有获得锁这个时候就会升级为重量级锁进入重量级锁会分配一个对象然后将锁标志置为然后存储指向这个对象的指针对象有两个队列和一个指针每个需要获取锁的线程都会进入队列被包装为这个对象如果是多线程指向同一段代码时就会进入队列当某个线程抢到锁了也就是获得对象的监视器了就进入区域并把中的变量设为当前线程同时中的计数器锁重入什么时候用自旋锁和系统锁为什么有了自旋锁还要重量级锁因为自旋锁是要占用的而系统锁是到等待队列里面所以你代码如果执行时间短线程数少就用自旋长线程数多就用系统锁自旋也是要消耗资源的如果锁的时间过长或者自旋线程过多就会被消耗而重量级锁又自己的等待队列所有拿不到所有的进入等待队列不需要消耗资源什么时候升级为重量级锁竞争加剧有线程超过次自旋或者是自旋线程数超过核数的一半之后有了自适应自旋是可以自己控制的自旋偏向锁是否启动偏向锁有一个启动时间我记得是四秒钟当你一个普通对象的时候偏向锁没有启动它默认就是无锁态但是一开始的时候如果已经启动了偏向锁那么就是一个匿名偏向锁对象的里的其实就是空的等到你加了这个对象才会指向当前的这个线程了字段就会更新为当前线程了体系中的接口是什么对比同步它有什么优势是的唯一子类接口比同步方法和同步块提供了更具扩展性的锁操作他们允许更灵活的结构可以具有完全不同的性质并且可以支持多个相关类的条件对象它的优势有可以使锁更公平可以使线程在等待锁的时候响应中断可以让线程尝试获取锁并在无法获取锁的时候立即返回或者等待一段时间可以在不同的范围以不同的顺序获取和释放锁整体上来说是的扩展版提供了无条件的可轮询的方法定时的带参方法可中断的可多条件队列的方法锁操作另外的实现类基本都支持非公平锁默认和公平锁只支持非公平锁当然在大部分情况下非公平锁是高效的选择实现一个阻塞队列使用写生产者和消费者产品队列可重入锁生产者消费者构造器一开始传入产品队列的长度生产生产者队列等待提醒消费者队列消费原理分析下面大部分内容其实在类注释上已经给出了不过是英语看着比较吃力一点感兴趣的话可以看看源码原理概览核心思想是如果被请求的共享资源空闲则将当前请求资源的线程设置为有效的工作线程并且将共享资源设置为锁定状态如果被请求的共享资源被占用那么就需要一套线程阻塞等待以及被唤醒时锁分配的机制这个机制是用队列锁实现的即将暂时获取不到锁的线程加入到队列中队列是一个虚拟的双向队列虚拟的双向队列即不存在队列实例仅存在结点之间的关联关系是将每条请求共享资源的线程封装成一个锁队列的一个结点来实现锁的分配看个原理图源码是一个构建锁和同步器的框架最核心的是它的一个共享的类型值叫做这个用来干什么其实主要是看他的子类是怎么实现的比如这个拿这个来记录这个线程到底重入了多少次比如说有一个线程拿到这个把锁了的值就从变成了这个线程又重入了一次就变成了又重入一次就变成等等释放的时候一次释放减一变成就释放了这个数代表了什么要看子类怎么去实现它那么在这个核心上还会有一堆的线程节点当然这个节点是每个里面包含一个线程我们称为线程节点这么多的线程节点去争用这个谁拿到了就表示谁得到了这把锁得核心就是一个共享的数据和一堆互相抢夺竞争的线程这个就是看源码里面在方法里里面我们可以读到它调用了源码再跟进到里可以看到里又调用了我们自己定义自己写的那个源码是使用者需要自定义同步器时要重写的模版方法里面的这个方法又调用了源码获取当前线程拿到核心数值如果数值为说明没人上锁给当线程上锁设置当前线程为独一无二拥有这把锁的线程判断当前线程是否拥有这个把锁设置重入我们读进去会发现它的里面就调用到了这个值首先拿到当前线程拿到的值然后进行判断如果的值为说明没人上锁没人上锁怎么办呢就给自己上锁当前线程就拿到这把锁拿到这个把锁的操作用到了的操作从让他变成的值设置为以后设置当前线程是独一无二的拥有这把锁的线程否则如果当前线程已经占有这把锁了怎么办很简单我们在原来的基础上加就可以了这样就能拿到这把锁了就重入前者是加锁后者是重入状态变量使用一个成员变量来表示同步状态通过内置的队列来完成获取资源线程的排队工作使用对该同步状态进行原子操作实现对其值的修改共享变量使用修饰保证线程可见性状态信息通过类型的进行操作返回同步状态的当前值设置同步状态的值原子地操作将同步状态值设置为给定值如果当前同步状态的值等于期望值队列如果没有到呢那么就进行方法里面会调用这个方法线程添加进入队列里面具体操作也是通过进行添加的方法是是它的预期值假如说我们想把当前线程设置为整个链表尾巴的过程中另外一个线程来了它插入了一个节点那么仔细想一下的整个还等于整个新的吗不等于了吧那么既然不等于了说明中间有线程被其它线程打断了那如果说却是还是等于原来的这个时候就说明没有线程被打断那我们就接着设置尾巴只要设置成功了方法中的参数就做为新的了所以用了操作就不需要把原来的整个链表上锁这也是在效率上比较高的核心资源的共享方式定义两种资源共享方式独占只有一个线程能执行如又可分为公平锁和非公平锁公平锁按照线程在队列中的排队顺序先到者先拿到锁非公平锁当线程要获取锁时无视队列顺序直接去抢锁谁抢到就是谁的共享多个线程可同时执行我们都会在后面讲到可以看成是组合式因为也就是读写锁允许多个线程同时对某一资源进行读不同的自定义同步器争用共享资源的方式也不同自定义同步器在实现时只需要实现共享资源的获取与释放方式即可至于具体线程等待队列的维护如获取资源失败入队唤醒出队等已经在顶层实现好了模版方法使用了模板方法模式自定义同步器时需要重写下面几个提供的模板方法该线程是否正在独占资源只有用到才需要去实现它独占方式尝试获取资源成功则返回失败则返回独占方式尝试释放资源成功则返回失败则返回共享方式尝试获取资源负数表示失败表示成功但没有剩余可用资源正数表示成功且有剩余资源共享方式尝试释放资源成功则返回失败则返回默认情况下每个方法都抛出这些方法的实现必须是内部线程安全的并且通常应该简短而不是阻塞类中的其他方法都是所以无法被其他类使用只有这几个方法可以被其他类使用以为例初始化为表示未锁定状态线程时会调用独占该锁并将此后其他线程再时就会失败直到线程到即释放锁为止其它线程才有机会获取该锁当然释放锁之前线程自己是可以重复获取此锁的会累加这就是可重入的概念但要注意获取多少次就要释放多么次这样才能保证是能回到零态的再以以例任务分为个子线程去执行也初始化为注意要与线程个数一致这个子线程是并行执行的每个子线程执行完后一次会减等到所有子线程都执行完后即会主调用线程然后主调用线程就会从函数返回继续后余动作一般来说自定义同步器要么是独占方法要么是共享方式他们也只需实现中的一种即可但也支持自定义同步器同时实现独占和共享两种方式如主要是高位存储互斥锁的状态高位存储共享锁的状态并发工具类倒计时器是一个同步工具类用来协调多个线程之间的同步这个工具通常用来控制线程等待它可以让某一个线程等待直到倒计时结束再开始执行用法让主线程主线程在开始运行前等待个业务线程执行完毕将的计数器初始化为每当一个任务线程执行完毕就将计数器减当计数器的值变为时在上的线程就会被唤醒一个典型应用场景就是启动一个服务时主线程需要等待多个组件加载完毕之后再继续执行让业务线程主线程处理完数据之后进行此时业务线程被唤醒然后去主线程拿数据或者执行自己的业务逻辑这样实现多个线程开始执行任务的最大并行性循环栅栏和非常类似它也可以实现线程间的技术等待但是它的功能比更加复杂和强大主要应用场景和类似的字面意思是可循环使用的屏障它要做的事情是让一组线程到达一个屏障也可以叫同步点时被阻塞直到最后一个线程到达屏障时屏障才会开门所有被屏障拦截的线程才会继续干活默认的构造方法是其参数表示屏障拦截的线程数量每个线程调用方法告诉我已经到达了屏障然后当前线程被阻塞信号量允许多个线程同时访问和都是一次只允许一个线程访问某个资源信号量可以指定多个线程同时访问某个资源就是一个信号量它的作用是限制某段代码块的并发数有一个构造函数可以传入一个型整数表示某段代码多只有个线程可以访问如果超出了那么请等待等到某个线程执行完毕这段代码块下一个线程再进入由此可以看出如果构造函数中传入的型整数相当于变成了一个了线程见交换数据的工具是一个用于线程间协作的工具类用于两个线程间交换数据它提供了一个交换的同步点在这个同步点两个线程能够交换数据交换数据是通过方法来实现的如果一个线程先执行方法那么它会同步等待另一个线程也执行方法这个时候两个线程就都达到了同步点两个线程就可以交换数据实现这个接口是这个接口是一个读写锁接口主要就是实现了读写分离写锁是独占锁读锁是共享锁实现了读读之间不会互斥但是读写和写写之间的互斥提高了读写效率还实现了锁降级写锁可以降级为读锁首先明确一下不是说不好只是某些时候有局限如果使用可能本身是为了防止线程在写数据线程在读数据造成的数据不一致但这样如果线程在读数据线程也在读数据读数据是不会改变数据的没有必要加锁但是还是加锁了降低了程序的性能因为这个才诞生了读写锁是一个读写锁接口读写锁是用来提升并发程序性能的锁分离技术是接口的一个具体实现实现了读写的分离读锁是共享的写锁是独占的读和读之间不会互斥读和写写和读写和写之间才会互斥提升了读写的性能而读写锁有以下三个重要的特性公平选择性支持非公平默认和公平的锁获取方式吞吐量还是非公平优于公平重进入读锁和写锁都支持线程重进入锁降级遵循获取写锁获取读锁再释放写锁的次序写锁能够降级成为读锁原理源码的方法往里边设置值的时候是怎么设置的呢首先拿到当前线程这是你会发现这个方法里多了一个容器这个容器是一个是一个对其实这个值是设置到了里面设置的是设置的是我们想要的那个值这个就是当前对象就是类如果不等于空的情况下就设置进去就行了如果等于空呢就创建一个源码我们回过头来看这个我们来看看这个到底在哪里我们点击到了这个方法看到它的返回值是源码我们进入这个你会发现这个东西在哪里呢居然是在这个类里所以说这个是在类里的这个时候我们应该明白的方法其实就是设置当前线程里面的所以这个时候你会发现原来类被到了当前线程里的某一个里面去了这个时候我们是不是就能想明白了我了一个值以后为什么其他线程访问不到我们注重当前线程这个段话所以个线程了一个对象到自己的里线程去访问的也是自己的属于线程的所以是读不到值的因此你使用的时候你用和就完全的把他隔离开了就是我自己线程里面所特有的其它的线程是没有的以前我们的理解是都在一个然而并不是所以你得读源码读源码你就明白了用途声明式的事务保证同一个我们根据的声明式事务来解析为什么要用声明式事务一般来讲我们是要通过数据库的但是我们知道结合我们是可以把整个事务写在配置文件中的而这个配置文件里的事务它实际上是管理了一系列的方法方法方法方法而这些方法里面可能写了比方说第个方法写了去配置文件里拿到数据库连接第个第个都是一样去拿数据库连接然后声明式事务可以把这几个方法合在一起视为一个完整的事务如果说在这些方法里每一个方法拿的连接它拿的不是同一个对象你觉的这个东西能形成一个完整的事务吗会放到一个连接池里边如果第个方法拿的是第个第个拿的是第个第个拿的是第个这东西能形成一个完整的事务吗百分之一万的不可能没听说过不同的还能形成一个完整的事务的那么怎么保证这么多之间保证是同一个呢把这个放到这个线程的本地对象里里面以后再拿的时候实际上我是从里拿的第个方法拿的时候就把放到里面后面的方法要拿的时候从里直接拿不从线程池拿四种引用引用是什么就是一个变量值指向一个对象强引用普通的引用比如这个就叫强引用特点就是说只要有一个应用指向这个对象那么垃圾回收器一定不会回收它这就是普通的引用也就是强引用因为有引用指向所以不会回收只有没有引用指向的时候才会回收指向谁指向你创建的那个对象弱引用当有一个对象字节数组被一个软引用所指向的时候只有系统内存不够用的时候才会回收它字节数组虚引用在的应用内存泄露我们来看图中从左开始看这时候我们应该明白了这里是一个强引用指向这个对象而里的是通过一个弱引用指向了一个对象我们假设这是个强引用当指向这个对象消失的时候这个东西是个局部变量方法已结束它就消失了当消失了如果这个对象还被一个强引用的指向的时候这个对象不能被回收而且由于这个线程有很多线程是长期存在的比如这个是一个服务器线程小时一年天不间断运行那么不间断运行的时候这个会长期存在这个会长期存在这个的也会长期存在这个长期存在的话这个对象永远不会被消失所以这里是不是就会有内存泄漏但是如果这个是弱引用的话还会存在这个问题吗当这个强引用消失的时候这个弱引用是不是自动就会回收了这也是为什么用的原因关于还有一个问题当我们这个强引用消失了的指向也被回收了可是很不幸的是这个指向了一个值但是这个的是永远存在的相当于说对你这个是的你这个指向的东西你的这个的字节码你还能访问到吗访问不到了如果这个越积攒越多越来越多它还是会内存泄漏怎么办呢所以必须记住这一点使用里面的对象不用了务必要掉不然还会有内存泄漏同步容器集合部分我们来看这个经常在多线程的情况下使用的这些个容器从开始讲经常用的有这么几个用表实现的这样一个高并发容器既然有了正常情况下就应该有你可以去查查它没有就等于缺了一块为什么没有呢原因就是里面用的是操作这个操作它用在的时候用在树这个节点上的时候实现起来太复杂了所以就没有这个但是有时间也需要这样一个排好序的那就有了跳表结构就出现了通过跳表来实现的高并发容器并且这个是有排序的跳表是什么样的结构呢底层本身存储的元素一个链表它是排好顺序的大家知道当一个链表排好顺序的时候往里插入是特别困难的查找的时候也特别麻烦因为你得从头去遍历查找这个元素到底在哪里所以就出现了这个跳表的结构底层是一个链表链表查找的时候比较困难怎么办那么我们在这些链表的基础上在拿出一些关键元素来在上面做一层那这个关键元素的这一层也是一个链表那这个数量特别大的话在这个基础之上在拿一层出来再做一个链表每层链表的数据越来越少而且它是分层在我们查找的时候从顶层往下开始查找所以呢查找容易了很多同时它无锁的实现难度比又容易很多因此在里面提供了这个类他们两个的区别一个是有序的一个是无序的同时都支持并发的操作下面这个小程序是一个效率的测试其实也没多大意义大家可以去写一下跑跑是什么可以用于什么应用场景有哪些优缺点是一个并发容器有很多人称它是线程安全的我认为这句话不严谨缺少一个前提条件那就是非复合场景下操作它是线程安全的免锁容器的好处之一是当多个迭代器同时遍历和修改这个列表时不会抛出在中写入将导致创建整个底层数组的副本而源数组将保留在原地使得复制的数组在被修改时读取操作可以安全地执行的使用场景通过源码分析我们看出它的优缺点比较明显所以使用场景也就比较明显就是合适读多写少的场景的缺点由于写操作的时候需要拷贝数组会消耗内存如果原数组的内容比较多的情况下可能导致或者不能用于实时读的场景像拷贝数组新增元素都需要时间所以调用一个操作后读取到数据可能还是旧的虽然能做到始终一致性但是还是没法满足实时性要求由于实际使用中可能没法保证到底要放置多少数据万一数据稍微有点多每次都要重新复制数组这个代价实在太高昂了在高性能的互联网应用中这种操作分分钟引起故障的设计思想读写分离读和写分开终一致性使用另外开辟空间的思路来解决并发冲突是有界的你可以指定它一个固定的值它容器就是那么当你往里面扔容器的时候一旦他满了这个方法就会阻塞住然后你可以看看用方法满了之后他会报异常用返回值来判断到底加没加成功还有另外一个写法你可以指定一个时间尝试着往里面加秒钟秒钟之后如果加不进去它就返回了回到那个面试经常被问到的问题和的区别到底在哪里主要就在这里添加了这些个对线程友好的或者阻塞或者等待方法满了就会等待程序阻塞和的区别区别主要就是添加了许多对线程友好的他的一个子类型叫对线程友好的又添加了和这两个实现了阻塞操作线程池线程的工厂这个线程池里面只有一个线程这个一个线程的线程池可以保证我们扔进去的任务是顺序执行的为什么会有单线程的线程池第一个线程池是有任务队列的生命周期管理线程池是能帮你提供的没上限来一个新的任务就必须马上执行没有线程空着我就一个线程那么阿里是不会推荐使用这中线程池的原因是线程会启动的特别多基本接近于没有上限的固定的指定一个参数到底有多少个线程他的核心线程和最大线程都是固定的因为他的最大线程和核心线程都是固定的就没有回收之说所以把他指定成这里用的是定时任务这是专门给定时任务用的这样的一个线程池了解就可以了状态线程池有种状态按大小排序如下正常运行的调用了方法了进入了状态调用了马上让他停止调用了然后这个线程也执行完了现在正在整理的这个过程叫整个线程全部结束多线程的生命周期和线程的生命周期构造方法参数基本类型参数校验空指针校验根据传入参数和将存活时间转换为纳秒存到变量中核心线程数最大线程数销毁之前等待的时间时间单位任务队列线程工厂拒绝策略抛异常扔掉调度任务执行任务的时候判断任务等于空抛异常这个很简单接下来就是拿状态值拿到值之后计算这个值里面的线程数活着的那些线程数是不是小于核心线程数如果小于添加一个线程是比较难的一个方法他的第二个参数指的是是不是核心线程所有上来之后如果核心数不够先添加核心线程再次检查这个值我们原来讲过这个线程里面上来之后刚开始为来一个任务启动一个核心线程第二个就是核心线程数满了之后放到队列里最后核心线程满了队列也满了启动非核心线程小于线程数就直接加后面执行的逻辑就是不小于了不小于就是超过核心线程数了直接往里扔就是把他扔进去队列里再检查状态在这中间可能会被改变状态值因此需要双重检查这个跟我们之前聊过的单例模式里面的是一样的逻辑重新又拿这个状态拿到这个状态之后这里是要进行一个状态切换的如果不是状态说明执行过命令才会把这个转换成别的状态其他情况下如果等于说明里面没有线程了没有线程我线程池正常运行就添加非核心线程这些步骤都是通过源码可以看出来的如果添加本身都不行就把他给拒绝掉核心线程不够启动核心的够了就加队列核心和队列都够了就非核心就做了两步使用和自旋做的加进任务并且是真正执行线程的部分类这个他本身是同时又是这个类里面会记录着一个成员变量这个成员变量是很多个线程这个就是为什么要用的原因另外呢在你整个执行的过程之中你也需要加锁不然的话你别的线程进来因此是需要的这是这个类简单的你就可以把它当成线程类然后这个线程类执行的是你自己的任务就行了和区别实现了接口比多了返回值并且可以抛出异常然后这个是用来存储执行的线程将来才产生的结果为线程池设计配合使用有返回值实现了任务交给线程池未来要结果时再返回是继承了接口和接口既是一个任务又是一个在这类线程池里面用这类线程池是每个线程都有一个阻塞队列杂问题怎么预防死锁答首先我们要知道产生死锁的四个必要条件第一个资源在同一时间只能有一个线程来占用这个也就是互斥条件第二个不可剥夺条件当一个线程已经占有一个资源在释放之前是不会让其他线程抢占在有就是线程等待的过程中不会释放自己持有的资源也就是请求和保持条件第四个条件就是循环等待条件多个线程在互相等待对方释放资源有了这四个条件当多个线程都持有对方想要的资源却等待对方释放资源的状态就造成了死锁所以预防死锁就需要从这四个方面入手第一个资源互斥因为是资源固有属性不能破坏这个条件我们去破坏第二个不可剥夺条件可以让进程在等待过程中将其占有的资源隐性释放到系统的资源列表中而等待的进程只有重新获得自己原有的资源和新申请的资源才能启动执行破坏第三个请求和保持条件可以使用静态分配和动态分配两种方法静态分配就是在每一个进程开始执行时就申请他需要的资源动态分配就是在申请资源的时候他本身不能占用系统资源最后就是破坏循环等待条件将系统中的所有资源顺序编号紧缺资源用大编号进程在申请资源的时候必须按照编号的顺序执行嗯我认为就从这四个方面去着手谢谢线程创建方式和生命周期有五种方式第一种方法就是继承类重写调用开启线程第二种实现接口重写实现接口比继承类要灵活第三种是使用表达式本质是一样第四种是实现接口执行这种方法相对不同就是执行完毕有返回值返回值通过接收可以通过泛型指定类型也可以抛出异常第五种就是通过线程池创建和一个调用就是启动一个线程然后进入就绪状态但分配到时间片就可以运行而只是用于执行线程运行时执行代码可以重复调用也就是说用来真正启动多线程工作进行准备就绪而线程只是通过来完成它的运行状态是一个普通方法的调用其实还是再主线程里执行的线程生命周期和五种状态进入锁池请求结束或者异常退出进程与线程的区别进程是系统进行资源分配和调度的基本单位是操作系统结构的基础线程是操作进行运算调度的最小单位通俗来讲就是一个程序它本来是一种静态的指令和数据当系统开始运行这个程序就会到内存里然后系统为其分配资源这个时候就是一个进程可以理解为进程就是动态的程序而线程就是进程实际运行的单位一种单一顺序的控制流一个进程可以并发多个线程每条线程有不同任务并发与并行并发是指多个任务在同一个核上按照细分的时间片交替进行如果交替时间片够短逻辑上可以看作同时执行并行是多个核在同一时间处理多个任务是真正意义上的同时进行串行就是一个多个任务串联在一起按照顺序执行程序开多少线程合适是不是线程数越高效率越高多线程的缺点线程数过多会怎么样占用内存给垃圾处理器带来压力需要协调和管理时间跟踪线程还会互相竞争共享资源这样会带来很多其他性能的开销与线程的体制完全耦合完全相关所以这个时候就看程序要干什么根据操作和操作区分程序如果计算比例占大部分也就是密集型程序这个时候线程等待时间接近于也就是耗费大量时间的就是上下文切换为了减少上下文切换一般开核数个线程再加一条保证线程意外暂停如果是操作占比大部分等待时间长理论上是可以开无限多个线程但是考虑到节约资源又要保证性能及稳定性一般用两倍的核数再加一条为如果需要精密计算的任务就可以使用公式核数阻塞系数阻塞系数单个设定多线程有没有意义结合上面根据实际需要来处理如果你的每个线程的工作与时序无关的并且含有外部的读写操作那么是很有意义的当一个线程进行读写的时候其他线程可以占用进行运行也即线程属于密集型的时候在才会体现的多线程的好处如果是密集型的你开了很多个线程只是增加了在各个线程中进行切换的负担没有带来好处和性能的提高如何结束一个线程就是方法结束就正常退出线程了自然退出使用但是不建议使用因为结束线程不会在意你进行到哪突然结束会容易产生数据不一致标志也可以如果是不依赖中间状态停止就很方便是特定场景下比较优雅的解决方案不适合没有同步的时候线程阻塞没办法循环回去打断时间不精确比如在一个阻塞容器容量为的时候结束生产者由于其对同步线程标志位的时间控制不是很精确有时候生产者还会生产一部分时间比较优雅当然要精确停止控制线程有时候更加需要和外面的线程进行合作吗这个时候就需要用到锁了和实例法设置线程中断标志打扰下你该处理下中断比如在睡眠的时候没办法中断这个时候就需要实例法有没有打扰我静态法有没有打扰我当前线程复位是静态方法一个线程被中断第一次调用时返回然后清除中断信号后面再次调用就是了就是查看当前信息线程类的构造方法静态块是被哪个线程调用的这是一个非常刁钻和狡猾的问题请记住线程类的构造方法静态块是被这个线程类所在的线程所调用的而方法里面的代码才是被线程自身所调用的如果说上面的说法让你感到困惑那么我举个例子假设中了函数中了那么的构造方法静态块是线程调用的的方法是自己调用的的构造方法静态块是调用的的方法是自己调用的线程安全活跃态死锁是指两个或两个以上的进程或线程在执行过程中因争夺资源而造成的一种互相等待的现象若无外力作用它们都将无法推进下去活锁任务或者执行者没有被阻塞由于某些条件没有满足导致一直重复尝试失败尝试失败例如循环递归没有写输出条件抛活锁和死锁的区别在于处于活锁的实体是在不断的改变状态这就是所谓的活而处于死锁的实体表现为等待活锁有可能自行解开死锁则不能饥饿一个或者多个线程因为种种原因无法获得所需要的资源导致一直无法执行的状态例子读写锁一直读导致写操作一直等待中导致饥饿的原因其他线程在临界区做了无限循环或无限制等待资源的操作让其他的线程一直不能拿到锁进入临界区对其他线程来说就进入了饥饿状态因为线程优先级分配的不合理导致部分线程始终无法获得资源和顺序交替打印这道面试题呢实际上是华为的一道面试题其实它里面是一道填空题后来就很多的开始考这道题这个面试题是两个线程第一个线程是从到第二个线程是从到一直到然后要让这两个线程做到同时运行交替输出顺序打印那么这道题目的解法有非常多叫醒阻塞阻塞叫醒和一定要注意最后都要多线程之间是怎么通信的通过共享变量变量需要修饰使用和方法但是由于需要使用同一把锁所以必须通知线程释放锁被通知的线程才能获得到多这样导致通知不及时使用实现通知线程到指定条件调用被通知的线程进行方法使用的和方法生产者消费者模型阻塞队列和数据生产数据当前仓库中已经有了条数据消费当前仓库中剩下条数据',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-06-18 12:21:32',
  postMainColor: '',
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#18171d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#f7f9fe')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"></head><body data-type="anzhiyu"><div id="web_bg"></div><div id="an_music_bg"></div><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><img class="loading-img nolazyload" alt="加载头像" src="https://img.soniachen.com/cover2.gif"/><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.getElementById('loading-box').classList.add("loaded");
  },
  initLoading: () => {
    document.getElementById('loading-box').classList.remove("loaded")
  }
}
window.addEventListener('load',()=> { preloader.endLoading() })
setTimeout(function(){preloader.endLoading();},10000)

if (true) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.10/progress_bar/progress_bar.css"/><script async="async" src="https://cdn.cbd.int/pace-js@1.2.4/pace.min.js" data-pace-options="{ &quot;restartOnRequestAfter&quot;:false,&quot;eventLag&quot;:false}"></script><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><div id="nav-group"><span id="blog_name"><div class="back-home-button"><i class="anzhiyufont anzhiyu-icon-grip-vertical"></i><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.soniachen.com/" title="博客"><img class="back-menu-item-icon" src="https://img.soniachen.com/%E9%92%A2%E9%93%81%E8%9C%98%E8%9B%9B%E4%BE%A0.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div></div></div><a id="site-name" href="/" accesskey="h"><div class="title">Sonia33</div><i class="anzhiyufont anzhiyu-icon-house-chimney"></i></a><div id="he-plugin-simple"></div><script>var WIDGET = {
  "CONFIG": {
    "modules": "0124",
    "background": "2",
    "tmpColor": "FFFFFF",
    "tmpSize": "16",
    "cityColor": "FFFFFF",
    "citySize": "16",
    "aqiColor": "E8D87B",
    "aqiSize": "16",
    "weatherIconSize": "24",
    "alertIconSize": "18",
    "padding": "10px 10px 10px 10px",
    "shadow": "0",
    "language": "auto",
    "borderRadius": "20",
    "fixed": "true",
    "vertical": "top",
    "horizontal": "left",
    "left": "20",
    "top": "7.1",
    "key": "df245676fb434a0691ead1c63341cd94"
  }
}
</script><link rel="stylesheet" href="https://widget.qweather.net/simple/static/css/he-simple.css?v=1.4.0"/><script src="https://widget.qweather.net/simple/static/js/he-simple.js?v=1.4.0"></script></span><div class="mask-name-container"><div id="name-container"><a id="page-name" href="javascript:anzhiyu.scrollToDest(0, 500)">PAGE_NAME</a></div></div><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=447363601&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div></div><div id="nav-right"><div class="nav-button" id="randomPost_button"><a class="site-page" onclick="toRandomPost()" title="随机前往一个文章" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-dice"></i></a></div><div class="nav-button" id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" title="搜索🔍" accesskey="s"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span> 搜索</span></a></div><input id="center-console" type="checkbox"/><label class="widget" for="center-console" title="中控台" onclick="anzhiyu.switchConsole();"><i class="left"></i><i class="widget center"></i><i class="widget right"></i></label><div id="console"><div class="console-card-group-reward"><ul class="reward-all console-card"><li class="reward-item"><a href="https://img.soniachen.com/blog/IMG_5543.JPG" target="_blank"><img class="post-qr-code-img" alt="微信" src="https://img.soniachen.com/blog/IMG_5543.JPG"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://img.soniachen.com/blog/IMG_5544.JPG" target="_blank"><img class="post-qr-code-img" alt="支付宝" src="https://img.soniachen.com/blog/IMG_5544.JPG"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div><div class="console-card-group"><div class="console-card-group-left"><div class="console-card" id="card-newest-comments"><div class="card-content"><div class="author-content-item-tips">互动</div><span class="author-content-item-title"> 最新评论</span></div><div class="aside-list"><span>正在加载中...</span></div></div></div><div class="console-card-group-right"><div class="console-card tags"><div class="card-content"><div class="author-content-item-tips">兴趣点</div><span class="author-content-item-title">寻找你感兴趣的领域</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BlockChain/" style="font-size: 1.05rem;">BlockChain<sup>4</sup></a><a href="/tags/CSS/" style="font-size: 1.05rem;">CSS<sup>1</sup></a><a href="/tags/CloudFlare/" style="font-size: 1.05rem;">CloudFlare<sup>2</sup></a><a href="/tags/DataBase/" style="font-size: 1.05rem;">DataBase<sup>2</sup></a><a href="/tags/FastDFS/" style="font-size: 1.05rem;">FastDFS<sup>1</sup></a><a href="/tags/Foundry/" style="font-size: 1.05rem;">Foundry<sup>1</sup></a><a href="/tags/Git/" style="font-size: 1.05rem;">Git<sup>2</sup></a><a href="/tags/HTML/" style="font-size: 1.05rem;">HTML<sup>1</sup></a><a href="/tags/IO/" style="font-size: 1.05rem;">IO<sup>1</sup></a><a href="/tags/JDBC/" style="font-size: 1.05rem;">JDBC<sup>1</sup></a><a href="/tags/JQuery/" style="font-size: 1.05rem;">JQuery<sup>1</sup></a><a href="/tags/Java/" style="font-size: 1.05rem; font-weight: 500; color: var(--anzhiyu-lighttext)">Java<sup>3</sup></a><a href="/tags/JavaScript/" style="font-size: 1.05rem;">JavaScript<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 1.05rem;">Linux<sup>1</sup></a><a href="/tags/MQ/" style="font-size: 1.05rem;">MQ<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 1.05rem;">MySQL<sup>2</sup></a><a href="/tags/Nacos/" style="font-size: 1.05rem;">Nacos<sup>1</sup></a><a href="/tags/NoSQL/" style="font-size: 1.05rem;">NoSQL<sup>1</sup></a><a href="/tags/OpenFeign/" style="font-size: 1.05rem;">OpenFeign<sup>1</sup></a><a href="/tags/PicGo/" style="font-size: 1.05rem;">PicGo<sup>1</sup></a><a href="/tags/RabbitMQ/" style="font-size: 1.05rem;">RabbitMQ<sup>1</sup></a><a href="/tags/Redis/" style="font-size: 1.05rem;">Redis<sup>2</sup></a><a href="/tags/Rust/" style="font-size: 1.05rem;">Rust<sup>16</sup></a><a href="/tags/Sentinel/" style="font-size: 1.05rem;">Sentinel<sup>2</sup></a><a href="/tags/Solidity/" style="font-size: 1.05rem;">Solidity<sup>4</sup></a><a href="/tags/Typora/" style="font-size: 1.05rem;">Typora<sup>1</sup></a><a href="/tags/Zookeeper/" style="font-size: 1.05rem;">Zookeeper<sup>1</sup></a><a href="/tags/hexo/" style="font-size: 1.05rem;">hexo<sup>3</sup></a><a href="/tags/java/" style="font-size: 1.05rem;">java<sup>1</sup></a><a href="/tags/macOS/" style="font-size: 1.05rem;">macOS<sup>2</sup></a><a href="/tags/web/" style="font-size: 1.05rem;">web<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 1.05rem;">分布式<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 1.05rem;">分布式锁<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 1.05rem;">后端<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 1.05rem;">多线程<sup>1</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 1.05rem;">测试<sup>1</sup></a><a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 1.05rem;">缓存<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 1.05rem;">网络<sup>1</sup></a><a href="/tags/%E8%B8%A9%E9%9B%B7/" style="font-size: 1.05rem;">踩雷<sup>1</sup></a></div></div><hr/></div></div><div class="console-card history"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-box-archiv"></i><span>文章</span></div><div class="card-archives"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-archive"></i><span>归档</span><a class="card-more-btn" href="/archives/" title="查看更多">
    <i class="anzhiyufont anzhiyu-icon-angle-right"></i></a></div><ul class="card-archive-list"><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/07/"><span class="card-archive-list-date">七月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">21</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/06/"><span class="card-archive-list-date">六月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">5</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2025/04/"><span class="card-archive-list-date">四月 2025</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/09/"><span class="card-archive-list-date">九月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/06/"><span class="card-archive-list-date">六月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2024/03/"><span class="card-archive-list-date">三月 2024</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/05/"><span class="card-archive-list-date">五月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">4</span><span>篇</span></div></a></li><li class="card-archive-list-item"><a class="card-archive-list-link" href="/archives/2022/03/"><span class="card-archive-list-date">三月 2022</span><div class="card-archive-list-count-group"><span class="card-archive-list-count">1</span><span>篇</span></div></a></li></ul></div><hr/></div></div></div><div class="button-group"><div class="console-btn-item"><a class="darkmode_switchbutton" title="显示模式切换" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-moon"></i></a></div><div class="console-btn-item" id="consoleHideAside" onclick="anzhiyu.hideAsideBtn()" title="边栏显示控制"><a class="asideSwitch"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></a></div><div class="console-btn-item" id="consoleMusic" onclick="anzhiyu.musicToggle()" title="音乐开关"><a class="music-switch"><i class="anzhiyufont anzhiyu-icon-music"></i></a></div></div><div class="console-mask" onclick="anzhiyu.hideConsole()" href="javascript:void(0);"></div></div><div class="nav-button" id="nav-totop"><a class="totopbtn" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i><span id="percent" onclick="anzhiyu.scrollToDest(0,500)">0</span></a></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" title="切换"><i class="anzhiyufont anzhiyu-icon-bars"></i></a></div></div></div></nav><div id="post-info"><div id="post-firstinfo"><div class="meta-firstline"><a class="post-meta-original">原创</a><span class="post-meta-categories"><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-inbox post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" itemprop="url">多线程</a></span><span class="article-meta tags"><a class="article-meta__tags" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" tabindex="-1" itemprop="url"> <span> <i class="anzhiyufont anzhiyu-icon-hashtag"></i>多线程</span></a></span></div></div><h1 class="post-title" itemprop="name headline">多线程</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="anzhiyufont anzhiyu-icon-calendar-days post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" itemprop="dateCreated datePublished" datetime="2022-02-09T05:19:50.000Z" title="发表于 2022-02-09 13:19:50">2022-02-09</time><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-history post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" itemprop="dateCreated datePublished" datetime="2025-06-18T04:21:32.077Z" title="更新于 2025-06-18 12:21:32">2025-06-18</time></span></div><div class="meta-secondline"><span class="post-meta-separator"></span><span class="post-meta-wordcount"><i class="anzhiyufont anzhiyu-icon-file-word post-meta-icon" title="文章字数"></i><span class="post-meta-label" title="文章字数">字数总计:</span><span class="word-count" title="文章字数">16.8k</span><span class="post-meta-separator"></span><i class="anzhiyufont anzhiyu-icon-clock post-meta-icon" title="阅读时长"></i><span class="post-meta-label" title="阅读时长">阅读时长:</span><span>55分钟</span></span><span class="post-meta-separator">       </span><span class="post-meta-position" title="作者IP属地为四川"><i class="anzhiyufont anzhiyu-icon-location-dot"></i>四川</span><span class="post-meta-separator"></span><span class="post-meta-commentcount"><i class="anzhiyufont anzhiyu-icon-comments post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2022/02/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B/#post-comment" tabindex="-1"><span id="twikoo-count"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-spin"></i></span></a></span></div></div></div><section class="main-hero-waves-area waves-area"><svg class="waves-svg" xmlns="http://www.w3.org/2000/svg" xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M -160 44 c 30 0 58 -18 88 -18 s 58 18 88 18 s 58 -18 88 -18 s 58 18 88 18 v 44 h -352 Z"></path></defs><g class="parallax"><use href="#gentle-wave" x="48" y="0"></use><use href="#gentle-wave" x="48" y="3"></use><use href="#gentle-wave" x="48" y="5"></use><use href="#gentle-wave" x="48" y="7"></use></g></svg></section><div id="post-top-cover"><img class="nolazyload" id="post-top-bg" src="https://img.soniachen.com/IMG_5493.jpg?_r_=ec673246-ce76-5933-0085-b53e89e196be"></div></header><main id="blog-container"><div class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container" itemscope itemtype="https://blog.soniachen.com/2022/02/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><header><a class="post-meta-categories" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" itemprop="url">多线程</a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" tabindex="-1" itemprop="url">多线程</a><h1 id="CrawlerTitle" itemprop="name headline">多线程</h1><span itemprop="author" itemscope itemtype="http://schema.org/Person">SoniaChen</span><time itemprop="dateCreated datePublished" datetime="2022-02-09T05:19:50.000Z" title="发表于 2022-02-09 13:19:50">2022-02-09</time><time itemprop="dateCreated datePublished" datetime="2025-06-18T04:21:32.077Z" title="更新于 2025-06-18 12:21:32">2025-06-18</time></header><h1>并发编程三大特性</h1>
<h2 id="可见性">可见性</h2>
<p><u><strong>MESI</strong></u> 多线程的底层并不是通过mesi</p>
<p>多线程提高效率，本地缓存数据，造成数据修改不可见，</p>
<p>要想保证可见，要么触发同步指令，要么加上volatile，被修饰的内存，只要有修改，马上同步涉及到的每个线程。</p>
<span id="more"></span>
<h3 id="volatile">==volatile==</h3>
<h5 id="介绍一下volatile的功能？">==介绍一下volatile的功能？==</h5>
<p>volatile关键字保证了<strong>可见性和禁止指令重排</strong></p>
<p>提供了happen-before的保证，确保一个线程的修改可以对其他线程是可见的。当一个共享变量被修饰的时候，就会保证修改的值立即被更新到内存，当其他线程需要读取的时候，就会去内存中读取新值。从实际角度来说，其中的一个重要作用就是与CAS结合，保证了<strong>原子性</strong>。volatile经常用在多线程环境下的单次操作。</p>
<p><u>通俗来讲</u>就是 ab线程要用一个变量，然后java默认是a线程中保留一份copy，这样如果b线程来修改，则a线程未必知道，如果使用这个关键字，线程之间数据修改都能可见。</p>
<h5 id="volatile的可见性和禁止指令重排序怎么实现的？">==volatile的可见性和禁止指令重排序怎么实现的？==</h5>
<p>volatile本质上是通过内存屏障来实现可见性的，被修饰的变量在被修改之后可以立即同步到主内存，该变量每次使用之前都从主内存刷新，而禁止指令重排序也是通过内存屏障来禁止的，本来现在的cpu为了提高效率会见指令并发执行，一个指令从JMM内存屏障的策略来看，就是在volatile的写操作的前面插入一个StoreStore屏障，后面插入一个StoreLoad，在读操作前面加入一个LoadLoad，后面加一个LoadStore屏障。</p>
<h5 id="volatile-的底层实现？">==volatile 的底层实现？==</h5>
<p>volatile 底层jmm</p>
<h5 id="实现一下DCL-单例模式下的双重检查-volatile的实践">==实现一下DCL(单例模式下的双重检查)/ volatile的实践==</h5>
<p>是否lazy化？ 是</p>
<p>是否线程安全？ 是</p>
<p>实现难度： 针对需要双重检查的操作</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// volatile防止指令重排</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">Singleton</span> singleton<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 第一层判断singleton是不是null</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//现在再加锁</span>
            <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">// 第二层判断</span>
                <span class="token comment">// 如果A,B 两个线程都在synchronized等待</span>
                <span class="token comment">// A 创建完对象之后，B还会再进入，如果不再检查一遍，B又会创建一个对象</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                    singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>                                                                                </code></pre>
<h5 id="单例里面要不要加volatile？">==单例里面要不要加volatile？==</h5>
<p>要加，如果不加volatile问题就会出现在指令重排序上，</p>
<p>比如有一行初始化对象的代码，被编译器执行之后就会分成三步，1 给指令申请内存，2 给成员变量初始化，3 把这块内存的内容赋值，重排序以后 既然已经有这个值，在另外一个线程上来先去检查就会发现已经存在该值，就不会进入锁部分的代码，但是加了volatile就不会允许指令重排序，一定会保证你初始化完了才会给你赋值这个变量。</p>
<h2 id="有序性">有序性</h2>
<h3 id="程序真的是按照顺序执行的吗？">程序真的是按照顺序执行的吗？</h3>
<p>并不是 cpu为了提高效率，通常都是乱序</p>
<p>在执行程序时，为了提供性能，处理器和编译器常常会对指令进行重排序，但是不能随意重排序，不是你想怎么排序就怎么排序，它需要满足以下两个条件：在单线程环境下不能改变程序运行的结果；存在数据依赖关系的不允许重排序需要注意的是：重排序不会影响单线程环境的执行结果，但是会破坏多线程的执行语义。</p>
<h3 id="单线程也不是顺序执行">单线程也不是顺序执行</h3>
<p>单线程有一个 a i s 语义保证了其单线程执行结果不被改变，其实也不是顺序执行的。</p>
<p><strong>as-if-serial语义</strong>保证单线程内程序的执行结果不被改变，happensbefore关系保证正确同步的多线程程序的执行结果不被改变。 as-if-serial语义给编写单线程程序的程序员创造了一个幻境：单线程程序是按程序的顺序来执行的。<strong>happens-before</strong>关系给编写正确同步的多线程程序的程序员创造了一个幻境：正确同步的多线程程序是按 happens-before指定的顺序来执行的。</p>
<p>as-if-serial语义和happens-before这么做的目的，都是为了在不改变程序执行结果的前提下，尽可能地提高程序执行的并行度。</p>
<h2 id="原子性">原子性</h2>
<p>保证操作的原子性可以通过synchronized(悲观锁) 和 cas(乐观锁)</p>
<h3 id="CAS">CAS</h3>
<p>CAS 是 compare and swap 的缩写，即我们所说的比较交换。</p>
<p>cas 是一种基于锁的操作，而且是乐观锁。在 java 中锁分为乐观锁和悲观锁。</p>
<p>悲观锁是将资源锁住，等一个之前获得锁的线程释放锁之后，下一个线程才可以访问。而乐观锁采取了一种宽泛的态度，通过某种方式不加锁来处理资源，比如通过给记录加 version 来获取数据，性能较悲观锁有很大的提高。</p>
<p>CAS 操作包含三个操作数 —— 内存位置（V）、预期原值（A）和新值(B)。如果内存地址里面的值和 A 的值是一样的，那么就将内存里面的值更新成 B。</p>
<p>CAS是通过无限循环来获取数据的，若果在第一轮循环中，a 线程获取地址里面的值被b 线程修改了，那么 a 线程需要自旋，到下次循环才有可能机会执行。</p>
<p>java.util.concurrent.atomic 包下的类大多是使用 CAS 操作来实现的(AtomicInteger,AtomicBoolean,AtomicLong)。</p>
<h5 id="CAS底层">==CAS底层==</h5>
<p>以AtomicInterger 这个类为例，里面的incrementAndGet() 就调用了compareAndSet()方法 里面有一个unsafe对象 查看jdk里面的c语言代码就会有一个底层的指令 <code> cmpxchg</code>指令 意思是<code>cas修改变量值</code> 这个指令不是原子的所以需要 lock ，而在硬件层面lock指令在执行的时候看情况来采用总线锁或者缓存锁，所以底层层面cas是用的lock指令。</p>
<h5 id="如何解决ABA问题">==如何解决ABA问题==</h5>
<p>如果是基础类型就无所谓，就是两个线程去同时修改一个变量值，一个线程被某些原因发生阻塞等待过程中另一个线比较更新 变量值从A到B，这个时候再来第三个线程想把变量改为B到A，进行比较更新更改完毕以后，原来被阻塞的线程这个时候获得CPU时间片发现是A 于是更新为B 可是其实该值已经更新过了，这个问题可以通过加版本号或者时间戳解决，但是一般是每次版本号加一，时间戳不容易指定精度一般不用。</p>
<h1>线程调度与同步</h1>
<h3 id="线程调度器">线程调度器</h3>
<p>负责将runnable的线程分配CPU</p>
<h4 id="怎么进行多线程抢占cpu的调度呢？（线程调度算法">怎么进行多线程抢占cpu的调度呢？（<strong>线程调度算法</strong></h4>
<ol>
<li>分时调度 大家平均分配时间片</li>
<li>抢占式 优先级高的线程占用 ，如果优先级都相等就随机选一个，都是等线程结束才放弃CPU</li>
</ol>
<h3 id="线程同步以及线程调度方">线程同步以及线程调度方</h3>
<ol>
<li>
<p>wait(): 释放锁； 需要被唤醒 ；是object的方法；用于进程通信；</p>
</li>
<li>
<p>sleep()：不释放锁 ；自动苏醒；是thread的静态方法</p>
</li>
<li>
<p>notify()：随机唤醒一个进入锁池</p>
</li>
<li>
<p>notifyAll()： 唤醒所有进入锁池</p>
<h4 id="sleep-和-wait-不同">sleep() 和 wait() 不同</h4>
<h4 id="sleep-和yeild-不同">sleep()和yeild() 不同</h4>
<p>sleep()是成为阻塞状态，其他线程不考虑优先级，抛出interrupted异常，移植性更好</p>
<p>yeild()是成为就绪状态，其他线程和当前一起按优先级，没有声明异常，不怎么建议使用</p>
<h4 id="sleep-和yeild-为啥是静态">sleep()和yeild()为啥是静态</h4>
<p>两个方法是在正在执行的线程运行，在处于等待状态里面调用无意义</p>
</li>
</ol>
<h3 id="wait-和-notify-实际使用">==wait() 和 notify()实际使用==</h3>
<p>这里是一个面试题，就是两个线程实现线程a打印1～10，然后另外一个线程b在a打到5的时候执行，然后a在b执行完之后打印剩下的</p>
<p><u>这里具体就是线程b先启动然后wait ，然后等到a打印1～5以后唤醒线程b，同时也要wait()释放锁，b执行完毕又要notify a。</u></p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T03_NotifyHoldingLock</span> <span class="token punctuation">&#123;</span> <span class="token comment">//wait notify</span>
	<span class="token comment">//添加volatile，使t2能够得到通知</span>
	<span class="token keyword">volatile</span> <span class="token class-name">List</span> lists <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		lists<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">return</span> lists<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token class-name">T03_NotifyHoldingLock</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">T03_NotifyHoldingLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">final</span> <span class="token class-name">Object</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
    <span class="token comment">//需要注意先启动t2再启动t1</span>
    <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"t2 启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
						lock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
						e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
				<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"t2 结束"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
            <span class="token comment">//通知t1继续执行</span>
            lock<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span>。
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			e1<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		
		<span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
			<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"t1 启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">synchronized</span><span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
					c<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"add "</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
						lock<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//释放锁，让t2得以执行</span>
                        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
                           lock<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
					  	 e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">&#125;</span>
					<span class="token punctuation">&#125;</span>
					<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
						<span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
						e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">&#125;</span>
				<span class="token punctuation">&#125;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="描述notify和notifyAll区别">描述notify和notifyAll区别</h3>
<p>嗯一般呢这个object里面当我调wait的时候它就会放到等待队列里面，当我去拿的时候，就会在wait列表里面，这个时候如果我调notify等待列表就是那个等待池里面就会随机唤醒一个线程来进入锁池竞争锁，如果我调notifyAll就会将该对象所有wait的线程唤醒。其中那个锁池就是等待获得该对象锁拥有权的线程们。</p>
<h4 id="如何唤醒线程？">如何唤醒线程？</h4>
<p>首先阻塞的然后可以被唤醒的线程，是调用任意对象的wait()，导致了线程阻塞进入等待队列等待被唤醒，阻塞的同时要释放该对象的锁，要唤醒就需要调用notify()或者notifyAll()，首先释放当前对象的锁，然后唤醒任意一个或者是全部线程到锁池直到线程获得当前对象的锁才能继续执行。还需要注意的是方法一定要放在同步方法或者同步方法块中，并且调用方法的对象一定和同步块或方法的对象是同一个，这样才能保证调用方法之前线程就已经获得了锁，这样才能执行线程的锁释放</p>
<h3 id="为什么三个方法要定义在object里？">为什么三个方法要定义在object里？</h3>
<p>等待和唤醒必须是同一个锁。而锁可以是任意对象，所以可以被任意对象调用的方法是定义在object类中。</p>
<h3 id="为什么三个方法要在同步方法或者代码块里面调用？">为什么三个方法要在同步方法或者代码块里面调用？</h3>
<p>因为三个方法都需要线程持有对象的锁，比如调wait()的时候这个线程必须拥有该对象的锁，接着他就释放这个锁进入等待状态直到其他线程调用这个对象的notify方法，同样notify呢，也是需要先释放对象的锁，这样其他线程才能来竞争锁；所以方法都是需要通过同步实现，进而必须。。。</p>
<h3 id="什么是线程同步？">什么是线程同步？</h3>
<p>当一个线程对共享的数据进行操作时，应使之成为一个&quot;原子操作&quot;， 即在没完成相关操作之前，不允许其他线程打断它，否则就会破坏数据的完整性，必然会得到错误的处理结果，这就是线程的同步</p>
<h3 id="同步方法和非同步方法可以同时调用吗？">同步方法和非同步方法可以同时调用吗？</h3>
<p>当然是可以的啊 当我有一个synchronized的m1方法，我调用m1的时候是可以调用m2的，因为线程访问m1的时候需要加锁，但是访问m2的时候又不需要加锁，所以允许执行m2。</p>
<p>模拟银行账户： 如果业务里面写方法加锁但是读方法没有加锁，这样就会容易产生脏读，但是如果业务允许，就可以，脏读过程就是没加锁的线程在没等你整个过程执行完就读到了你中间的结果产生的内存，解决办法就是将没有加锁的线程加上锁，会效率变低。</p>
<h4 id="什么是线程互斥？">什么是线程互斥？</h4>
<p>资源的固有特性 互斥 一个资源在同一时间只能由一个线程去调用</p>
<p>对于共享的进程系统资源，在单个线程访问时的排他性。就是当有若干个线程都要使用某一个资源的时候，任何时刻，都只允许一个线程来去使用，其他要使用该资源的线程必须等待，知道占用志愿者释放该资源。</p>
<h1>Synchronized</h1>
<h3 id="synchronized、volatile、CAS-比较">synchronized、volatile、CAS 比较</h3>
<p>（1）synchronized 是悲观锁，属于抢占式，会引起其他线程阻塞。</p>
<p>（2）volatile 提供多线程共享变量可见性和禁止指令重排序优化。</p>
<p>（3）CAS 是基于冲突检测的乐观锁（非阻塞）</p>
<h3 id="synchronized-和-ReentrantLock-区别是什么？">==synchronized 和 ReentrantLock 区别是什么？==</h3>
<p>synchronized 是和 if、else、for、while 一样的关键字，ReentrantLock 是类，这是二者的本质区别。既然 ReentrantLock 是类，那么它就提供了比synchronized 更多更灵活的特性，可以被继承、可以有方法、可以有各种各样的类变量</p>
<p>synchronized 早期的实现比较低效，对比 ReentrantLock，大多数场景性能都相差较大，但是在 Java 6 中对 synchronized 进行了非常多的改进。</p>
<p>==相同点：==</p>
<p><u>两者都是可重入锁两者都是可重入锁。“可重入锁”概念是：自己可以再次获取自己的内部锁。比如一个线程获得了某个对象的锁，此时这个对象锁还没有释放，当其再次想要获取这个对象的锁的时候还是可以获取的，如果不可锁重入的话，就会造成死锁。同一个线程每次获取锁，锁的计数器都自增1，所以要等到锁的计数器下降为0 时才能释放锁。</u></p>
<p>==不同点==</p>
<ul>
<li>ReentrantLock 使用起来比较灵活：1. 可以使用trylock来控制，如果抢不到线程也不会一定阻塞，2. 通过lockInterruptibly()可以响应interrupt()，可以被打断。但是必须有释放锁的配合动作；</li>
<li>ReentrantLock 必须手动获取与释放锁，而 synchronized 不需要手动释放和开启锁；</li>
<li>ReentrantLock 只适用于代码块锁，而 synchronized 可以修饰类、方法、变量等。</li>
<li>二者的锁机制其实也是不一样的。ReentrantLock 底层调用的是 Unsafe 的 park 方法加锁，synchronized 操作的应该是对象头中 markword</li>
</ul>
<h4 id="锁的是什么">锁的是什么?</h4>
<p>Java中每一个对象都可以作为锁，这是synchronized实现同步的基础: 普通同步方法，锁是当前实例对象；静态同步方法，锁是当前类的class对象；同步方法块，锁是括号里面的对象</p>
<h3 id="锁重入？">锁重入？</h3>
<img src="多线程/image-20220304231552625.png" alt="image-20220304231552625" style="zoom: 33%;" />
<p>可重入的原理其实就是一个线程获得锁之后，可以重复得到该锁，底层就轻量级锁来说，其实就是在线程栈里面压入lockRecord然后有一个指向一个备份当前对象markword的指针，这个备份叫做displace markword（重入以后的hashword字段也在这里面），这里就是使用这个锁记录进行一个重入计数器的作用。</p>
<p>重量级锁：进入重量级锁，会分配一个objectmonitor对象，然后将锁标志置为‘10’，然后markword存储指向这个对象的指针。om对象有两个队列和一个指针，每个需要获取锁的线程都会进入队列被包装为这个对象，如果是多线程指向同一段代码时，objectwaiter就会进入队列，当某个线程抢到锁了也就是获得对象的监视器monitor了就进入owner区域，并把monitor中的owner变量设为当前线程同时monitor中的计数器count+1。（锁重入）</p>
<h3 id="Sych的锁升级的原理或者是过程？">==Sych的锁升级的原理或者是过程？==</h3>
<p>首先主要有四种锁状态分别是：无状态锁、偏向锁、轻量级锁和重量级锁（要去操作系统申请资源）</p>
<p>锁的升级的目的/背景：锁升级是为了减低了锁带来的性能消耗。在 Java 6 之后优化 synchronized 的实现方式，使用了偏向锁升级为轻量级锁再升级到重量级锁的方式，从而减低了锁带来的性能消耗。</p>
<img src="多线程/image-20220304103932619.png" alt="image-20220304103932619" style="zoom:50%;" />
<img src="多线程/image-20220304232258996.png" alt="image-20220304232258996" style="zoom: 50%;" />
<h4 id="详细锁升级过程：">详细锁升级过程：</h4>
<p>总：在锁对象的<strong>对象头</strong>里面有一个 threadID 字段，在第一次访问的时候 threadid 为空，jvm 让其持有偏向锁，并将 threadid 设置为其线程 id，再次进入的时候会先判断 threadid 是否与其线程 id 一致，如果一致则可以直接使用此对象，如果不一致，则升级偏向锁为轻量级锁，通过自旋循环一定次数来获取锁，执行一定次数之后，如果还没有正常获取到要使用的对象，此时就会把锁从轻量级升级为重量级锁，此过程就构成了 synchronized 锁的升级。</p>
<p>分：new对象之后先判断是否为可偏向状态，markword有两个字节作为锁标志：首先看是否是‘01’，然后mw前面还有一个字段来判断是否是已经拿到偏向锁‘1’表示偏向锁已启动，启动但是要判断锁线程是否是当前的线程id，如果是就开始执行代码块；但是不是的话，说明就有竞争了，这个时候cas操作去获取锁失败了的话，达到safepoint时获得偏向锁的线程就会被挂起，偏向锁会被撤销，然后<strong>升级为轻量级锁，这个时候被阻塞的线程再继续执行同步代码块。</strong></p>
<p>这部分有个细节就是<strong>轻度竞争就会升级为轻量级锁</strong>，如果是重度竞争（比如耗时过长、调用了wait方法等）就会直接升级为重量级锁，先讲轻量级锁：</p>
<p>升级为轻量级锁以后还是在<u>用户空间</u>里面进行，当前线程栈会划分一部分作为锁记录lock record，并且会将锁对象的markwor复制到锁记录中，接下来jvm会进行CAS操作将markword一部分更新为指向锁记录的指针（如下图），</p>
<img src="多线程/image-20220304234448327.png" alt="image-20220304234448327" style="zoom:33%;" />
<p>如果成功就会将锁标志位设为‘00’，说明已经获得轻量级锁，这个时候就会进入<strong>锁重入</strong>阶段：（底下的锁重入有解释）</p>
<p>但是失败了就会检查当前锁对象的markword是否指向当前锁记录，如果没有就表示已经被其他线程抢了，这个时候就会进行自旋等待（默认是10次），等到此处如果超出阈值还是没有获得锁这个时候就会<strong>升级为重量级锁</strong></p>
<p>进入重量级锁，会分配一个objectmonitor对象，然后将锁标志置为‘10’，然后markword存储指向这个对象的指针。om对象有两个队列和一个指针，每个需要获取锁的线程都会进入队列被包装为这个对象，如果是多线程指向同一段代码时，objectwaiter就会进入队列，当某个线程抢到锁了也就是获得对象的监视器monitor了就进入owner区域，并把monitor中的owner变量设为当前线程同时monitor中的计数器count+1。（锁重入）</p>
<h3 id="什么时候用自旋锁和系统锁？-为什么有了自旋锁还要重量级锁？">什么时候用自旋锁和系统锁？/ 为什么有了自旋锁还要重量级锁？</h3>
<p>因为自旋锁是要占用CPU的，而系统锁是到等待队列里面，所以你，代码如果执行时间短，线程数少就用自旋，长线程数多，就用系统锁；</p>
<p>自旋也是要消耗cpu资源的如果锁的时间过长或者自旋线程过多，cpu就会被消耗； 而重量级锁又自己的等待队列，所有拿不到所有的进入等待队列，不需要消耗cpu资源。</p>
<h3 id="什么时候升级为重量级锁？">什么时候升级为重量级锁？</h3>
<p>竞争加剧，有线程超过10次自旋：<code>-xx:PreBlockSpin</code> ；或者是自旋线程数超过cpu核数的一半，1.6之后jvm有了自适应自旋Adapative-Self Spinning，是可以自己控制的自旋；</p>
<h3 id="偏向锁是否启动？">偏向锁是否启动？</h3>
<p>偏向锁有一个启动时间，我记得是四秒钟，当你new一个普通对象的时候，偏向锁没有启动，它默认就是无锁态；但是一开始new的时候如果已经启动了偏向锁，那么就是一个匿名偏向，锁对象的markword里的threadkid其实就是空的，等到你加了sychronized（这个对象），才会指向当前的这个线程了，treadid字段就会更新为当前线程了。</p>
<h1>Lock体系</h1>
<h3 id="Java-Concurrency-API-中的-Lock-接口-Lock-interface-是什么？对比同步它有什么优势？">Java Concurrency API 中的 Lock 接口(Lock interface)是什么？对比同步它有什么优势？</h3>
<p><u>ReentrantLock是lock的唯一子类。</u></p>
<p>Lock 接口比同步方法和同步块提供了更具扩展性的锁操作。他们允许更灵活的结构，可以具有完全不同的性质，并且可以支持多个相关类的条件对象。</p>
<p>它的优势有：</p>
<p>（1）  可以使锁更公平</p>
<p>（2）  可以使线程在等待锁的时候响应中断</p>
<p>（3）  可以让线程尝试获取锁，并在无法获取锁的时候立即返回或者等待一段时间</p>
<p>（4）  可以在不同的范围，以不同的顺序获取和释放锁</p>
<p>整体上来说 Lock 是 synchronized 的扩展版，Lock 提供了无条件的、可轮询的(tryLock 方法)、定时的(tryLock 带参方法)、可中断的(lockInterruptibly)、可多条件队列的(newCondition 方法)锁操作。另外 Lock 的实现类基本都支持非公平锁(默认)和公平锁，synchronized 只支持非公平锁，当然，在大部分情况下，非公平锁是高效的选择。</p>
<h3 id="实现一个阻塞队列？-使用Condition写生产者和消费者？">==实现一个阻塞队列？/ 使用Condition写生产者和消费者？==</h3>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProviderConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">&#123;</span>
  <span class="token keyword">private</span> <span class="token keyword">int</span> length<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> queue<span class="token punctuation">;</span> <span class="token comment">// 产品队列</span>
  <span class="token keyword">private</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可重入锁</span>
  <span class="token keyword">private</span> <span class="token class-name">Condition</span> providerCondition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newConditon</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 生产者</span>
  <span class="token keyword">private</span> <span class="token class-name">Condition</span> consumerCondition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 消费者</span>
  
  <span class="token keyword">public</span> <span class="token class-name">ProviderConsumer</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 构造器一开始传入产品队列的长度</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token comment">/*
  * 生产
  */</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">provide</span><span class="token punctuation">(</span><span class="token class-name">T</span> product<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> length<span class="token punctuation">)</span><span class="token punctuation">&#123;</span><span class="token comment">// 生产者队列等待</span>
        providerCondition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
      consumerCondition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 提醒消费者队列；</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span><span class="token punctuation">&#123;</span>
      lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">/*
  * 消费
  */</span>
  <span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">consume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
    lock<span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">while</span><span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        consumerCondition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token class-name">T</span> product <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      provideCondition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> product<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      
    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span><span class="token punctuation">&#123;</span>
      lock<span class="token punctuation">.</span>unlock<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  
<span class="token punctuation">&#125;</span></code></pre>
<h1>AQS</h1>
<h2 id="AQS-原理分析">AQS 原理分析</h2>
<p>下面大部分内容其实在AQS类注释上已经给出了，不过是英语看着比较吃力一点，感兴趣的话可以看看源码。</p>
<h3 id="AQS-原理概览">AQS 原理概览</h3>
<p>AQS核心思想是，如果被请求的共享资源空闲，则将当前请求资源的线程设置为有效的工作线程，并且将共享资源设置为锁定状态。如果被请求的共享资源被占用，那么就需要一套线程阻塞等待以及被唤醒时锁分配的机制，这个机制AQS是用CLH队列锁实现的，即将暂时获取不到锁的线程加入到队列中。CLH(Craig,Landin,and Hagersten)队列是一个虚拟的双向队列（虚拟的双向队列即不存在队列实例，仅存在结点之间的关联关系）。AQS是将每条请求共享资源的线程封装成一个CLH锁队列的一个结点（Node）来实现锁的分配。</p>
<p>看个AQS(AbstractQueuedSynchronizer)原理图：</p>
<img src="多线程/image-20201109202131975.png" alt="image-20201109202131975" style="zoom: 67%;" />
<h3 id="源码">源码</h3>
<p>AQS是一个构建锁和同步器的框架，最核心的是它的一个共享的int类型值叫做state，这个state用来干什么，其实主要是看他的子类是怎么实现的，比如ReentrantLock这个state，拿这个state来记录这个线程到底重入了多少次，比如说有一个线程拿到state这个把锁了，state的值就从0变成了1，这个线程又重入了一次，state就变成2了，又重入一次就变成3等等，释放的时候一次释放减一变成0就释放了。这个数代表了什么要看子类怎么去实现它，那么在这个state核心上还会有一堆的线程节点，当然这个节点是node，每个node里面包含一个线程，我们称为线程节点，这么多的线程节点去争用这个state，谁拿到了state，就表示谁得到了这把锁，AQS得核心就是一个共享的数据和一堆互相抢夺竞争的线程，这个就是AQS。</p>
<p>看reentrantlock源码里面:</p>
<p>在lock()方法里里面，我们可以读到它调用了sync.acquire(1)，</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">//JDK源码</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>再跟进到acquire(1)里，可以看到acquire(1)里又调用了我们自己定义自己写的那个tryAcquire(arg)</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">//JDK源码</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractQueuedSynchronizer</span>
    <span class="token keyword">extends</span> <span class="token class-name">AbstractOwnableSynchronizer</span>
    <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">acquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">tryAcquire</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> 
           <span class="token operator">&amp;&amp;</span> <span class="token function">acquireQueued</span><span class="token punctuation">(</span><span class="token function">addWaiter</span><span class="token punctuation">(</span><span class="token class-name">Node</span><span class="token punctuation">.</span><span class="token constant">EXCLUSIVE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span>
       	 <span class="token function">selfInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>tryAquire(int)是使用者需要自定义同步器时要重写的模版方法：reentrantlock()里面的这个方法又调用了nofairTryAquire(int aquire)</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">//JDK源码</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLock</span> <span class="token keyword">implements</span> <span class="token class-name">Lock</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
    
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        sync<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">NonfairSync</span> <span class="token keyword">extends</span> <span class="token class-name">Sync</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">tryAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquire<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token keyword">return</span> <span class="token function">nonfairTrytAcquire</span><span class="token punctuation">(</span>acquires<span class="token punctuation">)</span><span class="token punctuation">;</span>
	   <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">nonfairTrytAcquire</span><span class="token punctuation">(</span><span class="token keyword">int</span> acquire<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
         <span class="token comment">//获取当前线程</span>
		<span class="token keyword">final</span> <span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//拿到AQS核心数值state</span>
         <span class="token keyword">int</span> c <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//如果数值为0说明没人上锁</span>
         <span class="token keyword">if</span><span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
             <span class="token comment">//给当线程上锁</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>acquires<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
                <span class="token comment">//设置当前线程为独一无二拥有这把锁的线程</span>
			    <span class="token function">setExclusiveOwnerThread</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">&#125;</span>
         <span class="token punctuation">&#125;</span>
        <span class="token comment">//判断当前线程是否拥有这个把锁</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>current <span class="token operator">==</span> getExclusiveOwnerThread<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
            <span class="token comment">//设置重入</span>
			<span class="token keyword">int</span> nextc <span class="token operator">=</span> c <span class="token operator">+</span> acquires<span class="token punctuation">;</span>
             <span class="token keyword">if</span><span class="token punctuation">(</span>nextc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                 <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">"Maximum lock count wxceeded"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token function">setState</span><span class="token punctuation">(</span>nextc<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
         <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>nonfairTrytAcquire(acquires)我们读进去会发现它的里面就调用到了state这个值，首先拿到当前线程，拿到state的值，然后进行if判断，如果state的值为0，说明没人上锁，没人上锁怎么办呢？就给自己上锁，当前线程就拿到这把锁，拿到这个把锁的操作用到了CAS(compareAndSetState)的操作，从0让他变成1，state的值设置为1以后，设置当前线程是独一无二的拥有这把锁的线程，否则如果当前线程已经占有这把锁了，怎么办？很简单我们在原来的基础上加1就可以了，这样就能拿到这把锁了，就重入，前者是加锁后者是重入</p>
<h4 id="state状态变量">state状态变量</h4>
<p>AQS使用一个int成员变量来表示同步状态，通过内置的FIFO队列来完成获取资源线程的排队工作。AQS使用CAS对该同步状态进行原子操作实现对其值的修改。</p>
<pre class="language-none"><code class="language-none">private volatile int state;&#x2F;&#x2F;共享变量，使用volatile修饰保证线程可见性</code></pre>
<p>状态信息通过protected类型的getState，setState，compareAndSetState进行操作</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token number">1</span>	<span class="token comment">//返回同步状态的当前值</span>
<span class="token number">2</span>	<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token number">3</span>	<span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token number">4</span>	<span class="token punctuation">&#125;</span>
<span class="token number">5</span>	<span class="token comment">// 设置同步状态的值</span>
<span class="token number">6</span>	<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token keyword">int</span> newState<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token number">7</span>	state <span class="token operator">=</span> newState<span class="token punctuation">;</span>
<span class="token number">8</span>	<span class="token punctuation">&#125;</span>
<span class="token number">9</span>	<span class="token comment">//原子地（CAS操作）将同步状态值设置为给定值update如果当前同步状态的值等于expect （期望值）</span>
<span class="token number">10</span>	<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token keyword">int</span> expect<span class="token punctuation">,</span> <span class="token keyword">int</span> update<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
<span class="token number">11</span> <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> stateOffset<span class="token punctuation">,</span> expect<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">12</span> <span class="token punctuation">&#125;</span></code></pre>
<h4 id="AQS队列">AQS队列</h4>
<p><strong>如果没有tryAquire() 到state呢</strong>，那么就进行aquireQueue()方法，里面会调用addwaiter()这个方法，线程添加进入队列里面，具体操作也是通过cas进行添加的，方法是compareAndAetTail(oldTail,node)，oldTail是它的预期值，假如说我们想把当前线程设置为整个链表尾巴的过程中，另外一个线程来了，它插入了一个节点，那么仔细想一下Node oldTail = tail;的整个oldTail还等于整个新的Tail吗？不等于了吧，那么既然不等于了，说明中间有线程被其它线程打断了，那如果说却是还是等于原来的oldTail，这个时候就说明没有线程被打断，那我们就接着设置尾巴，只要设置成功了OK，compareAndAetTail(oldTail,node)方法中的参数node就做为新的Tail了，所以用了CAS操作就不需要把原来的整个链表上锁，这也是AQS在效率上比较高的核心。</p>
<img src="多线程/image-20220308201744929.png" alt="image-20220308201744929" style="zoom:50%;" />
<h2 id="资源的共享方式">资源的共享方式</h2>
<p>AQS定义两种资源共享方式</p>
<ul>
<li>
<p>Exclusive（独占）：只有一个线程能执行，如ReentrantLock。又可分为公平锁和非公平锁：</p>
<p>公平锁：按照线程在队列中的排队顺序，先到者先拿到锁</p>
<p>非公平锁：当线程要获取锁时，无视队列顺序直接去抢锁，谁抢到就是谁的</p>
</li>
<li>
<p>Share（共享）：多个线程可同时执行。Semaphore、CountDownLatch、 CyclicBarrier、ReadWriteLock 我们都会在后面讲到。ReentrantReadWriteLock 可以看成是组合式，因为ReentrantReadWriteLock也就是读写锁允许多个线程同时对某一资源进行读。不同的自定义同步器争用共享资源的方式也不同。自定义同步器在实现时只需要实现共享资源 state 的获取与释放方式即可，至于具体线程等待队列的维护（如获取资源失败入队/唤醒出队等），AQS已经在顶层实现好了。</p>
</li>
</ul>
<h2 id="模版方法">模版方法</h2>
<p>AQS使用了模板方法模式，自定义同步器时需要重写下面几个AQS提供的模板方法：</p>
<pre class="language-none"><code class="language-none">1	isHeldExclusively()&#x2F;&#x2F;该线程是否正在独占资源。只有用到condition才需要去实现它。
2	tryAcquire(int)&#x2F;&#x2F;独占方式。尝试获取资源，成功则返回true，失败则返回false。
3	tryRelease(int)&#x2F;&#x2F;独占方式。尝试释放资源，成功则返回true，失败则返回false。
4	tryAcquireShared(int)&#x2F;&#x2F;共享方式。尝试获取资源。负数表示失败；0表示成功，但没有剩余可用资源；正数表示成功，且有剩余资源。
5	tryReleaseShared(int)&#x2F;&#x2F;共享方式。尝试释放资源，成功则返回true，失败则返回false。</code></pre>
<p>默认情况下，每个方法都抛出 UnsupportedOperationException。 这些方法的实现必须是内部线程安全的，并且通常应该简短而不是阻塞。AQS类中的其他方法都是final ，所以无法被其他类使用，只有这几个方法可以被其他类使用。以ReentrantLock为例，state初始化为0，表示未锁定状态。A线程lock()时，会调用tryAcquire()独占该锁并将state+1。此后，其他线程再tryAcquire()时就会失败，直到A线程unlock()到state=0（即释放锁）为止，其它线程才有机会获取该锁。当然，释放锁之前，A线程自己是可以重复获取此锁的（state会累加），这就是可重入的概念。但要注意，获取多少次就要释放多么次，这样才能保证state是能回到零态的。</p>
<p>再以CountDownLatch以例，任务分为N个子线程去执行，state也初始化为N（注意N要与线程个数一致）。这N个子线程是并行执行的，每个子线程执行完后countDown()一次，state会CAS(Compare and Swap)减1。等到所有子线程都执行完后(即state=0)，会unpark()主调用线程，然后主调用线程就会从 await()函数返回，继续后余动作。</p>
<p>一般来说，自定义同步器要么是独占方法，要么是共享方式，他们也只需实现 tryAcquire-tryRelease、tryAcquireShared-tryReleaseShared中的一种即可。但AQS 也支持自定义同步器同时实现独占和共享两种方式，如ReentrantReadWriteLock。主要是高16位存储互斥锁的状态，高16位存储共享锁的状态。</p>
<h2 id="并发工具类">并发工具类</h2>
<h3 id="CountDownLatch-倒计时器-：">CountDownLatch(倒计时器)：</h3>
<p>CountDownLatch是一个同步工具类，用来协调多个线程之间的同步。这个工具通常用来控制线程等待，它可以让某一个线程等待直到倒计时结束，再开始执行。</p>
<h4 id="用法？">用法？</h4>
<ol>
<li>让主线程await()， 主线程在开始运行前等待n个业务线程执行完毕。将CountDownLatch的计数器初始化为new CountDownLatch(n)，每当一个任务线程执行完毕，就将计数器减1 countdownLatch.countDown()，当计数器的值变为0时，在CountDownLatch上await()的线程就会被唤醒。一个典型应用场景就是启动一个服务时，主线程需要等待多个组件加载完毕，之后再继续执行。</li>
<li>让业务线程await()，主线程处理完数据之后进行countDownLatch.countDown(),此时业务线程被唤醒，然后去主线程拿数据，或者执行自己的业务逻辑，这样实现多个线程开始执行任务的最大并行性，</li>
</ol>
<h3 id="CyclicBarrier-循环栅栏-：">CyclicBarrier(循环栅栏)：</h3>
<p>CyclicBarrier 和 CountDownLatch 非常类似，它也可以实现线程间的技术等待，但是它的功能比 CountDownLatch 更加复杂和强大。主要应用场景和 CountDownLatch 类似。CyclicBarrier 的字面意思是可循环使用（Cyclic）的屏障（Barrier）。它要做的事情是，让一组线程到达一个屏障（也可以叫同步点）时被阻塞，直到最后一个线程到达屏障时，屏障才会开门，所有被屏障拦截的线程才会继续干活。</p>
<p>CyclicBarrier默认的构造方法是 CyclicBarrier(int parties)，其参数表示屏障拦截的线程数量，每个线程调用await()方法告诉CyclicBarrier 我已经到达了屏障，然后当前线程被阻塞。</p>
<h3 id="Semaphore-信号量-允许多个线程同时访问：">Semaphore(信号量)-允许多个线程同时访问：</h3>
<p>synchronized 和ReentrantLock 都是一次只允许一个线程访问某个资源，Semaphore(信号量)可以指定多个线程同时访问某个资源。</p>
<p>Semaphore 就是一个信号量，它的作用是限制某段代码块的并发数。</p>
<p>Semaphore有一个构造函数，可以传入一个 int 型整数 n，表示某段代码 多只有 n 个线程可以访问，如果超出了 n，那么请等待，等到某个线程执行完毕这段代码块，下一个线程再进入。由此可以看出如果 Semaphore 构造函数中传入的 int 型整数 n=1，相当于变成了一个 synchronized 了。</p>
<h3 id="Exchange-线程见交换数据的工具">Exchange(线程见交换数据的工具)</h3>
<p>Exchanger是一个用于线程间协作的工具类，**用于两个线程间交换数据。**它提供了一个交换的同步点，在这个同步点两个线程能够交换数据。交换数据是通过 exchange方法来实现的，如果一个线程先执行exchange方法，那么它会同步等待另一个线程也执行exchange方法，这个时候两个线程就都达到了同步点，两个线程就可以交换数据。</p>
<h3 id="ReadWriteLock">ReadWriteLock</h3>
<p><strong>实现这个接口是ReentrantReadWriteLock， 这个接口是一个读写锁接口，主要就是实现了读写分离，写锁是独占锁，读锁是共享锁，实现了读读之间不会互斥，但是读写和写写之间的互斥，提高了读写效率。还实现了锁降级，写锁可以降级为读锁。</strong></p>
<p>首先明确一下，不是说 ReentrantLock 不好，只是 ReentrantLock 某些时候有局限。如果使用 ReentrantLock，可能本身是为了防止线程 A 在写数据、线程 B 在读数据造成的数据不一致，但这样，如果线程 C 在读数据、线程 D 也在读数据，读数据是不会改变数据的，没有必要加锁，但是还是加锁了，降低了程序的性能。因为这个，才诞生了读写锁 ReadWriteLock。</p>
<p>ReadWriteLock 是一个读写锁接口，读写锁是用来提升并发程序性能的锁分离技术，ReentrantReadWriteLock 是 ReadWriteLock 接口的一个具体实现，实现了读写的分离，读锁是共享的，写锁是独占的，读和读之间不会互斥，读和写、写和读、写和写之间才会互斥，提升了读写的性能。</p>
<p>而读写锁有以下三个重要的特性：</p>
<p>（1）  公平选择性：支持非公平（默认）和公平的锁获取方式，吞吐量还是非公平优于公平。</p>
<p>（2）  重进入：读锁和写锁都支持线程重进入。</p>
<p>（3）  锁降级：遵循获取写锁、获取读锁再释放写锁的次序，写锁能够降级成为读锁。</p>
<h1>ThreadLocal</h1>
<h2 id="原理">原理</h2>
<p>ThreadLocal源码的set方法，ThreadLocal往里边设置值的时候是怎么设置的呢？首先拿到当前线程，这是你会发现，这个set方法里多了一个容器ThreadLocalMap，这个容器是一个map，是一个key/value对，其实这个值是设置到了map里面，key设置的是this，value设置的是我们想要的那个值，这个this就是当前对象ThreadLocal，value就是Person类，如果map不等于空的情况下就设置进去就行了，如果等于空呢？就创建一个map</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">//ThraedLocal源码</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>我们回过头来看这个map，ThreadLocalMap map=getMap(t)，我们来看看这个map到底在哪里，我们点击到了getMap这个方法看到，它的返回值是t.threadLocals</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">//ThreadLocal源码</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadLocalMap</span> map <span class="token operator">=</span> <span class="token function">getMap</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">createMap</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token class-name">ThreadLocalMap</span> <span class="token function">getMap</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> t<span class="token punctuation">.</span>threadLocals<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>我们进入这个t.threadLocals，你会发现ThreadLocalMap这个东西在哪里呢？居然是在Thread这个类里，所以说这个map是在Thred类里的</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Thread</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span>
	<span class="token class-name">ThreadLocal<span class="token punctuation">.</span>ThreadLocalMap</span> threadLocals <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>这个时候我们应该明白，map的set方法其实就是设置当前线程里面的map：</p>
<pre class="language-latex" data-language="latex"><code class="language-latex">·set
	- Thread.currentThread.map(ThreadLocal,person)</code></pre>
<p>所以这个时候你会发现，原来Person类被set到了，当前线程里的某一个map里面去了，这个时候，我们是不是就能想明白了，我set了一个值以后，为什么其他线程访问不到？我们注重“当前线程”这个段话，所以个t1线程set了一个Person对象到自己的map里，t2线程去访问的也是自己的属于t2线程的map，所以是读不到值的，因此你使用ThreadLocal的时候，你用set和get就完全的把他隔离开了，就是我自己线程里面所特有的，其它的线程是没有的，以前我们的理解是都在一个map，然而并不是，所以你得读源码，读源码你就明白了</p>
<h2 id="用途">用途</h2>
<p>声明式的事务保证同一个connetion</p>
<p>我们根据Spirng的声明式事务来解析，为什么要用ThreadLocal，声明式事务一般来讲我们是要通过数据库的，但是我们知道Spring结合Mybatis，我们是可以把整个事务写在配置文件中的，而这个配置文件里的事务，它实际上是管理了一系列的方法，方法1、方法2、方法3…，而这些方法里面可能写了，比方说第1个方法写了去配置文件里拿到数据库连接Connection，第2个、第3个都是一样去拿数据库连接，然后声明式事务可以把这几个方法合在一起，视为一个完整的事务，如果说在这些方法里，每一个方法拿的连接，它拿的不是同一个对象，你觉的这个东西能形成一个完整的事务吗？Connection会放到一个连接池里边，如果第1个方法拿的是第1个Connection，第2个拿的是第2个，第3个拿的是第3个，这东西能形成一个完整的事务吗？百分之一万的不可能，没听说过不同的Connection还能形成一个完整的事务的，那么怎么保证这么多Connection之间保证是同一个Connection呢？把这个Connection放到这个线程的本地对象里ThreadLocal里面，以后再拿的时候，实际上我是从ThreadLocal里拿的，第1个方法拿的时候就把Connection放到ThreadLocal里面，后面的方法要拿的时候，从ThreadLocal里直接拿，不从线程池拿。</p>
<h2 id="四种引用">四种引用</h2>
<h3 id="引用是什么？">引用是什么？</h3>
<p>就是一个变量值指向一个对象</p>
<h3 id="强引用normalReference">强引用normalReference</h3>
<p>普通的引用比如Object o = new Object()，这个就叫强引用; 特点就是说，只要有一个应用指向这个对象，那么垃圾回收器一定不会回收它，这就是普通的引用，也就是强引用。因为有引用指向，所以不会回收，只有没有引用指向的时候才会回收，指向谁？指向你创建的那个对象。</p>
<h3 id="弱引用softReference">弱引用softReference</h3>
<p>当有一个对象(字节数组)被一个软引用所指向的时候，只有系统内存不够用的时候，才会回收它(字节数组)</p>
<h3 id="虚引用">虚引用</h3>
<h4 id="在threadlocal的应用-内存泄露">==在threadlocal的应用 / 内存泄露==</h4>
<img src="多线程/image-20220310175800308.png" alt="image-20220310175800308" style="zoom:60%;" />
<p>我们来看图中从左开始看，这时候我们应该明白了，这里tl是一个强引用指向这个ThreadLocal对象，而Map里的key是通过一个弱引用指向了一个ThreadLocal对象，我们假设这是个强引用，当tl指向这个ThreadLocal对象消失的时候，tl这个东西是个局部变量，方法已结束它就消失了，当tl消失了，如果这个ThreadLocal对象还被一个强引用的key指向的时候，这个ThreadLocal对象不能被回收，而且由于这个线程有很多线程是长期存在的，比如这个是一个服务器线程，7*24小时一年365天不间断运行，那么不间断运行的时候，这个tl会长期存在，这个Map会长期存在，这个Map的key也会长期存在，这个key长期存在的话，这个ThreadLocal对象永远不会被消失，所以这里是不是就会有内存泄漏，但是如果这个key是弱引用的话还会存在这个问题吗？当这个强引用消失的时候这个弱引用是不是自动就会回收了，这也是为什么用WeakReference的原因</p>
<p>关于ThreadLocal还有一个问题，当我们tl这个强引用消失了，key的指向也被回收了，可是很不幸的是这个key指向了一个null值，但是这个threadLocals的Map是永远存在的，相当于说key/value对，你这个key是null的，你这个value指向的东西，你的这个10MB的字节码，你还能访问到吗？访问不到了，如果这个Map越积攒越多，越来越多，它还是会内存泄漏，怎么办呢？所以必须记住这一点，使用ThreadLocal里面的对象不用了，务必要remove掉，不然还会有内存泄漏</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token class-name">ThradLocalM</span><span class="token operator">></span> tl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tl<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">M</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tl<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h1>JUC同步容器</h1>
<h2 id="ConcurrentHashMap">ConcurrentHashMap</h2>
<p>集合部分</p>
<p>我们来看这个经常在多线程的情况下使用的这些个容器 ，从Map开始讲，Map经常用的有这么几个</p>
<ul>
<li>
<p>ConcurrentHashMap用hash表实现的这样一个高并发容器；</p>
<p>既然有了ConcurrentHashMap正常情况下就应该有ConcurrentTreeMap，你可以去查查，它没有，就等于缺了一块，为什么没有呢，原因就是ConcurrentHashMap里面用的是cas操作，这个cas操作它用在tree的时候，用在树这个节点上的时候实现起来太复杂了，所以就没有这个ConcurrentTreeMap，但是有时间也需要这样一个排好序的Map，那就有了ConcurrentSkipListMap跳表结构就出现了。</p>
</li>
<li>
<p>ConcurrentSkipListMap通过跳表来实现的高并发容器并且这个Map是有排序的；</p>
<img src="多线程/06_02.jpg" alt="06_02" style="zoom:67%;" />
<p>跳表是什么样的结构呢？底层本身存储的元素一个链表，它是排好顺序的，大家知道当一个链表排好顺序的时候往里插入是特别困难的，查找的时候也特别麻烦，因为你得从头去遍历查找这个元素到底在哪里，所以就出现了这个跳表的结构，底层是一个链表，链表查找的时候比较困难怎么办，那么我们在这些链表的基础上在拿出一些关键元素来，在上面做一层，那这个关键元素的这一层也是一个链表，那这个数量特别大的话在这个基础之上在拿一层出来再做一个链表，每层链表的数据越来越少，而且它是分层，在我们查找的时候从顶层往下开始查找，所以呢，查找容易了很多，同时它无锁的实现难度比TreeMap又容易很多，因此在JUC里面提供了ConcurrentSkipListMap这个类。</p>
</li>
</ul>
<p>他们两个的区别一个是有序的一个是无序的，同时都支持并发的操作。下面这个小程序是一个效率的测试其实也没多大意义，大家可以去写一下跑跑。</p>
<h2 id="CopyOnWriteArrayList">CopyOnWriteArrayList</h2>
<h3 id="CopyOnWriteArrayList-是什么，可以用于什么应用场景？有哪些优缺点？">CopyOnWriteArrayList 是什么，可以用于什么应用场景？有哪些优缺点？</h3>
<p>CopyOnWriteArrayList 是一个并发容器。有很多人称它是线程安全的，我认为这句话不严谨，缺少一个前提条件，那就是非复合场景下操作它是线程安全的。</p>
<p>CopyOnWriteArrayList(免锁容器)的好处之一是当多个迭代器同时遍历和修改这个列表时，不会抛出 ConcurrentModificationException。在CopyOnWriteArrayList 中，写入将导致创建整个底层数组的副本，而源数组将保留在原地，使得复制的数组在被修改时，读取操作可以安全地执行。</p>
<p>CopyOnWriteArrayList 的使用场景通过源码分析，我们看出它的优缺点比较明显，所以使用场景也就比较明显。就是合适读多写少的场景。</p>
<p>CopyOnWriteArrayList 的缺点</p>
<ol>
<li>
<p>由于写操作的时候，需要拷贝数组，会消耗内存，如果原数组的内容比较多的情况下，可能导致 young gc 或者 full gc。</p>
</li>
<li>
<p>不能用于实时读的场景，像拷贝数组、新增元素都需要时间，所以调用一个 set 操作后，读取到数据可能还是旧的，虽然CopyOnWriteArrayList 能做到始终一致性,但是还是没法满足实时性要求。</p>
</li>
<li>
<p>由于实际使用中可能没法保证 CopyOnWriteArrayList 到底要放置多少数据，万一数据稍微有点多，每次 add/set 都要重新复制数组，这个代价实在太高昂了。在高性能的互联网应用中，这种操作分分钟引起故障。</p>
</li>
</ol>
<p>CopyOnWriteArrayList 的设计思想</p>
<ol>
<li>读写分离，读和写分开</li>
<li>终一致性</li>
<li>使用另外开辟空间的思路，来解决并发冲突</li>
</ol>
<h2 id="BlockingQueue">BlockingQueue</h2>
<h3 id="ArrayBlockingQueue"><strong>ArrayBlockingQueue</strong></h3>
<p>ArrayBlockingQueue是有界的，你可以指定它一个固定的值10，它容器就是10，那么当你往里面扔容器的时候，一旦他满了这个put方法就会阻塞住。然后你可以看看用add方法满了之后他会报异常。offer用返回值来判断到底加没加成功，offer还有另外一个写法你可以指定一个时间尝试着往里面加1秒钟，1秒钟之后如果加不进去它就返回了。</p>
<p>回到那个面试经常被问到的问题，Queue和List的区别到底在哪里，主要就在这里，添加了offer、peek、poll、put、take这些个对线程友好的或者阻塞，或者等待方法。</p>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>juc<span class="token punctuation">.</span>c_025</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ArrayBlockingQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">BlockingQueue</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T06_ArrayBlockingQueue</span> <span class="token punctuation">&#123;</span>

   <span class="token keyword">static</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> strs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">static</span> <span class="token class-name">Random</span> r <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
         strs<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"a"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      
      <span class="token comment">//strs.put("aaa"); //满了就会等待，程序阻塞</span>
      <span class="token comment">//strs.add("aaa");</span>
      <span class="token comment">//strs.offer("aaa");</span>
      strs<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span><span class="token string">"aaa"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>strs<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<h3 id="Queue和List的区别">Queue和List的区别</h3>
<p>区别主要就是Queue添加了许多对线程友好的API offer、peek、poll，他的一个子类型叫BlockingQueue对线程友好的API又添加了put和take，这两个实现了阻塞操作。</p>
<h1>线程池</h1>
<img src="多线程/image-20220314163745382.png" alt="image-20220314163745382" style="zoom:50%;" />
<h2 id="Executor-线程的工厂">Executor(线程的工厂</h2>
<h3 id="newSingleThreadPool">newSingleThreadPool</h3>
<p>这个线程池里面只有一个线程，这个一个线程的线程池可以保证我们扔进去的任务是顺序执行的。为什么会有单线程的线程池？第一个线程池是有任务队列的；生命周期管理线程池是能帮你提供的。</p>
<h3 id="newCachedThreadPool没上限">newCachedThreadPool没上限</h3>
<p>来一个新的任务就必须马上执行，没有线程空着我就new一个线程。那么阿里是不会推荐使用这中线程池的，原因是线程会启动的特别多，基本接近于没有上限的。</p>
<h3 id="newFixedThreadPool-固定的">newFixedThreadPool 固定的</h3>
<p>指定一个参数，到底有多少个线程，他的核心线程和最大线程都是固定的，因为他的最大线程和核心线程都是固定的就没有回收之说所以把他指定成0，这里用的是LinkedBlockingQueue</p>
<h3 id="newScheduledThreadPool定时任务">newScheduledThreadPool定时任务</h3>
<p>这是专门给定时任务用的这样的一个线程池，了解就可以了。</p>
<h2 id="ThreadPoolExecutor">ThreadPoolExecutor</h2>
<h3 id="1-状态">1. 状态</h3>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token comment">// 4. 线程池有5种状态，按大小排序如下：RUNNING &lt; SHUTDOWN &lt; STOP &lt; TIDYING &lt; TERMINATED</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RUNNING</span>    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SHUTDOWN</span>   <span class="token operator">=</span>  <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STOP</span>       <span class="token operator">=</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TIDYING</span>    <span class="token operator">=</span>  <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TERMINATED</span> <span class="token operator">=</span>  <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
</code></pre>
<p>RUNNING：正常运行的；</p>
<p>SHUTDOWN：调用了shutdown方法了进入了shutdown状态；</p>
<p>STOP：调用了shutdownnow马上让他停止；</p>
<p>TIDYING：调用了shutdown然后这个线程也执行完了，现在正在整理的这个过程叫TIDYING；</p>
<p>TERMINATED：整个线程全部结束；</p>
<img src="多线程/image-20220314162532547.png" alt="image-20220314162532547" style="zoom:50%;" />
<p>⚠️多线程的生命周期和线程的生命周期</p>
<h3 id="2-构造方法参数">2. 构造方法参数</h3>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">int</span> maximumPoolSize<span class="token punctuation">,</span>
                          <span class="token keyword">long</span> keepAliveTime<span class="token punctuation">,</span>
                          <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span>
                          <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">></span></span> workQueue<span class="token punctuation">,</span>
                          <span class="token class-name">ThreadFactory</span> threadFactory<span class="token punctuation">,</span>
                          <span class="token class-name">RejectedExecutionHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 基本类型参数校验</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>corePoolSize <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span>
        maximumPoolSize <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span>
        maximumPoolSize <span class="token operator">&lt;</span> corePoolSize <span class="token operator">||</span>
        keepAliveTime <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 空指针校验</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>workQueue <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> threadFactory <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> handler <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>maximumPoolSize <span class="token operator">=</span> maximumPoolSize<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>workQueue <span class="token operator">=</span> workQueue<span class="token punctuation">;</span>
    <span class="token comment">// 根据传入参数`unit`和`keepAliveTime`，将存活时间转换为纳秒存到变量`keepAliveTime `中</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>keepAliveTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>threadFactory <span class="token operator">=</span> threadFactory<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>corePoolSize核心线程数</p>
<p>maximumPS最大线程数</p>
<p>keepAliveTime销毁之前等待的时间</p>
<p>TimeUnit时间单位</p>
<p>BlockingQueue任务队列<br>
LinkedBQ<br>
ArrayBQ<br>
SynchronousBQ</p>
<p>ThreadFactory线程工厂</p>
<p>RejectStrategy拒绝策略<br>
Abort抛异常<br>
Discard扔掉<br>
DiscardOldest<br>
CallerRuns</p>
<h3 id="3-execute-调度任务">3. execute()调度任务</h3>
<p>execute执行任务的时候判断任务等于空抛异常，这个很简单，接下来就是拿状态值，拿到值之后计算这个值里面的线程数，活着的那些线程数是不是小于核心线程数，如果小于addWorker添加一个线程，addWorker是比较难的一个方法，他的第二个参数指的是，是不是核心线程，所有上来之后如果核心数不够先添加核心线程，再次检查这个值。我们原来讲过这个线程里面上来之后刚开始为0，来一个任务启动一个核心线程，第二个就是核心线程数满了之后，放到队列里。最后核心线程满了，队列也满了，启动非核心线程。小于线程数就直接加，后面执行的逻辑就是不小于了，不小于就是超过核心线程数了直接往里扔，workQueue.offer就是把他扔进去队列里，再检查状态。在这中间可能会被改变状态值，因此需要双重检查，这个跟我们之前聊过的单例模式里面的DC是一样的逻辑。isRunning，重新又拿这个状态，拿到这个状态之后这里是要进行一个状态切换的，如果不是Running状态说明执行过shutdown命令，才会把这个Running转换成别的状态，其他情况下workerCountOf如果等于0说明里面没有线程了，没有线程我线程池正常运行就添加非核心线程。这些步骤都是通过源码可以看出来的。如果添加work本身都不行就reject把他给拒绝掉。</p>
<img src="多线程/image-20220313141951366.png" alt="image-20220313141951366" style="zoom:50%;" />
<ol>
<li>
<p>核心线程不够，启动核心的</p>
</li>
<li>
<p>core够了就加队列</p>
</li>
<li>
<p>核心和队列都够了，就非核心</p>
</li>
</ol>
<h3 id="4-addWorker-—-runWorker">4. addWorker()—&gt;runWorker()</h3>
<ol>
<li>
<p>addWorker() 就做了两步，使用lock()和自旋做的</p>
<ol>
<li>count++</li>
<li>加进任务并且start</li>
</ol>
</li>
<li>
<p>runWorker()是真正执行线程的部分</p>
</li>
</ol>
<h4 id="work类">work类</h4>
<p>这个work他本身是Runnable同时又是AQS。这个work类里面会记录着一个成员变量，这个成员变量是thread，很多个线程worker，这个就是为什么要用AQS的原因。另外呢，在你整个执行的过程之中你也需要加锁，不然的话你别的线程进来，因此AQS是需要的。这是这个work类，简单的你就可以把它当成线程类，然后这个线程类执行的是你自己的任务就行了。</p>
<h3 id="submit-和execute-区别">submit()和execute()区别</h3>
<p>Callable实现了Future接口，比runnable多了返回值并且可以抛出异常，然后这个Future是用来存储执行的线程将来才产生的结果，callable为线程池设计，配合future使用，有返回值，实现了任务交给线程池，未来要结果时再get返回。</p>
<p>FutureTask是继承了RunnableFuture接口和Future接口，既是一个任务又是一个Future。在ForkJoinPool 这类线程池里面用，这类线程池是每个线程都有一个阻塞队列。</p>
<h1>杂问题</h1>
<h2 id="1-怎么预防死锁？">1. 怎么预防死锁？</h2>
<p>答：首先我们要知道产生死锁的四个必要条件：第一个，资源在同一时间只能有一个线程来占用，这个也就是互斥条件；第二个，不可剥夺条件，当一个线程已经占有一个资源在释放之前是不会让其他线程抢占；在有就是线程等待的过程中不会释放自己持有的资源，也就是请求和保持条件；第四个条件就是循环等待条件 ，多个线程在互相等待对方释放资源；有了这四个条件当多个线程都持有对方想要的资源却等待对方释放资源的状态就造成了死锁；</p>
<p>​      所以预防死锁就需要从这四个方面入手，第一个资源互斥因为是资源固有属性不能破坏这个条件；我们去破坏第二个不可剥夺条件，可以让进程在等待过程中将其占有的资源隐性释放到系统的资源列表中，而等待的进程只有重新获得自己原有的资源和新申请的资源才能启动执行；破坏第三个请求和保持条件可以使用静态分配和动态分配两种方法；静态分配就是在每一个进程开始执行时就申请他需要的资源；动态分配就是在申请资源的时候他本身不能占用系统资源；最后就是破坏循环等待条件，将系统中的所有资源顺序编号，紧缺资源用大编号，进程在申请资源的时候必须按照编号的顺序执行。嗯，我认为就从这四个方面去着手，谢谢。</p>
<h2 id="2-线程创建方式和生命周期">2. 线程创建方式和生命周期</h2>
<p>有五种方式，第一种方法就是继承thread类，重写run()，调用start开启线程；第二种实现runnable接口，重写run()，实现接口比继承类要灵活；第三种是使用lamda表达式，本质是一样；第四种是实现callable接口执行call()，这种方法相对runnable不同就是执行完毕有返回值，返回值通过future接收可以通过泛型指定类型，也可以抛出异常；第五种就是通过线程池threadpool创建。</p>
<h3 id="start-和-run">start 和 run</h3>
<p>new 一个 thread 调用start就是启动一个线程然后进入就绪状态，但分配到时间片就可以运行，而run只是用于执行线程运行时执行代码可以重复调用，也就是说start用来真正启动多线程工作，进行准备就绪，而线程只是通过run来完成它的运行状态，是一个普通方法的调用，其实还是再主线程里执行的。</p>
<h3 id="线程生命周期和五种状态">线程生命周期和五种状态</h3>
<img src="多线程/image-20220307173638132.png" alt="image-20220307173638132" style="zoom: 33%;" />
<p>new -&gt; runnable(start()) -&gt; running (run()) --&gt;blocked (wait()、synch进入锁池、join()/sleep()/IO请求) -&gt; dead （run()结束或者异常退出）</p>
<h2 id="3-进程与线程的区别">3. 进程与线程的区别</h2>
<p>进程是系统进行资源分配和调度的基本单位是操作系统结构的基础；线程是操作进行运算调度的最小单位。通俗来讲就是，一个程序它本来是一种静态的指令和数据，当系统开始运行这个程序就会load到内存里，然后系统为其分配资源，这个时候就是一个进程，可以理解为进程就是动态的程序；而线程就是进程实际运行的单位，一种单一顺序的控制流，一个进程可以并发多个线程，每条线程有不同任务。</p>
<h2 id="4-并发与并行">4. 并发与并行</h2>
<p>并发是指多个任务在同一个CPU核上，按照细分的时间片交替进行，如果交替时间片够短，逻辑上可以看作同时执行</p>
<p>并行是多个CPU核在同一时间处理多个任务，是真正意义上的同时进行</p>
<p>串行就是一个CPU多个任务串联在一起，按照顺序执行</p>
<h2 id="5-程序开多少线程合适-是不是线程数越高效率越高">5. 程序开多少线程合适/是不是线程数越高效率越高/</h2>
<p>多线程的缺点？线程数过多会怎么样</p>
<ol>
<li>占用内存，给垃圾处理器带来压力、</li>
<li>需要协调和管理CPU时间跟踪线程、</li>
<li>还会互相竞争共享资源这样会带来很多其他性能的开销</li>
</ol>
<p>与线程的体制完全耦合完全相关所以这个时候就看程序要干什么；</p>
<p>根据I/O操作和CPU操作区分程序；如果CPU计算比例占大部分也就是cpu密集型程序，这个时候线程等待时间接近于0，也就是耗费大量时间的就是上下文切换，为了减少上下文切换，一般开CPU核数个线程再加一条保证线程意外暂停；如果是IO操作占比大部分，等待时间长，理论上是可以开无限多个线程但是考虑到节约资源又要保证性能及稳定性，一般用两倍的CPU核数，再加一条为backup，如果需要精密计算的任务就可以使用公式CPU核数/（1-阻塞系数）(阻塞系数0.8~0.9）</p>
<h3 id="单个cpu设定多线程有没有意义？结合上面">单个cpu设定多线程有没有意义？结合上面</h3>
<p>根据实际需要来处理</p>
<p>如果你的每个线程的工作与时序无关的，并且含有外部的读写操作</p>
<p>那么是很有意义的，当一个线程进行读写的时候，其他线程可以占用CPU进行运行。</p>
<p>也即线程属于I/O密集型的时候，在CPU才会体现的多线程的好处</p>
<p>如果是CPU密集型的，你开了很多个线程，只是增加了CPU在各个线程中进行切换的负担<br>
没有带来好处，和性能的提高</p>
<h2 id="6-如何结束一个线程？">6.如何结束一个线程？</h2>
<ol>
<li>
<p>就是run方法结束就正常退出线程了，自然退出</p>
</li>
<li>
<p>使用stop ，但是不建议使用，因为stop结束线程不会在意你进行到哪突然结束，会容易产生数据不一致。</p>
</li>
<li>
<p>volatile标志 也可以 如果是不依赖中间状态 停止就很方便，是特定场景下比较优雅的解决方案。</p>
<ul>
<li>
<p>不适合没有同步的时候，线程阻塞，没办法循环回去</p>
</li>
<li>
<p>打断时间不精确，（比如在一个阻塞容器容量为5的时候结束生产者，由于其对同步线程标志位的时间控制不是很精确，有时候生产者还会生产一部分时间。</p>
</li>
</ul>
</li>
<li>
<p>interrupt/isinterrupt比较优雅</p>
</li>
</ol>
<p>当然要精确停止，控制线程有时候更加需要和外面的线程进行合作吗这个时候就需要用到锁了。</p>
<h3 id="interrupt和isInterrupt">interrupt和isInterrupt()</h3>
<ol>
<li>
<p>interrupt() ：实例⽅法，设置线程中断标志（打扰⼀下，你该处理⼀下中断）比如sleep()在睡眠的时候没办法中断，这个时候就需要</p>
</li>
<li>
<p>isInterrupted()：实例⽅法，有没有⼈打扰我？</p>
</li>
<li>
<p>interrupted()：静态⽅法，有没有⼈打扰我（当前线程）？复位</p>
</li>
</ol>
<p>interrupt()是静态方法，一个线程被中断，第一次调用时返回true然后清除中断信号，后面再次调用就是false了 ;isI就是查看当前信息</p>
<h2 id="7-线程类的构造方法、静态块是被哪个线程调用的？">7. 线程类的构造方法、静态块是被哪个线程调用的？</h2>
<p>这是一个非常刁钻和狡猾的问题。请记住：线程类的构造方法、静态块是被</p>
<p>new这个线程类所在的线程所调用的，而 run 方法里面的代码才是被线程自身所调用的。</p>
<p>如果说上面的说法让你感到困惑，那么我举个例子，假设 Thread2 中 new 了</p>
<p>Thread1，main 函数中 new 了 Thread2，那么：</p>
<p>（1）  Thread2 的构造方法、静态块是 main 线程调用的，Thread2 的 run()方法是Thread2 自己调用的</p>
<p>（2）  Thread1 的构造方法、静态块是 Thread2 调用的，Thread1 的 run()方法是Thread1 自己调用的</p>
<h2 id="8-线程安全活跃态？">8. 线程安全活跃态？</h2>
<p><strong>死锁</strong>：是指两个或两个以上的进程（或线程）在执行过程中，因争夺资源而造成的一种互相等待的现象，若无外力作用，它们都将无法推进下去。</p>
<p><strong>活锁</strong>：任务或者执行者没有被阻塞，由于某些条件没有满足，导致一直重复尝试，失败，尝试，失败。例如：循环递归没有写输出条件抛stackoverflow</p>
<p>​			活锁和死锁的区别在于，处于活锁的实体是在不断的改变状态，这就是所谓的“活”， 而处于死锁的实体表现为等待；活锁有可能自行解开，死锁则不能。</p>
<p><strong>饥饿</strong>：一个或者多个线程因为种种原因无法获得所需要的资源，导致一直无法执行的状态。例子：读写锁，一直读导致写操作一直等待</p>
<p>​		Java 中导致饥饿的原因：</p>
<ol>
<li>其他线程在临界区做了无限循环或无限制等待资源的操作，让其他的线程一直不能拿到锁进入临界区，对其他线程来说就进入了饥饿状态。</li>
<li>因为线程优先级分配的不合理，导致部分线程始终无法获得CPU资源。</li>
</ol>
<h2 id="9-1～26和a-b顺序交替打印">9. 1～26和a~b顺序交替打印</h2>
<p>这道面试题呢实际上是华为的一道面试题，其实它里面是一道填空题，后来就很多的开始考这道题，这个面试题是两个线程，第一个线程是从1到26，第二个线程是从A到一直到Z，然后要让这两个线程做到同时运行，交替输出，顺序打印。那么这道题目的解法有非常多。</p>
<h3 id="1-LockSupport">1.LockSupport</h3>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">T02_00_LockSupport</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">static</span> <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> t2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aI <span class="token operator">=</span> <span class="token string">"1234567"</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> aC <span class="token operator">=</span> <span class="token string">"ABCDEFG"</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c <span class="token operator">:</span> aI<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>t2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//叫醒T2</span>
                    <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//T1阻塞</span>
                <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span>

            <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c <span class="token operator">:</span> aC<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//t2阻塞</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">LockSupport</span><span class="token punctuation">.</span><span class="token function">unpark</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//叫醒t1</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>​</p>
<h3 id="2-wait-和-notify">2. wait() 和 notify()</h3>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> waitNotify<span class="token punctuation">&#123;</span>
  <span class="token keyword">final</span> <span class="token class-name">Object</span> o <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> c1 <span class="token operator">=</span> <span class="token string">"ABCDEFG"</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">char</span><span class="token punctuation">[</span><span class="token punctuation">]</span> c2 <span class="token operator">=</span> <span class="token string">"123456"</span><span class="token punctuation">.</span><span class="token function">toCharArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Sychronized</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span>c1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">&#123;</span>
          o<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        	o<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
      o<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"t1"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span>
  
  <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token punctuation">&#123;</span>
    <span class="token class-name">Sychronized</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">char</span> c<span class="token operator">:</span>c2<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>c <span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      o<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">,</span><span class="token string">"t2"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></code></pre>
<p>一定要注意最后都要notify（）</p>
<h2 id="10-多线程之间是怎么通信的？">10. 多线程之间是怎么通信的？</h2>
<ol>
<li>
<p>通过共享变量，变量需要volatile修饰；</p>
</li>
<li>
<p>使用wait和notify方法，但是由于需要使用同一把锁，所以必须通知线程释放锁，被通知的线程才能获得到多，这样导致通知不及时；</p>
</li>
<li>
<p>使用countDownLatch实现，通知线程到指定条件，调用countDownLatc.countDown()被通知的线程进行await()方法</p>
</li>
<li>
<p>使用Condition的await()和signalAll()方法。</p>
</li>
</ol>
<h2 id="11-生产者消费者模型">11. 生产者消费者模型?</h2>
<h3 id="Condition-阻塞队列">Condition 阻塞队列</h3>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProviderConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">private</span> <span class="token keyword">int</span> length<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> queue<span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">Condition</span> provideCondition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">private</span> <span class="token class-name">Condition</span> consumeCondition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">ProviderConsumer</span><span class="token punctuation">(</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>length <span class="token operator">=</span> length<span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">provide</span><span class="token punctuation">(</span><span class="token class-name">T</span> product<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

		lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> length<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				provideCondition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			queue<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>product<span class="token punctuation">)</span><span class="token punctuation">;</span>
			consumeCondition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
			lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token class-name">T</span> <span class="token function">consume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

		lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				consumeCondition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token class-name">T</span> product <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			provideCondition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> product<span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span>
			lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">&#125;</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	<span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span></code></pre>
<h3 id="wait-和-notify">wait() 和 notify()</h3>
<pre class="language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerConsumerModel</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token class-name">EventStorage</span> eventStorage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Producer</span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span>eventStorage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Consumer</span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span>eventStorage<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>producer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>consumer<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Producer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">EventStorage</span> storage<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Producer</span><span class="token punctuation">(</span><span class="token class-name">EventStorage</span> storage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>storage <span class="token operator">=</span> storage<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                storage<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Consumer</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token class-name">EventStorage</span> storage<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">Consumer</span><span class="token punctuation">(</span><span class="token class-name">EventStorage</span> storage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>storage <span class="token operator">=</span> storage<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                storage<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EventStorage</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> size<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> storage<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">EventStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            size <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
            storage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            storage<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"数据"</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"生产 -> 数据"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">" 当前仓库中已经有了 "</span> <span class="token operator">+</span> storage<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">take</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>storage<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                    <span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"消费 -> "</span> <span class="token operator">+</span> storage<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 当前仓库中剩下 "</span> <span class="token operator">+</span> storage<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 条数据"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></code></pre>
</article><div class="post-copyright"><div class="copyright-cc-box"><i class="anzhiyufont anzhiyu-icon-copyright"></i></div><div class="post-copyright__author_box"><a class="post-copyright__author_img" href="/" title="头像"><img class="post-copyright__author_img_back" src="https://img.soniachen.com/IMG_0151.JPG" title="头像" alt="头像"><img class="post-copyright__author_img_front" src="https://img.soniachen.com/IMG_0151.JPG" title="头像" alt="头像"></a><div class="post-copyright__author_name">SoniaChen</div><div class="post-copyright__author_desc"></div></div><div class="post-copyright__post__info"><a class="post-copyright__original" title="该文章为原创文章，注意版权协议" href="https://blog.soniachen.com/2022/02/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">原创</a><a class="post-copyright-title"><span onclick="rm.copyPageUrl('https://blog.soniachen.com/2022/02/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B/')">多线程</span></a></div><div class="post-tools" id="post-tools"><div class="post-tools-left"><div class="rewardLeftButton"><div class="post-reward" onclick="anzhiyu.addRewardMask()"><div class="reward-button button--animated" title="赞赏作者"><i class="anzhiyufont anzhiyu-icon-hand-heart-fill"></i>打赏作者</div><div class="reward-main"><div class="reward-all"><span class="reward-title">感谢你赐予我前进的力量</span><ul class="reward-group"><li class="reward-item"><a href="https://img.soniachen.com/blog/IMG_5543.JPG" target="_blank"><img class="post-qr-code-img" src="https://img.soniachen.com/blog/IMG_5543.JPG" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://img.soniachen.com/blog/IMG_5544.JPG" target="_blank"><img class="post-qr-code-img" src="https://img.soniachen.com/blog/IMG_5544.JPG" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul><a class="reward-main-btn" href="/about/#about-reward" target="_blank"><div class="reward-text">赞赏者名单</div><div class="reward-dec">因为你们的支持让我意识到写文章的价值🙏</div></a></div></div></div><div id="quit-box" onclick="anzhiyu.removeRewardMask()" style="display: none"></div></div><div class="shareRight"><div class="share-link mobile"><div class="share-qrcode"><div class="share-button" title="使用手机访问这篇文章"><i class="anzhiyufont anzhiyu-icon-qrcode"></i></div><div class="share-main"><div class="share-main-all"><div id="qrcode" title="https://blog.soniachen.com/2022/02/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"></div><div class="reward-dec">使用手机访问这篇文章</div></div></div></div></div><div class="share-link weibo"><a class="share-button" target="_blank" href="https://service.weibo.com/share/share.php?title=多线程&amp;url=https://blog.soniachen.com/2022/02/09/%E5%A4%9A%E7%BA%BF%E7%A8%8B/&amp;pic=https://img.soniachen.com/IMG_5493.jpg?_r_=ec673246-ce76-5933-0085-b53e89e196be" rel="external nofollow noreferrer noopener"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a></div><script>function copyCurrentPageUrl() {
  var currentPageUrl = window.location.href;
  var input = document.createElement("input");
  input.setAttribute("value", currentPageUrl);
  document.body.appendChild(input);
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  document.body.removeChild(input);
}</script><div class="share-link copyurl"><div class="share-button" id="post-share-url" title="复制链接" onclick="copyCurrentPageUrl()"><i class="anzhiyufont anzhiyu-icon-link"></i></div></div></div></div></div><div class="post-copyright__notice"><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.soniachen.com" target="_blank">Sonia33</a>！</span></div></div><div class="post-tools-right"><div class="tag_share"><div class="post-meta__box"><div class="post-meta__box__tag-list"><a class="post-meta__box__tags" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="tags-punctuation"> <i class="anzhiyufont anzhiyu-icon-tag"></i></span>多线程<span class="tagsPageCount">1</span></a></div></div></div><div class="post_share"><div class="social-share" data-image="https://img.soniachen.com/IMG_5493.jpg?_r_=82e8062f-25a1-38d4-e83c-57ff39cc263d" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"/><script src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/09/12/m1-2020%E9%85%8D%E7%BD%AEjava%E5%90%8E%E7%AB%AF%E7%8E%AF%E5%A2%83/"><img class="prev-cover" src="https://img.soniachen.com/IMG_5493.jpg?_r_=da52acdf-0eb6-9b60-6628-25acd1eb4d00" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">m1 2020配置java后端环境</div></div></a></div><div class="next-post pull-right"><a href="/2022/02/12/Redis%E9%9D%A2%E8%AF%95%E9%A2%98/"><img class="next-cover" src="https://img.soniachen.com/IMG_5493.jpg?_r_=156f1c43-e456-c5a9-64a1-e8ac33a068c0" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="anzhiyufont anzhiyu-icon-comments"></i><span> 评论</span></div><div class="comment-randomInfo"><a onclick="anzhiyu.addRandomCommentInfo()" href="javascript:void(0)">匿名评论</a><a href="/privacy" style="margin-left: 4px">隐私政策</a></div><div class="comment-tips" id="comment-tips"><span>✅ 你无需删除空行，直接评论以获取最佳展示效果</span></div></div><div class="comment-wrap"><div><div id="twikoo-wrap"></div></div></div></div><div class="comment-barrage"></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="anzhiyufont anzhiyu-icon-bars"></i><span>文章目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">并发编程三大特性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-number">1.1.</span> <span class="toc-text">可见性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#volatile"><span class="toc-number">1.1.1.</span> <span class="toc-text">&#x3D;&#x3D;volatile&#x3D;&#x3D;</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D%E4%B8%80%E4%B8%8Bvolatile%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%9F"><span class="toc-number">1.1.1.0.1.</span> <span class="toc-text">&#x3D;&#x3D;介绍一下volatile的功能？&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#volatile%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7%E5%92%8C%E7%A6%81%E6%AD%A2%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92%E5%BA%8F%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0%E7%9A%84%EF%BC%9F"><span class="toc-number">1.1.1.0.2.</span> <span class="toc-text">&#x3D;&#x3D;volatile的可见性和禁止指令重排序怎么实现的？&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#volatile-%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0%EF%BC%9F"><span class="toc-number">1.1.1.0.3.</span> <span class="toc-text">&#x3D;&#x3D;volatile 的底层实现？&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%8BDCL-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E4%B8%8B%E7%9A%84%E5%8F%8C%E9%87%8D%E6%A3%80%E6%9F%A5-volatile%E7%9A%84%E5%AE%9E%E8%B7%B5"><span class="toc-number">1.1.1.0.4.</span> <span class="toc-text">&#x3D;&#x3D;实现一下DCL(单例模式下的双重检查)&#x2F; volatile的实践&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%8D%95%E4%BE%8B%E9%87%8C%E9%9D%A2%E8%A6%81%E4%B8%8D%E8%A6%81%E5%8A%A0volatile%EF%BC%9F"><span class="toc-number">1.1.1.0.5.</span> <span class="toc-text">&#x3D;&#x3D;单例里面要不要加volatile？&#x3D;&#x3D;</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E5%BA%8F%E6%80%A7"><span class="toc-number">1.2.</span> <span class="toc-text">有序性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E7%9C%9F%E7%9A%84%E6%98%AF%E6%8C%89%E7%85%A7%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C%E7%9A%84%E5%90%97%EF%BC%9F"><span class="toc-number">1.2.1.</span> <span class="toc-text">程序真的是按照顺序执行的吗？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E7%BA%BF%E7%A8%8B%E4%B9%9F%E4%B8%8D%E6%98%AF%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C"><span class="toc-number">1.2.2.</span> <span class="toc-text">单线程也不是顺序执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-number">1.3.</span> <span class="toc-text">原子性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CAS"><span class="toc-number">1.3.1.</span> <span class="toc-text">CAS</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#CAS%E5%BA%95%E5%B1%82"><span class="toc-number">1.3.1.0.1.</span> <span class="toc-text">&#x3D;&#x3D;CAS底层&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3ABA%E9%97%AE%E9%A2%98"><span class="toc-number">1.3.1.0.2.</span> <span class="toc-text">&#x3D;&#x3D;如何解决ABA问题&#x3D;&#x3D;</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">2.</span> <span class="toc-text">线程调度与同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6%E5%99%A8"><span class="toc-number">2.0.1.</span> <span class="toc-text">线程调度器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E8%BF%9B%E8%A1%8C%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%8A%A2%E5%8D%A0cpu%E7%9A%84%E8%B0%83%E5%BA%A6%E5%91%A2%EF%BC%9F%EF%BC%88%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95"><span class="toc-number">2.0.1.1.</span> <span class="toc-text">怎么进行多线程抢占cpu的调度呢？（线程调度算法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%E4%BB%A5%E5%8F%8A%E7%BA%BF%E7%A8%8B%E8%B0%83%E5%BA%A6%E6%96%B9"><span class="toc-number">2.0.2.</span> <span class="toc-text">线程同步以及线程调度方</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#sleep-%E5%92%8C-wait-%E4%B8%8D%E5%90%8C"><span class="toc-number">2.0.2.1.</span> <span class="toc-text">sleep() 和 wait() 不同</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sleep-%E5%92%8Cyeild-%E4%B8%8D%E5%90%8C"><span class="toc-number">2.0.2.2.</span> <span class="toc-text">sleep()和yeild() 不同</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sleep-%E5%92%8Cyeild-%E4%B8%BA%E5%95%A5%E6%98%AF%E9%9D%99%E6%80%81"><span class="toc-number">2.0.2.3.</span> <span class="toc-text">sleep()和yeild()为啥是静态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wait-%E5%92%8C-notify-%E5%AE%9E%E9%99%85%E4%BD%BF%E7%94%A8"><span class="toc-number">2.0.3.</span> <span class="toc-text">&#x3D;&#x3D;wait() 和 notify()实际使用&#x3D;&#x3D;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8F%8F%E8%BF%B0notify%E5%92%8CnotifyAll%E5%8C%BA%E5%88%AB"><span class="toc-number">2.0.4.</span> <span class="toc-text">描述notify和notifyAll区别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%94%A4%E9%86%92%E7%BA%BF%E7%A8%8B%EF%BC%9F"><span class="toc-number">2.0.4.1.</span> <span class="toc-text">如何唤醒线程？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%89%E4%B8%AA%E6%96%B9%E6%B3%95%E8%A6%81%E5%AE%9A%E4%B9%89%E5%9C%A8object%E9%87%8C%EF%BC%9F"><span class="toc-number">2.0.5.</span> <span class="toc-text">为什么三个方法要定义在object里？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%89%E4%B8%AA%E6%96%B9%E6%B3%95%E8%A6%81%E5%9C%A8%E5%90%8C%E6%AD%A5%E6%96%B9%E6%B3%95%E6%88%96%E8%80%85%E4%BB%A3%E7%A0%81%E5%9D%97%E9%87%8C%E9%9D%A2%E8%B0%83%E7%94%A8%EF%BC%9F"><span class="toc-number">2.0.6.</span> <span class="toc-text">为什么三个方法要在同步方法或者代码块里面调用？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5%EF%BC%9F"><span class="toc-number">2.0.7.</span> <span class="toc-text">什么是线程同步？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E6%AD%A5%E6%96%B9%E6%B3%95%E5%92%8C%E9%9D%9E%E5%90%8C%E6%AD%A5%E6%96%B9%E6%B3%95%E5%8F%AF%E4%BB%A5%E5%90%8C%E6%97%B6%E8%B0%83%E7%94%A8%E5%90%97%EF%BC%9F"><span class="toc-number">2.0.8.</span> <span class="toc-text">同步方法和非同步方法可以同时调用吗？</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BA%BF%E7%A8%8B%E4%BA%92%E6%96%A5%EF%BC%9F"><span class="toc-number">2.0.8.1.</span> <span class="toc-text">什么是线程互斥？</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">3.</span> <span class="toc-text">Synchronized</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#synchronized%E3%80%81volatile%E3%80%81CAS-%E6%AF%94%E8%BE%83"><span class="toc-number">3.0.1.</span> <span class="toc-text">synchronized、volatile、CAS 比较</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#synchronized-%E5%92%8C-ReentrantLock-%E5%8C%BA%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">3.0.2.</span> <span class="toc-text">&#x3D;&#x3D;synchronized 和 ReentrantLock 区别是什么？&#x3D;&#x3D;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%94%81%E7%9A%84%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">3.0.2.1.</span> <span class="toc-text">锁的是什么?</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%81%E9%87%8D%E5%85%A5%EF%BC%9F"><span class="toc-number">3.0.3.</span> <span class="toc-text">锁重入？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sych%E7%9A%84%E9%94%81%E5%8D%87%E7%BA%A7%E7%9A%84%E5%8E%9F%E7%90%86%E6%88%96%E8%80%85%E6%98%AF%E8%BF%87%E7%A8%8B%EF%BC%9F"><span class="toc-number">3.0.4.</span> <span class="toc-text">&#x3D;&#x3D;Sych的锁升级的原理或者是过程？&#x3D;&#x3D;</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E9%94%81%E5%8D%87%E7%BA%A7%E8%BF%87%E7%A8%8B%EF%BC%9A"><span class="toc-number">3.0.4.1.</span> <span class="toc-text">详细锁升级过程：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E7%94%A8%E8%87%AA%E6%97%8B%E9%94%81%E5%92%8C%E7%B3%BB%E7%BB%9F%E9%94%81%EF%BC%9F-%E4%B8%BA%E4%BB%80%E4%B9%88%E6%9C%89%E4%BA%86%E8%87%AA%E6%97%8B%E9%94%81%E8%BF%98%E8%A6%81%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81%EF%BC%9F"><span class="toc-number">3.0.5.</span> <span class="toc-text">什么时候用自旋锁和系统锁？&#x2F; 为什么有了自旋锁还要重量级锁？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%8D%87%E7%BA%A7%E4%B8%BA%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81%EF%BC%9F"><span class="toc-number">3.0.6.</span> <span class="toc-text">什么时候升级为重量级锁？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%8F%E5%90%91%E9%94%81%E6%98%AF%E5%90%A6%E5%90%AF%E5%8A%A8%EF%BC%9F"><span class="toc-number">3.0.7.</span> <span class="toc-text">偏向锁是否启动？</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">4.</span> <span class="toc-text">Lock体系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-Concurrency-API-%E4%B8%AD%E7%9A%84-Lock-%E6%8E%A5%E5%8F%A3-Lock-interface-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F%E5%AF%B9%E6%AF%94%E5%90%8C%E6%AD%A5%E5%AE%83%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E5%8A%BF%EF%BC%9F"><span class="toc-number">4.0.1.</span> <span class="toc-text">Java Concurrency API 中的 Lock 接口(Lock interface)是什么？对比同步它有什么优势？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97%EF%BC%9F-%E4%BD%BF%E7%94%A8Condition%E5%86%99%E7%94%9F%E4%BA%A7%E8%80%85%E5%92%8C%E6%B6%88%E8%B4%B9%E8%80%85%EF%BC%9F"><span class="toc-number">4.0.2.</span> <span class="toc-text">&#x3D;&#x3D;实现一个阻塞队列？&#x2F; 使用Condition写生产者和消费者？&#x3D;&#x3D;</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">5.</span> <span class="toc-text">AQS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AQS-%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">5.1.</span> <span class="toc-text">AQS 原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#AQS-%E5%8E%9F%E7%90%86%E6%A6%82%E8%A7%88"><span class="toc-number">5.1.1.</span> <span class="toc-text">AQS 原理概览</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">5.1.2.</span> <span class="toc-text">源码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#state%E7%8A%B6%E6%80%81%E5%8F%98%E9%87%8F"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">state状态变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AQS%E9%98%9F%E5%88%97"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">AQS队列</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E7%9A%84%E5%85%B1%E4%BA%AB%E6%96%B9%E5%BC%8F"><span class="toc-number">5.2.</span> <span class="toc-text">资源的共享方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E7%89%88%E6%96%B9%E6%B3%95"><span class="toc-number">5.3.</span> <span class="toc-text">模版方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E5%B7%A5%E5%85%B7%E7%B1%BB"><span class="toc-number">5.4.</span> <span class="toc-text">并发工具类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CountDownLatch-%E5%80%92%E8%AE%A1%E6%97%B6%E5%99%A8-%EF%BC%9A"><span class="toc-number">5.4.1.</span> <span class="toc-text">CountDownLatch(倒计时器)：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%B3%95%EF%BC%9F"><span class="toc-number">5.4.1.1.</span> <span class="toc-text">用法？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CyclicBarrier-%E5%BE%AA%E7%8E%AF%E6%A0%85%E6%A0%8F-%EF%BC%9A"><span class="toc-number">5.4.2.</span> <span class="toc-text">CyclicBarrier(循环栅栏)：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Semaphore-%E4%BF%A1%E5%8F%B7%E9%87%8F-%E5%85%81%E8%AE%B8%E5%A4%9A%E4%B8%AA%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%97%B6%E8%AE%BF%E9%97%AE%EF%BC%9A"><span class="toc-number">5.4.3.</span> <span class="toc-text">Semaphore(信号量)-允许多个线程同时访问：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exchange-%E7%BA%BF%E7%A8%8B%E8%A7%81%E4%BA%A4%E6%8D%A2%E6%95%B0%E6%8D%AE%E7%9A%84%E5%B7%A5%E5%85%B7"><span class="toc-number">5.4.4.</span> <span class="toc-text">Exchange(线程见交换数据的工具)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ReadWriteLock"><span class="toc-number">5.4.5.</span> <span class="toc-text">ReadWriteLock</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">6.</span> <span class="toc-text">ThreadLocal</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">6.1.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E9%80%94"><span class="toc-number">6.2.</span> <span class="toc-text">用途</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E7%A7%8D%E5%BC%95%E7%94%A8"><span class="toc-number">6.3.</span> <span class="toc-text">四种引用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E7%94%A8%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">6.3.1.</span> <span class="toc-text">引用是什么？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%BA%E5%BC%95%E7%94%A8normalReference"><span class="toc-number">6.3.2.</span> <span class="toc-text">强引用normalReference</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%B1%E5%BC%95%E7%94%A8softReference"><span class="toc-number">6.3.3.</span> <span class="toc-text">弱引用softReference</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E5%BC%95%E7%94%A8"><span class="toc-number">6.3.4.</span> <span class="toc-text">虚引用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9C%A8threadlocal%E7%9A%84%E5%BA%94%E7%94%A8-%E5%86%85%E5%AD%98%E6%B3%84%E9%9C%B2"><span class="toc-number">6.3.4.1.</span> <span class="toc-text">&#x3D;&#x3D;在threadlocal的应用 &#x2F; 内存泄露&#x3D;&#x3D;</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">7.</span> <span class="toc-text">JUC同步容器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConcurrentHashMap"><span class="toc-number">7.1.</span> <span class="toc-text">ConcurrentHashMap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CopyOnWriteArrayList"><span class="toc-number">7.2.</span> <span class="toc-text">CopyOnWriteArrayList</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CopyOnWriteArrayList-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%94%A8%E4%BA%8E%E4%BB%80%E4%B9%88%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF%EF%BC%9F%E6%9C%89%E5%93%AA%E4%BA%9B%E4%BC%98%E7%BC%BA%E7%82%B9%EF%BC%9F"><span class="toc-number">7.2.1.</span> <span class="toc-text">CopyOnWriteArrayList 是什么，可以用于什么应用场景？有哪些优缺点？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#BlockingQueue"><span class="toc-number">7.3.</span> <span class="toc-text">BlockingQueue</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ArrayBlockingQueue"><span class="toc-number">7.3.1.</span> <span class="toc-text">ArrayBlockingQueue</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Queue%E5%92%8CList%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">7.3.2.</span> <span class="toc-text">Queue和List的区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">8.</span> <span class="toc-text">线程池</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Executor-%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%B7%A5%E5%8E%82"><span class="toc-number">8.1.</span> <span class="toc-text">Executor(线程的工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#newSingleThreadPool"><span class="toc-number">8.1.1.</span> <span class="toc-text">newSingleThreadPool</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#newCachedThreadPool%E6%B2%A1%E4%B8%8A%E9%99%90"><span class="toc-number">8.1.2.</span> <span class="toc-text">newCachedThreadPool没上限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#newFixedThreadPool-%E5%9B%BA%E5%AE%9A%E7%9A%84"><span class="toc-number">8.1.3.</span> <span class="toc-text">newFixedThreadPool 固定的</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#newScheduledThreadPool%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">8.1.4.</span> <span class="toc-text">newScheduledThreadPool定时任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ThreadPoolExecutor"><span class="toc-number">8.2.</span> <span class="toc-text">ThreadPoolExecutor</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%8A%B6%E6%80%81"><span class="toc-number">8.2.1.</span> <span class="toc-text">1. 状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E5%8F%82%E6%95%B0"><span class="toc-number">8.2.2.</span> <span class="toc-text">2. 构造方法参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-execute-%E8%B0%83%E5%BA%A6%E4%BB%BB%E5%8A%A1"><span class="toc-number">8.2.3.</span> <span class="toc-text">3. execute()调度任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-addWorker-%E2%80%94-runWorker"><span class="toc-number">8.2.4.</span> <span class="toc-text">4. addWorker()—&gt;runWorker()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#work%E7%B1%BB"><span class="toc-number">8.2.4.1.</span> <span class="toc-text">work类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#submit-%E5%92%8Cexecute-%E5%8C%BA%E5%88%AB"><span class="toc-number">8.2.5.</span> <span class="toc-text">submit()和execute()区别</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">9.</span> <span class="toc-text">杂问题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%80%8E%E4%B9%88%E9%A2%84%E9%98%B2%E6%AD%BB%E9%94%81%EF%BC%9F"><span class="toc-number">9.1.</span> <span class="toc-text">1. 怎么预防死锁？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E7%BA%BF%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%96%B9%E5%BC%8F%E5%92%8C%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="toc-number">9.2.</span> <span class="toc-text">2. 线程创建方式和生命周期</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#start-%E5%92%8C-run"><span class="toc-number">9.2.1.</span> <span class="toc-text">start 和 run</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E4%BA%94%E7%A7%8D%E7%8A%B6%E6%80%81"><span class="toc-number">9.2.2.</span> <span class="toc-text">线程生命周期和五种状态</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">9.3.</span> <span class="toc-text">3. 进程与线程的区别</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C"><span class="toc-number">9.4.</span> <span class="toc-text">4. 并发与并行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E7%A8%8B%E5%BA%8F%E5%BC%80%E5%A4%9A%E5%B0%91%E7%BA%BF%E7%A8%8B%E5%90%88%E9%80%82-%E6%98%AF%E4%B8%8D%E6%98%AF%E7%BA%BF%E7%A8%8B%E6%95%B0%E8%B6%8A%E9%AB%98%E6%95%88%E7%8E%87%E8%B6%8A%E9%AB%98"><span class="toc-number">9.5.</span> <span class="toc-text">5. 程序开多少线程合适&#x2F;是不是线程数越高效率越高&#x2F;</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E4%B8%AAcpu%E8%AE%BE%E5%AE%9A%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%9C%89%E6%B2%A1%E6%9C%89%E6%84%8F%E4%B9%89%EF%BC%9F%E7%BB%93%E5%90%88%E4%B8%8A%E9%9D%A2"><span class="toc-number">9.5.1.</span> <span class="toc-text">单个cpu设定多线程有没有意义？结合上面</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%A6%82%E4%BD%95%E7%BB%93%E6%9D%9F%E4%B8%80%E4%B8%AA%E7%BA%BF%E7%A8%8B%EF%BC%9F"><span class="toc-number">9.6.</span> <span class="toc-text">6.如何结束一个线程？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#interrupt%E5%92%8CisInterrupt"><span class="toc-number">9.6.1.</span> <span class="toc-text">interrupt和isInterrupt()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E7%BA%BF%E7%A8%8B%E7%B1%BB%E7%9A%84%E6%9E%84%E9%80%A0%E6%96%B9%E6%B3%95%E3%80%81%E9%9D%99%E6%80%81%E5%9D%97%E6%98%AF%E8%A2%AB%E5%93%AA%E4%B8%AA%E7%BA%BF%E7%A8%8B%E8%B0%83%E7%94%A8%E7%9A%84%EF%BC%9F"><span class="toc-number">9.7.</span> <span class="toc-text">7. 线程类的构造方法、静态块是被哪个线程调用的？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E6%B4%BB%E8%B7%83%E6%80%81%EF%BC%9F"><span class="toc-number">9.8.</span> <span class="toc-text">8. 线程安全活跃态？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-1%EF%BD%9E26%E5%92%8Ca-b%E9%A1%BA%E5%BA%8F%E4%BA%A4%E6%9B%BF%E6%89%93%E5%8D%B0"><span class="toc-number">9.9.</span> <span class="toc-text">9. 1～26和a~b顺序交替打印</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-LockSupport"><span class="toc-number">9.9.1.</span> <span class="toc-text">1.LockSupport</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-wait-%E5%92%8C-notify"><span class="toc-number">9.9.2.</span> <span class="toc-text">2. wait() 和 notify()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E9%97%B4%E6%98%AF%E6%80%8E%E4%B9%88%E9%80%9A%E4%BF%A1%E7%9A%84%EF%BC%9F"><span class="toc-number">9.10.</span> <span class="toc-text">10. 多线程之间是怎么通信的？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%9E%8B"><span class="toc-number">9.11.</span> <span class="toc-text">11. 生产者消费者模型?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Condition-%E9%98%BB%E5%A1%9E%E9%98%9F%E5%88%97"><span class="toc-number">9.11.1.</span> <span class="toc-text">Condition 阻塞队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#wait-%E5%92%8C-notify"><span class="toc-number">9.11.2.</span> <span class="toc-text">wait() 和 notify()</span></a></li></ol></li></ol></li></ol></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div id="footer_deal"><a class="deal_link" href="/soniachan0831@gmail.com" title="email"><i class="anzhiyufont anzhiyu-icon-envelope"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://weibo.com/u/6378063631" title="微博"><i class="anzhiyufont anzhiyu-icon-weibo"></i></a><a class="deal_link" href="/atom.xml" title="RSS"><i class="anzhiyufont anzhiyu-icon-rss"></i></a><img class="footer_mini_logo" title="返回顶部" alt="返回顶部" onclick="anzhiyu.scrollToDest(0, 500)" src="https://img.soniachen.com/IMG_0151.JPG" size="50px"/><a class="deal_link" target="_blank" rel="noopener" href="https://github.com/SoniaChan33" title="Github"><i class="anzhiyufont anzhiyu-icon-github"></i></a><a class="deal_link" target="_blank" rel="noopener" href="https://space.bilibili.com/360939620" title="Bilibili"><i class="anzhiyufont anzhiyu-icon-bilibili"></i></a><a class="deal_link" href="/copyright" title="CC"><i class="anzhiyufont anzhiyu-icon-copyright-line"></i></a></div><div class="copyright">&copy;2021 - 2025 By SoniaChen</div><div id="workboard"><div id="runtimeTextTip"></div></div><p id="ghbdages"><a class="github-badge" target="_blank" href="https://hexo.io/" style="margin-inline:5px" data-title="博客框架为Hexo_v5.4.0" title="博客框架为Hexo_v5.4.0"><img src="https://npm.elemecdn.com/anzhiyu-blog@2.1.5/img/badge/Frame-Hexo.svg" alt="博客框架为Hexo_v5.4.0"/></a></p></div></footer></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="sidebar-site-data site-data is-center"><a href="/archives/" title="archive"><div class="headline">文章</div><div class="length-num">48</div></a><a href="/tags/" title="tag"><div class="headline">标签</div><div class="length-num">39</div></a><a href="/categories/" title="category"><div class="headline">分类</div><div class="length-num">17</div></a></div><span class="sidebar-menu-item-title">功能</span><div class="sidebar-menu-item"><a class="darkmode_switchbutton menu-child" href="javascript:void(0);" title="显示模式"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span>显示模式</span></a></div><div class="back-menu-list-groups"><div class="back-menu-list-group"><div class="back-menu-list-title">网页</div><div class="back-menu-list"><a class="back-menu-item" href="https://blog.soniachen.com/" title="博客"><img class="back-menu-item-icon" src="https://img.soniachen.com/%E9%92%A2%E9%93%81%E8%9C%98%E8%9B%9B%E4%BE%A0.png" alt="博客"/><span class="back-menu-item-text">博客</span></a></div></div></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 文章</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/archives/"><i class="anzhiyufont anzhiyu-icon-box-archive faa-tada" style="font-size: 0.9em;"></i><span> 隧道</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/categories/"><i class="anzhiyufont anzhiyu-icon-shapes faa-tada" style="font-size: 0.9em;"></i><span> 分类</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags faa-tada" style="font-size: 0.9em;"></i><span> 标签</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 我的</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/music/?id=447363601&amp;server=netease"><i class="anzhiyufont anzhiyu-icon-music faa-tada" style="font-size: 0.9em;"></i><span> 音乐馆</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/bangumis/"><i class="anzhiyufont anzhiyu-icon-bilibili faa-tada" style="font-size: 0.9em;"></i><span> 追番页</span></a></li><li><a class="site-page child faa-parent animated-hover" href="/album/"><i class="anzhiyufont anzhiyu-icon-images faa-tada" style="font-size: 0.9em;"></i><span> 相册集</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><span> 关于</span></a><ul class="menus_item_child"><li><a class="site-page child faa-parent animated-hover" href="/about/"><i class="anzhiyufont anzhiyu-icon-paper-plane faa-tada" style="font-size: 0.9em;"></i><span> 关于本人</span></a></li><li><a class="site-page child faa-parent animated-hover" href="javascript:toRandomPost()"><i class="anzhiyufont anzhiyu-icon-shoe-prints1 faa-tada" style="font-size: 0.9em;"></i><span> 随便逛逛</span></a></li></ul></div></div><span class="sidebar-menu-item-title">标签</span><div class="card-tags"><div class="item-headline"></div><div class="card-tag-cloud"><a href="/tags/BlockChain/" style="font-size: 0.88rem;">BlockChain<sup>4</sup></a><a href="/tags/CSS/" style="font-size: 0.88rem;">CSS<sup>1</sup></a><a href="/tags/CloudFlare/" style="font-size: 0.88rem;">CloudFlare<sup>2</sup></a><a href="/tags/DataBase/" style="font-size: 0.88rem;">DataBase<sup>2</sup></a><a href="/tags/FastDFS/" style="font-size: 0.88rem;">FastDFS<sup>1</sup></a><a href="/tags/Foundry/" style="font-size: 0.88rem;">Foundry<sup>1</sup></a><a href="/tags/Git/" style="font-size: 0.88rem;">Git<sup>2</sup></a><a href="/tags/HTML/" style="font-size: 0.88rem;">HTML<sup>1</sup></a><a href="/tags/IO/" style="font-size: 0.88rem;">IO<sup>1</sup></a><a href="/tags/JDBC/" style="font-size: 0.88rem;">JDBC<sup>1</sup></a><a href="/tags/JQuery/" style="font-size: 0.88rem;">JQuery<sup>1</sup></a><a href="/tags/Java/" style="font-size: 0.88rem;">Java<sup>3</sup></a><a href="/tags/JavaScript/" style="font-size: 0.88rem;">JavaScript<sup>1</sup></a><a href="/tags/Linux/" style="font-size: 0.88rem;">Linux<sup>1</sup></a><a href="/tags/MQ/" style="font-size: 0.88rem;">MQ<sup>1</sup></a><a href="/tags/MySQL/" style="font-size: 0.88rem;">MySQL<sup>2</sup></a><a href="/tags/Nacos/" style="font-size: 0.88rem;">Nacos<sup>1</sup></a><a href="/tags/NoSQL/" style="font-size: 0.88rem;">NoSQL<sup>1</sup></a><a href="/tags/OpenFeign/" style="font-size: 0.88rem;">OpenFeign<sup>1</sup></a><a href="/tags/PicGo/" style="font-size: 0.88rem;">PicGo<sup>1</sup></a><a href="/tags/RabbitMQ/" style="font-size: 0.88rem;">RabbitMQ<sup>1</sup></a><a href="/tags/Redis/" style="font-size: 0.88rem;">Redis<sup>2</sup></a><a href="/tags/Rust/" style="font-size: 0.88rem;">Rust<sup>16</sup></a><a href="/tags/Sentinel/" style="font-size: 0.88rem;">Sentinel<sup>2</sup></a><a href="/tags/Solidity/" style="font-size: 0.88rem;">Solidity<sup>4</sup></a><a href="/tags/Typora/" style="font-size: 0.88rem;">Typora<sup>1</sup></a><a href="/tags/Zookeeper/" style="font-size: 0.88rem;">Zookeeper<sup>1</sup></a><a href="/tags/hexo/" style="font-size: 0.88rem;">hexo<sup>3</sup></a><a href="/tags/java/" style="font-size: 0.88rem;">java<sup>1</sup></a><a href="/tags/macOS/" style="font-size: 0.88rem;">macOS<sup>2</sup></a><a href="/tags/web/" style="font-size: 0.88rem;">web<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 0.88rem;">分布式<sup>1</sup></a><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" style="font-size: 0.88rem;">分布式锁<sup>1</sup></a><a href="/tags/%E5%90%8E%E7%AB%AF/" style="font-size: 0.88rem;">后端<sup>1</sup></a><a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 0.88rem;">多线程<sup>1</sup></a><a href="/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 0.88rem;">测试<sup>1</sup></a><a href="/tags/%E7%BC%93%E5%AD%98/" style="font-size: 0.88rem;">缓存<sup>1</sup></a><a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 0.88rem;">网络<sup>1</sup></a><a href="/tags/%E8%B8%A9%E9%9B%B7/" style="font-size: 0.88rem;">踩雷<sup>1</sup></a></div></div><hr/></div></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="anzhiyufont anzhiyu-icon-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="anzhiyufont anzhiyu-icon-arrows-left-right"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="anzhiyufont anzhiyu-icon-gear"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="anzhiyufont anzhiyu-icon-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="anzhiyufont anzhiyu-icon-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></button></div></div><div id="nav-music"><a id="nav-music-hoverTips" onclick="anzhiyu.musicToggle()" accesskey="m">播放音乐</a><div id="console-music-bg"></div><meting-js id="447363601" server="netease" type="playlist" mutex="true" preload="none" theme="var(--anzhiyu-main)" data-lrctype="0" order="random" volume="0.7"></meting-js></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="anzhiyufont anzhiyu-icon-xmark"></i></button></nav><div class="is-center" id="loading-database"><i class="anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div id="rightMenu"><div class="rightMenu-group rightMenu-small"><div class="rightMenu-item" id="menu-backward"><i class="anzhiyufont anzhiyu-icon-arrow-left"></i></div><div class="rightMenu-item" id="menu-forward"><i class="anzhiyufont anzhiyu-icon-arrow-right"></i></div><div class="rightMenu-item" id="menu-refresh"><i class="anzhiyufont anzhiyu-icon-arrow-rotate-right" style="font-size: 1rem;"></i></div><div class="rightMenu-item" id="menu-top"><i class="anzhiyufont anzhiyu-icon-arrow-up"></i></div></div><div class="rightMenu-group rightMenu-line rightMenuPlugin"><div class="rightMenu-item" id="menu-copytext"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制选中文本</span></div><div class="rightMenu-item" id="menu-pastetext"><i class="anzhiyufont anzhiyu-icon-paste"></i><span>粘贴文本</span></div><a class="rightMenu-item" id="menu-commenttext"><i class="anzhiyufont anzhiyu-icon-comment-medical"></i><span>引用到评论</span></a><div class="rightMenu-item" id="menu-newwindow"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开</span></div><div class="rightMenu-item" id="menu-copylink"><i class="anzhiyufont anzhiyu-icon-link"></i><span>复制链接地址</span></div><div class="rightMenu-item" id="menu-copyimg"><i class="anzhiyufont anzhiyu-icon-images"></i><span>复制此图片</span></div><div class="rightMenu-item" id="menu-downloadimg"><i class="anzhiyufont anzhiyu-icon-download"></i><span>下载此图片</span></div><div class="rightMenu-item" id="menu-newwindowimg"><i class="anzhiyufont anzhiyu-icon-window-restore"></i><span>新窗口打开图片</span></div><div class="rightMenu-item" id="menu-search"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>站内搜索</span></div><div class="rightMenu-item" id="menu-searchBaidu"><i class="anzhiyufont anzhiyu-icon-magnifying-glass"></i><span>百度搜索</span></div><div class="rightMenu-item" id="menu-music-toggle"><i class="anzhiyufont anzhiyu-icon-play"></i><span>播放音乐</span></div><div class="rightMenu-item" id="menu-music-back"><i class="anzhiyufont anzhiyu-icon-backward"></i><span>切换到上一首</span></div><div class="rightMenu-item" id="menu-music-forward"><i class="anzhiyufont anzhiyu-icon-forward"></i><span>切换到下一首</span></div><div class="rightMenu-item" id="menu-music-playlist" onclick="window.open(&quot;https://music.163.com/#/playlist?id=447363601&amp;userid=321481294&quot;, &quot;_blank&quot;);" style="display: none;"><i class="anzhiyufont anzhiyu-icon-radio"></i><span>查看所有歌曲</span></div><div class="rightMenu-item" id="menu-music-copyMusicName"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制歌名</span></div></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item menu-link" id="menu-randomPost"><i class="anzhiyufont anzhiyu-icon-shuffle"></i><span>随便逛逛</span></a><a class="rightMenu-item menu-link" href="/categories/"><i class="anzhiyufont anzhiyu-icon-cube"></i><span>博客分类</span></a><a class="rightMenu-item menu-link" href="/tags/"><i class="anzhiyufont anzhiyu-icon-tags"></i><span>文章标签</span></a></div><div class="rightMenu-group rightMenu-line rightMenuOther"><a class="rightMenu-item" id="menu-copy" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-copy"></i><span>复制地址</span></a><a class="rightMenu-item" id="menu-commentBarrage" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-message"></i><span class="menu-commentBarrage-text">关闭热评</span></a><a class="rightMenu-item" id="menu-darkmode" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-circle-half-stroke"></i><span class="menu-darkmode-text">深色模式</span></a><a class="rightMenu-item" id="menu-translate" href="javascript:void(0);"><i class="anzhiyufont anzhiyu-icon-language"></i><span>轉為繁體</span></a></div></div><div id="rightmenu-mask"></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.cbd.int/@fancyapps/ui@5.0.28/dist/fancybox/fancybox.umd.js"></script><script src="https://cdn.cbd.int/instant.page@5.2.0/instantpage.js" type="module"></script><script src="https://cdn.cbd.int/node-snackbar@0.1.16/dist/snackbar.min.js"></script><canvas id="universe"></canvas><script async src="https://npm.elemecdn.com/anzhiyu-theme-static@1.0.0/dark/dark.js"></script><script>// 消除控制台打印
var HoldLog = console.log;
console.log = function () {};
let now1 = new Date();
queueMicrotask(() => {
  const Log = function () {
    HoldLog.apply(console, arguments);
  }; //在恢复前输出日志
  const grt = new Date("04/01/2021 00:00:00"); //此处修改你的建站时间或者网站上线时间
  now1.setTime(now1.getTime() + 250);
  const days = (now1 - grt) / 1000 / 60 / 60 / 24;
  const dnum = Math.floor(days);
  const ascll = [
    `欢迎使用安知鱼!`,
    `生活明朗, 万物可爱`,
    `
        
       █████╗ ███╗   ██╗███████╗██╗  ██╗██╗██╗   ██╗██╗   ██╗
      ██╔══██╗████╗  ██║╚══███╔╝██║  ██║██║╚██╗ ██╔╝██║   ██║
      ███████║██╔██╗ ██║  ███╔╝ ███████║██║ ╚████╔╝ ██║   ██║
      ██╔══██║██║╚██╗██║ ███╔╝  ██╔══██║██║  ╚██╔╝  ██║   ██║
      ██║  ██║██║ ╚████║███████╗██║  ██║██║   ██║   ╚██████╔╝
      ╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝╚═╝  ╚═╝╚═╝   ╚═╝    ╚═════╝
        
        `,
    "已上线",
    dnum,
    "天",
    "©2021 By 安知鱼 V1.6.14",
  ];
  const ascll2 = [`NCC2-036`, `调用前置摄像头拍照成功，识别为【小笨蛋】.`, `Photo captured: `, `🤪`];

  setTimeout(
    Log.bind(
      console,
      `\n%c${ascll[0]} %c ${ascll[1]} %c ${ascll[2]} %c${ascll[3]}%c ${ascll[4]}%c ${ascll[5]}\n\n%c ${ascll[6]}\n`,
      "color:#425AEF",
      "",
      "color:#425AEF",
      "color:#425AEF",
      "",
      "color:#425AEF",
      ""
    )
  );
  setTimeout(
    Log.bind(
      console,
      `%c ${ascll2[0]} %c ${ascll2[1]} %c \n${ascll2[2]} %c\n${ascll2[3]}\n`,
      "color:white; background-color:#4fd953",
      "",
      "",
      'background:url("https://npm.elemecdn.com/anzhiyu-blog@1.1.6/img/post/common/tinggge.gif") no-repeat;font-size:450%'
    )
  );

  setTimeout(Log.bind(console, "%c WELCOME %c 你好，小笨蛋.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(
      console,
      "%c ⚡ Powered by 安知鱼 %c 你正在访问 SoniaChen 的博客.",
      "color:white; background-color:#f0ad4e",
      ""
    )
  );

  setTimeout(Log.bind(console, "%c W23-12 %c 你已打开控制台.", "color:white; background-color:#4f90d9", ""));

  setTimeout(
    console.warn.bind(console, "%c S013-782 %c 你现在正处于监控中.", "color:white; background-color:#d9534f", "")
  );
});</script><script async src="/anzhiyu/random.js"></script><script async="async">(function () {
  var grt = new Date("04/01/2021 00:00:00"); //设置网站上线时间
  var now = new Date();
  var dnum;
  var hnum;
  var mnum;
  var snum;
  var nowHour;

  // 计算并更新天数、小时数、分钟数和秒数
  function updateTime() {
    now = new Date(); // 更新 now 的值
    nowHour = now.getHours(); // 更新 nowHour 的值
    var days = (now - grt) / 1000 / 60 / 60 / 24;
    dnum = Math.floor(days);
    var hours = (now - grt) / 1000 / 60 / 60 - 24 * dnum;
    hnum = Math.floor(hours);
    if (String(hnum).length == 1) {
      hnum = "0" + hnum;
    }
    var minutes = (now - grt) / 1000 / 60 - 24 * 60 * dnum - 60 * hnum;
    mnum = Math.floor(minutes);
    if (String(mnum).length == 1) {
      mnum = "0" + mnum;
    }
    var seconds = (now - grt) / 1000 - 24 * 60 * 60 * dnum - 60 * 60 * hnum - 60 * mnum;
    snum = Math.round(seconds);
    if (String(snum).length == 1) {
      snum = "0" + snum;
    }
  }

  // 更新网页中显示的网站运行时间
  function updateHtml() {
    const footer = document.getElementById("footer");
    if (!footer) return
    let currentTimeHtml = "";
    if (nowHour < 18 && nowHour >= 9) {
      // 如果是上班时间，默认就是"安知鱼-上班摸鱼中.svg"图片，不需要更改
      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    } else {
      // 如果是下班时间，插入"安知鱼-下班啦.svg"图片
      let img = document.querySelector("#workboard .workSituationImg");
      if (img != null) {
        img.src = "";
        img.title = "";
        img.alt = "";
      }

      currentTimeHtml = `本站居然运行了 ${dnum} 天<span id='runtime'> ${hnum} 小时 ${mnum} 分 ${snum} 秒 </span><i class='anzhiyufont anzhiyu-icon-heartbeat' style='color:red'></i>`;
    }

    if (document.getElementById("runtimeTextTip")) {
      document.getElementById("runtimeTextTip").innerHTML = currentTimeHtml;
    }
  }

  setInterval(() => {
    updateTime();
    updateHtml();
  }, 1000);
})();</script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>(() => {
  const init = () => {
    twikoo.init(Object.assign({
      el: '#twikoo-wrap',
      envId: 'https://twikoo-cloudflare.soniachan0831.workers.dev',
      region: '',
      onCommentLoaded: () => {
        anzhiyu.loadLightbox(document.querySelectorAll('#twikoo .tk-content img:not(.tk-owo-emotion)'))
      }
    }, null))
  }

  const loadTwikoo = () => {
    if (typeof twikoo === 'object') setTimeout(runFn,0)
    else getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runFn)
  }

  const getCount = () => {
    const countELement = document.getElementById('twikoo-count')
    if(!countELement) return
    twikoo.getCommentsCount({
      envId: 'https://twikoo-cloudflare.soniachan0831.workers.dev',
      region: '',
      urls: [window.location.pathname],
      includeReply: false
    }).then(res => {
      countELement.textContent = res[0].count
    }).catch(err => {
      console.error(err)
    })
  }

  const runFn = () => {
    init();
    GLOBAL_CONFIG_SITE.isPost && getCount()
  }

  if ('Twikoo' === 'Twikoo' || !false) {
    if (false) anzhiyu.loadComment(document.getElementById('twikoo-wrap'), loadTwikoo)
    else {
      loadTwikoo()
    }
  } else {
    window.loadOtherComment = loadTwikoo
  }
})()</script><input type="hidden" name="page-type" id="page-type" value="post"></div><script>window.addEventListener('load', () => {
  const changeContent = (content) => {
    if (content === '') return content

    content = content.replace(/<img.*?src="(.*?)"?[^\>]+>/ig, '[图片]') // replace image link
    content = content.replace(/<a[^>]+?href=["']?([^"']+)["']?[^>]*>([^<]+)<\/a>/gi, '[链接]') // replace url
    content = content.replace(/<pre><code>.*?<\/pre>/gi, '[代码]') // replace code
    content = content.replace(/<[^>]+>/g,"") // remove html tag

    if (content.length > 150) {
      content = content.substring(0,150) + '...'
    }
    return content
  }

  const getComment = () => {
    const runTwikoo = () => {
      twikoo.getRecentComments({
        envId: 'https://twikoo-cloudflare.soniachan0831.workers.dev',
        region: '',
        pageSize: 6,
        includeReply: true
      }).then(function (res) {
        const twikooArray = res.map(e => {
          return {
            'content': changeContent(e.comment),
            'avatar': e.avatar,
            'nick': e.nick,
            'url': e.url + '#' + e.id,
            'date': new Date(e.created).toISOString()
          }
        })

        saveToLocal.set('twikoo-newest-comments', JSON.stringify(twikooArray), 10/(60*24))
        generateHtml(twikooArray)
      }).catch(function (err) {
        const $dom = document.querySelector('#card-newest-comments .aside-list')
        $dom.textContent= "无法获取评论，请确认相关配置是否正确"
      })
    }

    if (typeof twikoo === 'object') {
      runTwikoo()
    } else {
      getScript('https://cdn.cbd.int/twikoo@1.6.39/dist/twikoo.all.min.js').then(runTwikoo)
    }
  }

  const generateHtml = array => {
    let result = ''

    if (array.length) {
      for (let i = 0; i < array.length; i++) {
        result += '<div class=\'aside-list-item\'>'

        if (true) {
          const name = 'src'
          result += `<a href='${array[i].url}' class='thumbnail'><img ${name}='${array[i].avatar}' alt='${array[i].nick}'><div class='name'><span>${array[i].nick} </span></div></a>`
        }
        
        result += `<div class='content'>
        <a class='comment' href='${array[i].url}' title='${array[i].content}'>${array[i].content}</a>
        <time datetime="${array[i].date}">${anzhiyu.diffDate(array[i].date, true)}</time></div>
        </div>`
      }
    } else {
      result += '没有评论'
    }

    let $dom = document.querySelector('#card-newest-comments .aside-list')
    $dom && ($dom.innerHTML= result)
    window.lazyLoadInstance && window.lazyLoadInstance.update()
    window.pjax && window.pjax.refresh($dom)
  }

  const newestCommentInit = () => {
    if (document.querySelector('#card-newest-comments .aside-list')) {
      const data = saveToLocal.get('twikoo-newest-comments')
      if (data) {
        generateHtml(JSON.parse(data))
      } else {
        getComment()
      }
    }
  }

  newestCommentInit()
  document.addEventListener('pjax:complete', newestCommentInit)
})</script><script>var visitorMail = "visitor@soniachen.com";
</script><script async data-pjax src="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/waterfall/waterfall.js"></script><script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/qrcodejs/1.0.0/qrcode.min.js"></script><script src="/js/anzhiyu/right_click_menu.js"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.1.9/icon/ali_iconfont_css.css"><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script id="click-show-text" src="https://cdn.cbd.int/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="Don't,Click,Me" data-fontsize="15px" data-random="false" async="async"></script><link rel="stylesheet" href="https://cdn.cbd.int/anzhiyu-theme-static@1.0.0/aplayer/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.cbd.int/anzhiyu-blog-static@1.0.1/js/APlayer.min.js"></script><script src="https://cdn.cbd.int/hexo-anzhiyu-music@1.0.1/assets/js/Meting2.min.js"></script><script src="https://cdn.cbd.int/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["meta[property=\"og:image\"]","meta[property=\"og:title\"]","meta[property=\"og:url\"]","meta[property=\"og:type\"]","meta[property=\"og:site_name\"]","meta[property=\"og:description\"]","head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]
var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {
  // removeEventListener scroll 
  anzhiyu.removeGlobalFnEvent('pjax')
  anzhiyu.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script charset="UTF-8" src="https://cdn.cbd.int/anzhiyu-theme-static@1.1.5/accesskey/accesskey.js"></script></div><div id="popup-window"><div class="popup-window-title">通知</div><div class="popup-window-divider"></div><div class="popup-window-content"><div class="popup-tip">你好呀</div><div class="popup-link"><i class="anzhiyufont anzhiyu-icon-arrow-circle-right"></i></div></div></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"log":false});</script></body></html>